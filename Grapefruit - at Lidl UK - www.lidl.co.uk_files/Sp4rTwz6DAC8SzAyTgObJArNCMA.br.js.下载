(function(){var ii,tt;try{(function(){var n={L_CreateNewCollection:"新建集合...",L_TemporaryCollectionTitle:"临时集合",L_AddFavorite:"最喜爱的地点",L_SetAsHome:"家庭地址",L_SetAsWork:"工作地址",L_MoveToFavorites:"收藏夹",L_MoveToHome:"家庭地址",L_MoveToWork:"工作地址",L_MoveToNewDay:"创建新的一天",L_MoveToDay:"第 {0} 天",L_SaveToItinerary:"{0}",L_DirectionAction_Text:"单击地图右侧的“地图层”按钮。",L_DirectionHdg_Text:"预览路线中的转弯",L_Direction_Text:"在路线上看到转弯标识后方可离开。请单击每个转弯处下方的白圈。",L_SignInLink_Text:"登录",L_Dlg_Close:"关闭",L_Add_To_Current_Route:"添加到此路线",L_Directions_From:"从此处出发的路线",L_Directions_To:"去往此处的路线",L_Directions_AddToRoute:"添加到路线",L_Landmark_TaskBar_Aria_Label:"搜索，获取路线，设置收藏夹",L_Landmark_CategoriesBar_Aria_Label:"类别栏",L_Landmark_PreviewBar_Aria_Label:"必应地图预览、退出、反馈和提示",L_Home:"家",L_Work:"工作地点",L_MyLocation:"我的位置",L_SignInRequired:"<link>登录<\/link>以将此地点添加至收藏夹。",L_SavedCollection:"已成功添加 {0}。",L_SaveFailed:"将 {1} 添加至 {0} 时出现问题。请重试。",L_SeeIt:"在 <link>{0}<\/link> 中查看",L_AddFavoriteFailed:"将此地点保存至收藏夹时出现问题。请重试。",L_AddFavoriteSucceeded:"{0} 现已保存。",L_AddTemporaryCollectionTitle:"你的临时集合",L_SetHomeFailed:"将此地点保存为您的家庭位置时出现问题。请重试。",L_SetHomeSucceeded:"此地点现已保存为您的家庭位置。",L_SetWorkFailed:"将此地点保存为您的工作地点时出现问题。请重试。",L_SetWorkSucceeded:"此地点现已保存为您的工作地点。",L_EntityUpdateSucceeded:"此位置已更新。",L_SaveUpdateButton:"保存",L_UpdateNicknameMessage:"添加昵称(可选)",L_Menu_Text:"菜单",L_CategoriesBar_Header_Text:"路线沿线:",L_FiltersBar_Less_Text:"更少",L_FiltersBar_More_Text:"更多",L_Landmark_FiltersBar_Aria_Label:"筛选栏",L_EditFavorite_Text:"编辑",L_Favorite_Text:"收藏夹",L_EditMapDone_Text:"完成",L_EditMap_Text:"移动或缩放地图",L_AddFavoriteExists_Text:"你想保存的位置在收藏夹中已存在。",L_AddTemporaryExists:"你想要保存的位置已存在于你的临时集合中。",L_CalendarSync_Export:"保存",L_CalendarSync_Google:"Google 日历",L_CalendarSync_Outlook:"Outlook 日历",L_CalendarSync_Message:"已保存到 {0}",L_CalendarSync_EventMessage_HTML:"<STRONG>{0}<\/STRONG><BR>...由<STRONG>必应地图<\/STRONG>提供技术支持<BR><BR>在必应地图上查看:<BR> ",L_CalendarSync_EventMessage:"{0}\\n...由必应地图提供技术支持\\n\\n在必应地图上查看: ",L_CalendarSync_EventMessage_PlainText:"{0}\r\n...由必应地图提供技术支持\r\n\r\n在必应地图上查看:",L_CalendarSync_OpenHouse_EventMessage_HTML:"<STRONG>参加“开放参观日”活动 - {0}<\/STRONG><BR>单击该链接以在必应地图中获取路线:<BR> ",L_CalendarSync_OpenHouse_EventMessage:"参加“开放参观日”活动 - {0}\\n\\n单击该链接以在必应地图中获取路线:",L_CalendarSync_OpenHouse_EventMessage_PlainText:"参加“开放参观日”活动 - {0}",L_CalendarSync_OpenHouse_Subject:"“开放参观日”活动",L_CalendarSync_OutlookDesktop:"下载日历项",L_CalendarSync_EndTimeLink:"添加结束时间",L_CalendarSync_StartTime:"开始时间:",L_CalendarSync_EndTime:"结束时间:",L_CalendarSync_SelectDateTime:"选择日期和时间",L_CalendarSync_APIErrorMessage:"抱歉，访问日历时出错。请注销，然后重试。",L_CalendarSync_StartEndDateError:"结束日期/时间必须晚于开始日期/时间。",L_CalendarSync_LoginErrorMessage:"抱歉，登录出错，请重试。(你也可以尝试清除缓存，或使用其他浏览器。)",L_CalendarSync_ICS_Downloaded:"已下载日历事件文件，打开可添加到你的日历中。",L_CalendarSync_TimeZoneDisclaimer:"所有时间均以活动的当地时区显示。",L_CalendarSync_AllDayEvent:"全天事件",L_AdSlug:"广告",L_AdRating:"{0} 的评分为 {1} ({3})",L_AdReviewCount:"{0} 条评论",L_AdRatingTooltip:"评分为 {0}，总分为 5。",L_AdAbout:"关于我们的广告",L_Nearby_Attractions:"景点",L_Nearby_Bars:"酒吧",L_Nearby_Coffee:"咖啡馆",L_Nearby_Hotels:"酒店",L_Nearby_Restaurants:"餐馆",L_Nearby_Transit:"公交站",L_TooManyFavorites:"已达到最大收藏数量。要收藏此位置，请删除现有收藏并重试。",L_EntityPreviouslySaved:"{0} 之前已添加到你的收藏。",L_DirectionsPopOutAriaLabel:"路线下拉菜单",L_CollectionsPopOutAriaLabel:"收藏下拉菜单",L_TravelPopOutAriaLabel:"行程下拉菜单",L_AlongTheRouteText:"沿线 {0} ",L_DropdownMenuDescription:"下拉菜单",L_ShortMonthJanuary:"1 月",L_ShortMonthFebruary:"2 月",L_ShortMonthMarch:"3 月",L_ShortMonthApril:"4 月",L_ShortMonthMay:"5 月",L_ShortMonthJune:"6 月",L_ShortMonthJuly:"7 月",L_ShortMonthAugust:"8 月",L_ShortMonthSeptember:"9 月",L_ShortMonthOctober:"10 月",L_ShortMonthNovember:"11 月",L_ShortMonthDecember:"12 月",L_CreateNewItinerary:"新建行程...",L_SatrGhostTextFormat:"沿路线搜索",L_Directions_Categories_Bar_Entity_Coffee:"咖啡馆",L_Directions_Categories_Bar_Entity_GasStations:"加油站",L_Directions_Categories_Bar_Entity_GroceryStores:"食品杂货店",L_Directions_Categories_Bar_Entity_Hotels:"酒店",L_Directions_Categories_Bar_Entity_Restaurants:"餐馆",L_Directions_Categories_Bar_Entity_Attractions:"景点",L_Directions_Categories_Bar_Entity_Costco:"好市多",L_Directions_Categories_Bar_Entity_Pharmacies:"药店",L_Directions_Categories_Bar_Entity_Starbucks:"星巴克",L_Directions_Categories_Bar_Entity_Walmart:"沃尔玛",L_Directions_Categories_Bar_Entity_FastFood:"快餐",CategoriesBar_NewHeader_Text:"沿路线搜索",InPrivateAutosuggestFooterText:"你的搜索记录和站点 Cookie 未保存。",InPrivateAutosuggestFooterLink:"了解有关 InPrivate 搜索的详细信息",SearchGhostText:"使用必应地图搜索",L_PhoneWatermark:"(000) 000-0000"};window.$MicrosoftMaps8.ResourceManager?window.$MicrosoftMaps8.ResourceManager.init("CommonControls",n):window.$MicrosoftMaps8.ResourcesObject=n})();var t=window.$MicrosoftMaps8,o=t.Internal,ei=o.TaskData,ge=t.Local=t.Local||{},yt=t.CloudGraphDataManager=t.CloudGraphDataManager||{},pt=t.GlobalConfig.features.advertising,no=t.Anchor,e=t.GlobalConfig.features.autosuggest,it=o._BaseMapTemplateSelector,pr=o.BaseTask,wt=o.BaseTaskViewModel,to=t.BitmapImageTemplate,v=ei.CollectionActions,bt=t.GlobalConfig.features.collections,kt=o._ComponentNames,nt=t.GlobalConfig.features.calendar,wr=t.GlobalConfig.features.calendarSync,io=o.CanvasDrawingContext,br=o._Color,dt=o.Control,g=o.ControlTemplate,u=t.DataHandlerKeys,yi=o._Debug,ro=t.DefaultTemplateSelector,oi=t.GlobalConfig.features.directions,gt=ei.DirectionsMode,ht=o._EntityHelper,y=o._EntryPoints,uo=o._FeatureNames,fo=o.GeolocationProvider,r=o._Gimme,h=t.GlobalConfig,f=t.GlobalDataEventHandler,a=o._Helper,eo=t.ImageFromCssHelper,kr=t.Infobox,oo=yt.Itinerary,so=yt.ItineraryConverter,ho=yt.ItineraryDataManager,co=yt.ItineraryItem,w=o._JSEvent,si=h.features.localSearch,pi=o.LocalSearchEntity,ct=o._LocalStorageCache,d=o._LoggerConstants,dr=o._LruCache,lt=h.features.mapDelay,p=t.ResourceManager.MapDelay,lo=o.MapInteractionBehavior,ni=o.MapHelper,at=t.Location,rt=t.MapTypeId,gr=t.MapView,nu=t.MapViewAnimator,c=t.MapQuadrant,ao=yt.MostRecentlyUsedList,vo=t.MoveableSimplePointPrimitive,ft=o._Network,ot=o._ObservableObject,tu=o._ObservableCollection,nr=o._OverlayEntity,yo=o._Overlay,iu=t.Point,po=o.Permalink,ti=t.PrimitiveOverlayHelper,wo=t.GlobalConfig.features.print,bo=o.PrintContent,ru=ei.RecommendationEntity,i=t.ResourceManager.CommonControls,ko=o.ReverseGeocoder,hi=t.SimplePointPrimitive,go=t.GlobalConfig.features.sharing,uu=o._StreetsidePerfConstants,ci=t.GlobalConfig.features.streetside,fu=t.GlobalConfig.features.taskBar,b=t.GlobalConfig.features.travel,k=o._TaskDataHandlerHelper,l=t.TaskTypes,eu=t.VectorMapLayer,ns=t.VectorImageTemplate,ou=t.ZoomLevel,su=o._MapAuthentication,ts=ei.TravelAttractionEntity,hu='<div class="bm_dropdownContainer">    <a class="{TemplateBinding DisplayDropdown Converter=dropdownOpenClass}" data-tag="dropdownButton" event:click="onDropdownButtonClick" event:mouseleave="mouseexitDropdown" event:mouseenter="mouseoverDropdown" role="button" aria-expanded="{TemplateBinding DisplayDropdown}" href="#">        <span class="{TemplateBinding ButtonIcon}"><\/span>        <span>            <TextBlock Text="{TemplateBinding ButtonName}" />        <\/span>        <span class="chevron"><\/span>    <\/a>    <div class="dropdownParent">        <div class="multiselectDropdown popOutTop" style:display="{TemplateBinding DisplayDropdown Converter=boolToDisplay}" event:mouseleave="mouseexitDropdown" event:mouseenter="mouseoverDropdown">            <div class="dropdownTitle" style:display="{TemplateBinding DropdownTitle Converter=boolToDisplay}">                <TextBlock Text="{TemplateBinding DropdownTitle}" />            <\/div>            <ItemsControl ItemsSource="{TemplateBinding ItemList}">                <ItemsControl.ItemTemplate>                    <DataTemplate>                        <div>                            <a class="multiselectItem" data-tag="multiselectItem" data-entityid="{Binding Name}" event:click="onItemClick" role="checkbox" aria-checked="{Binding Checked}" href="#">                                <span class="{Binding Checked Converter=itemCheckedClass}"><\/span>                                <span class="{Binding Icon}"><\/span>                                <span class="itemName">                                    <TextBlock Text="{Binding Name}" />                                <\/span>                            <\/a>                        <\/div>                    <\/DataTemplate>                <\/ItemsControl.ItemTemplate>            <\/ItemsControl>        <\/div>    <\/div><\/div>',cu='<div class="{Binding cssClass}" id="{Binding id}" style:visibility="{Binding showSuggestionsPanel Converter=boolToVisibility}" style:width="{Binding width Converter=numberToPixelString}" data-tag="as_container" aria-owns="{Binding ariaOwns}">    <div class="b_cards asOuterContainer">        <div style:display="{Binding showNearBySearchText Converter=boolToDisplay}" >            <p class="nearBySearchText b_secondaryText">                <TextBlock text="{Binding nearBySearchText}" />            <\/p>        <\/div>        <ItemsControl ItemsSource="{Binding suggestions}" panelTagName="ul" role="listbox">            <ItemsControl.ItemTemplate>                <DataTemplate>\t                        <li data-q="{Binding searchText}" id="{Binding optionId}" event:mousedown="handleSuggestionClick" role="option" aria-selected="{Binding isSelected}">                                                   <a class="{Binding isSelected Converter=boolToSelectedClassName}" data-tag="as_suggestion">                                <div class="as_suggestion_root_inside" data-tag="as_suggestion_root_inside">                                    <div class="{Binding suggestionImgClass}" data-tag="as_img">                                    <\/div>                                                                    <div class="as_lines_root" data-tag="as_lines_root">                                        <p class="line1" data-tag="as_suggestion_line">                                            <TextBlock Text="{Binding suggestionTextLine1}" />                                        <\/p>                                        <p class="line2" data-tag="as_suggestion_line">                                            <TextBlock Text="{Binding suggestionTextLine2}" />                                        <\/p>                                    <\/div>                               <\/div>                            <\/a>                        <\/li>                <\/DataTemplate>            <\/ItemsControl.ItemTemplate>        <\/ItemsControl>        <li class="as_bpr" role="option" style:display="{Binding showInPrivateLink Converter=boolToDisplay}">            <div class="as_bprtxt">                <div class="as_bprtxt_line1">                    <TextBlock Text="{Binding inPrivateText}" />                <\/div>                <a class="as_bprlink" data-tag="as_bprlink" href="#" event:mousedown="inPrivateLinkClick">                    <TextBlock Text="{Binding inPrivateLinkText}" />                <\/a>            <\/div>        <\/li>        <div style:display="{Binding showBingLogo Converter=boolToDisplay}" class="bingLogoContainer">            <span class="bingLogoLight"><\/span>        <\/div>    <\/div>    <div class="clear"><\/div> <\/div>>',tr='<div class="CalendarSync calendarIcon">\t<div class="calendarSelect" data-tag="calendarSyncSelect">\t\t<SelectControl ItemsSource="{Binding calendarTypes}" IgnorePopOutButtonText="{Binding hasPresetStartEndTime}" SelectedItem="{Binding calendarType Mode=TwoWay}" event:dropdown="onDropdown" />\t<\/div>    <div style:display="{Binding showStartEndTimeLinks Converter=boolToDisplay}">        <div id="startCalendar">            <div>                <span class="startTimeLabel">                    <TextBlock Text="{Binding resources.L_CalendarSync_StartTime Converter=addPrefixSpace}" />                <\/span>                <span class="startDateAndTime" >                    <a class="dateTimeSelector dropdownBtn" event:click="onStartTimeClick" href="#" role="button" aria-expanded="{Binding showStartCalendarSelector}">                        <TextBlock Text="{Binding startDateTime}" />                    <\/a>                <\/span>            <\/div>            <div style:display="{Binding showStartCalendarSelector Converter=boolToDisplay}">                <div class="calendarSyncStartDate" data-tag="calendarSyncDate"><\/div>                <div class="calendarTime">                    <TimeControl Time="{Binding startTime Mode=TwoWay}" Editing="{Binding startEditingTime Mode=TwoWay}" Disabled="{Binding timeControlDisabled}" taskId="{Binding startTaskId}" />                    <div class="allDayEventCheckbox">                        <CheckBox Checked="{Binding isAllDayEvent Mode=TwoWay}" Value="{Binding resources.L_CalendarSync_AllDayEvent}" Content="{Binding resources.L_CalendarSync_AllDayEvent}" />                    <\/div>                <\/div>            <\/div>        <\/div>        <div class="endTimeLink" style:display="{Binding showEndTimeLink Converter=boolToDisplay}">            <a event:click="onEndTimeLinkClick" href="#"><TextBlock Text="{Binding resources.L_CalendarSync_EndTimeLink}" /><\/a>        <\/div>        <div class="endCalendar" style:display="{Binding showEndCalendar Converter=boolToDisplay}">            <div>                <span class="endTimeLabel">                    <TextBlock Text="{Binding resources.L_CalendarSync_EndTime Converter=addPrefixSpace}" />                <\/span>                <span class="endDateAndTime">                    <a class="dateTimeSelector dropdownBtn" event:click="onEndTimeClick" href="#">                        <TextBlock Text="{Binding endDateTime}" />                    <\/a>                <\/span>            <\/div>            <div style:display="{Binding showEndCalendarSelector Converter=boolToDisplay}">                <div class="calendarSyncEndDate" data-tag="calendarSyncDate"><\/div>                <div class="calendarTime">                    <TimeControl Time="{Binding endTime Mode=TwoWay}" Editing="{Binding endEditingTime Mode=TwoWay}" Disabled="{Binding timeControlDisabled}" taskId="{Binding startTaskId}" />                    <div class="allDayEventCheckbox">                        <CheckBox Checked="{Binding isAllDayEvent Mode=TwoWay}" Value="{Binding resources.L_CalendarSync_AllDayEvent}" Content="{Binding resources.L_CalendarSync_AllDayEvent}" />                    <\/div>                <\/div>            <\/div>        <\/div>        <div class="calendarSyncExportButton">            <a title="{Binding resources.L_CalendarSync_Export}" event:click="onExportClick" href="#" role="button" data-tag="calendarSyncExportButton">                <span class="cbtn b_highlighted">                    <input type="submit" value="{Binding resources.L_CalendarSync_Export}" />                <\/span>            <\/a>        <\/div>        <div class="calendarSyncTimeZoneDisclaimer" style:display="{Binding showTimeZoneDisclaimer Converter=boolToDisplay}">            <TextBlock Text="{Binding resources.L_CalendarSync_TimeZoneDisclaimer}" />        <\/div>    <\/div><\/div>',ir='<div class="bm_categoriesBar" data-tag="categoriesBar" role="search" aria-label="{Binding resources.L_Landmark_CategoriesBar_Aria_Label}" style:display="{Binding isVisible Converter=boolToDisplay}">    <div class="categoriesBarHeader"><TextBlock text="{Binding isNewCard Converter=getCategoryTitle}" /><\/div>    <ItemsControl ItemsSource="{Binding categoriesBarItems}">        <ItemsControl.Template>            <DataTemplate>                <ul class="categories"><ItemsPresenter /><\/ul>            <\/DataTemplate>        <\/ItemsControl.Template>        <ItemsControl.ItemTemplate>            <DataTemplate>                <li class="category" data-tag="category">                    <a href="#" class="{Binding cssClass}" data-instrumentation="{Binding instrumentationData}" data-category="{Binding itemData.categoryId}" event:mouseover="onMouseOverHandler" event:mouseleave="onMouseLeaveHandler" event:click="clickHandler" role="button" aria-label="{Binding itemData.titleString}">                        <div class="bm_itemImage hidden"><\/div>                        <div class="bm_categoryText">                            <TextBlock text="{Binding itemData.displayName}" />                        <\/div>                    <\/a>                <\/li>            <\/DataTemplate>        <\/ItemsControl.ItemTemplate>    <\/ItemsControl><\/div>',lu='<div class="dropdownTitleSelection">    <Dropdown ItemsSource="{Binding dropdownList}" event:onEntryClicked="onEntryClicked" Class="{Binding dropdownClass}">        <Dropdown.ItemTemplate>            <DataTemplate>                <div class="{Binding cssClass}">                    <CheckBox Content="{Binding name}" Checked="{Binding isSelected}" Value="" onClick="return false;" />                <\/div>            <\/DataTemplate>        <\/Dropdown.ItemTemplate>    <\/Dropdown><\/div>',au='<div class="bm_filtersBar" data-tag="filtersBar" role="search" aria-label="{Binding resources.L_Landmark_FiltersBar_Aria_Label}">    <ItemsControl ItemsSource="{Binding _filtersViewModels}">        <ItemsControl.Template>            <DataTemplate>                <ul class="filters"><ItemsPresenter /><\/ul>            <\/DataTemplate>        <\/ItemsControl.Template>        <ItemsControl.ItemTemplate>            <DataTemplate>                <li class="filter" data-tag="filter">                    <a href="#" class="{Binding filterItem.cssClass}" data-instrumentation="{Binding filterItem.instrumentationData}" event:click="clickHandler" role="button"><TextBlock text="{Binding filterItem.displayName}" /><\/a>                    <div class="{Binding filterItem.cssClass}"><div class="routesPopOut"><\/div><\/div>                <\/li>            <\/DataTemplate>        <\/ItemsControl.ItemTemplate>    <\/ItemsControl>    <a href="#" class="expandFiltersButton" role="button"><\/a><\/div>',vu='<div class="bm_filtersStatusBar" data-tag="filtersStatusBar" aria-label="{Binding resources.L_Landmark_FiltersBar_Aria_Label}" style:display="{Binding isVisible Converter=boolToDisplay}">    <ItemsControl ItemsSource="{Binding selectedItems}">        <ItemsControl.Template>            <DataTemplate>                <ul class="filtersStatus"><ItemsPresenter /><\/ul>            <\/DataTemplate>        <\/ItemsControl.Template>        <ItemsControl.ItemTemplate>            <DataTemplate>                <li class="{Binding cssClass}" data-tag="filterStatus">                    <div><TextBlock Text="{Binding id Converter=itemToString}" /><\/div>                    <a href="#" class="{Binding id}" data-instrumentation="{Binding instrumentationData}" event:click="onDiscardFilterItemSelection" role="button"><\/a>                <\/li>            <\/DataTemplate>        <\/ItemsControl.ItemTemplate>    <\/ItemsControl><\/div>',wi='<div class="dropdownTitleList">    <a class="dropdownFocusDummy" tabindex="-1" title="{Binding resources.L_DropdownMenuDescription}"><\/a>    <Dropdown ItemsSource="{Binding dropdownList}" event:onEntryClicked="onEntryClicked" event:onEntryMouseover="onEntryMouseover" event:onEntryMouseout="onEntryMouseout" Class="{Binding dropdownClass}" AriaLabel="{Binding ariaLabel}">        <Dropdown.ItemTemplate>            <DataTemplate>                <div class="{Binding cssClass}">                    <div class="{Binding iconClass}"><\/div>                    <TextBlock Text="{Binding name}" />                <\/div>            <\/DataTemplate>        <\/Dropdown.ItemTemplate>    <\/Dropdown><\/div>',yu='<PopOutButton PopOutContent="{Binding popOutContent}" PopOutTemplate="{Binding popOutTemplate}" IsDisplayed="{Binding isDisplayed Mode=TwoWay}" ButtonClass="{Binding buttonClass}"><\/PopOutButton>',pu='<div class="popupMessage" data-tag="popupMessage">    <PopOut Content="{Binding PopOut}">        <PopOut.ContentTemplate>            <DataTemplate>                <div class="messageContainer" event:click="onPopOutClick" tabindex="-1" role="dialog" aria-labelledby="saveMessage" >                    <div class="saveMessage" id="saveMessage" data-tag="saveMessage">                        <TextBlock text="{Binding title}" />                        <PopUpMessageControl linkTitle="{Binding linkTitle}" showLink="{Binding showLink}" event:popupLinkClicked="onPopOutLinkClick"/>                    <\/div>                    <div style:display="{Binding ShowAnnotate Converter=boolToDisplay}">                        <div class="annotateContainer" data-tag="AnnotateContainer" style:display="{Binding showFooter}">                            <div id="annotationLabel">                                <TextBlock text="{Binding updateNicknameMessage}" />                            <\/div>                            <div class="nameInputContainer">                                <input type="text" class="nameEditBox" data-tag="editItemTitleControl" maxlength="100" value="{Binding NickName Mode=TwoWay}" event:keydown="onPopOutKeyPressed" aria-labelledby="annotationLabel" />                                <a href="#" class="popoutSaveButton" data-tag="popoutSaveButton" event:click="onPopOutSaveLinkClick" event:touchend="onPopOutSaveLinkClick" role="button">                                    <TextBlock Text="{Binding saveButtonTitle}" />                                <\/a>                            <\/div>                        <\/div>                    <\/div>                <\/div>            <\/DataTemplate>        <\/PopOut.ContentTemplate>    <\/PopOut><\/div>',wu='<div class="dropdownTitleList">    <Dropdown ItemsSource="{Binding dropdownList}" event:onEntryClicked="onEntryClicked" Class="{Binding dropdownClass}">        <Dropdown.ItemTemplate>            <DataTemplate>                <div class="{Binding cssClass}">                    <div class="ratingStars"><div class="yellowStars"><\/div><div class="regularStars"><\/div><\/div>                    <div><TextBlock Text="{Binding name}" /><\/div>                <\/div>            <\/DataTemplate>        <\/Dropdown.ItemTemplate>    <\/Dropdown><\/div>',bu='<div class="signInPopup">    <PopOut Content="{Binding PopOut}">        <PopOut.ContentTemplate>            <DataTemplate>                <div>                    <SignInPopUpControl SignInMessage="{Binding title}" event:signInClicked="onPopOutLinkClick" event:signedIn="onSignedIn"/>                <\/div>            <\/DataTemplate>        <\/PopOut.ContentTemplate>    <\/PopOut><\/div>',ku='<div class="{Binding className}" style:display="{Binding ads Converter=adsToDisplay}" data-tag="syndicatedAds">    <ItemsControl ItemsSource="{Binding ads}" panelTagName="ul">        <ItemsControl.ItemTemplate>            <DataTemplate>                <li>                    <a href="{Binding title.url}" data-log="{Binding title.log}" event:click="onClick" target="_blank">                        <h2><FormattedTextBlock Formattedtext="{Binding title.text}" /><\/h2>                        <cite><FormattedTextBlock Formattedtext="{Binding displayUrl}" /><\/cite>                        <a class="saAdCaret" href="#" event:click="onAdChoiceClick" aria-label="{StaticBinding resources.L_AdAbout}" title="{StaticBinding resources.L_AdAbout}"><\/a>                        <div><span class="b_adSlug"><FormattedTextBlock Formattedtext="{StaticBinding resources.L_AdSlug}" /><\/span><FormattedTextBlock Formattedtext="{Binding description}" /><\/div>                        <AdRating data="{Binding rating}" rank="{Binding rank}" />                    <\/a>                <\/li>            <\/DataTemplate>        <\/ItemsControl.ItemTemplate>    <\/ItemsControl><\/div>',du='<div class="dropdownTitleList">    <Dropdown ItemsSource="{Binding dropdownList}" event:onEntryClicked="onEntryClicked" event:onEntryMouseover="onEntryMouseover" event:onEntryMouseout="onEntryMouseout" Class="{Binding dropdownClass}">        <Dropdown.ItemTemplate>            <DataTemplate>                <div class="{Binding cssClass}">                    <div class="{Binding iconClass}">                    <\/div>                    <div class="listItemText">                        <TextBlock Text="{Binding name}" />                    <\/div>                    <div class="arrow" style:display="{Binding showArrow Converter=boolToDisplay}"><\/div>                <\/div>            <\/DataTemplate>        <\/Dropdown.ItemTemplate>    <\/Dropdown><\/div>',gu='<div class="{Binding primitive.mapTypeClass}" data-tag="transientLensRoot">    <div id="transientLens" event:click="clickHandler" event:touchend="clickHandler" event:keydown="clickHandler" data-tag="transientLens" style="visibility:hidden;">        <div class="transientLensImg"><\/div>        <div class="transientLensActions">                        <ItemsControl ItemsSource="{Binding primitive.entity.actions}" panelTagName="ul">                <ItemsControl.ItemTemplate>                    <DataTemplate>                        <li>                            <a href="#" class="{Binding cssClass}" event:click="handler" event:touchend="handler" event:keydown="handler" event:mouseover="mouseoverHandler" event:mouseout="mouseoutHandler" data-instrumentation="{Binding instData}" data-tag="{Binding cssClass}">                                <div class="icon" ><\/div>                                <div class="actionText">                                    <TextBlock Text="{Binding text}" />                                <\/div>                                <div class="{Binding secTextClass}" style:display="{Binding showSecText Converter=boolToDisplay}"  event:click="secTextLinkHandler" event:touchend="clickHandler" data-tag="{Binding secTextClass}">                                    <TextBlock Text="{Binding secText}"/>                                <\/div>                                <div class="arrow" style:display="{Binding showArrow Converter=boolToDisplay}"><\/div>                            <\/a>                            <div class="transientLensSeparator" style:display="{Binding showSeparator Converter=boolToDisplay}"><\/div>                        <\/li>                    <\/DataTemplate>                <\/ItemsControl.ItemTemplate>            <\/ItemsControl>        <\/div>        <div class="directionsPopOut" data-tag="directionsPopOut">        <\/div>        <div class="travelPopOut" data-tag="travelPopOut">        <\/div>        <div class="collectionsPopOut" data-tag="collectionsPopOut">        <\/div>        <div class="nearbyPopOut" data-tag="nearbyPopOut">        <\/div>    <\/div><\/div>',s=this&&this.__extends||function(){var n=function(t,i){return n=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(n,t){n.__proto__=t}||function(n,t){for(var i in t)t.hasOwnProperty(i)&&(n[i]=t[i])},n(t,i)};return function(t,i){function r(){this.constructor=t}n(t,i);t.prototype=i===null?Object.create(i):(r.prototype=i.prototype,new r)}}(),nf=function(){function n(){this.resources=i}return n.prototype.getRootElement=function(){var n,t,r,u,i,f;if(!this._root&&(n=this.data,n)){for(this._root=a._createElement("div").add_class("saRating"),t=document.createElement("a"),t.href=n.ratingLink,t.target="_blank",t.setAttribute("data-log","R,"+this.rank+"|"+n.ratingLinkPingSuffix),t.textContent=a._formatString(this.resources.L_AdReviewCount,n.numberOfRatings),r=n.rating/2,u=document.createElement("span"),u.title=a._formatString(this.resources.L_AdRatingTooltip,r),i=0;i<5;++i)f="sw_sth",r<=i?f="sw_ste":r>=i+1&&(f="sw_st"),u.appendChild(document.createElement("span")).className=f;this._formatDomString(this._root,this.resources.L_AdRating,n.domain,u,null,t)}return this._root},n.prototype._formatDomString=function(n,t){for(var f,e,o,r,c,s=[],u=2;u<arguments.length;u++)s[u-2]=arguments[u];if(t&&s){var l=/\d+/g,i=0,h=t.match(/{\d+}/g);if(h)for(f=0;f<h.length;f++)e=h[f],o=t.indexOf(e,i),o>i&&n.appendText(t.substring(i,o)),r=s[Number(e.match(l)[0])],r!==null&&(c=typeof r,c!=="undefined"&&(c==="string"?n.appendText(r):n.append(r))),i=o+e.length;i<t.length&&n.appendText(t.substring(i))}},n}();g.registerControl("AdRating",nf),function(n){n[n.TST=1]="TST";n[n.LI=2]="LI";n[n.PD=4]="PD";n[n.HO=5]="HO";n[n.PL=6]="PL";n[n.EV=9]="EV";n[n.LS=10]="LS";n[n.DE=11]="DE"}(ii||(ii={})),function(n){n[n.Q=1]="Q";n[n.R=2]="R";n[n.N=3]="N";n[n.C=4]="C";n[n.E=5]="E";n[n.V=6]="V"}(tt||(tt={}));var et=function(){function n(){}return n.logEvent=function(t,i,r){r.SC=t;var e={logData:{feature:n.featureName,action:tt[i],data:r},impressionGuid:h.dynamicProperties.mapsIG};f.invokeHandler(u.instrumentationDataHandlerKey,e)},n.featureName="ADS",n}(),rr=function(){function n(){}return n.setShownAds=function(t,i,u,f){var l=0,s,e,a,o,v,y,h,c,p;if(i)for(s=i.length-1;s>=0;s--)if(e=r(i[s]).select(".mta_ad"),e&&e.length)for(a=e.length,l+=a,o=0;o<a;o++){for(v=e[o].getElementsByTagName("A"),y=function(){var t=v[h];t&&n.updateAdLink(t,u,function(){return n.logAdClick(t,c,!1,f)})},h=0;h<v.length;h++)y();e[o].addEventListener("click",function(t){return n.listItemClickHandler(t,c,u,f)})}l>0&&(c=n.getTracingTag(t),p={C:l},et.logEvent(c,tt.R,p))},n.updateAdLink=function(t,i,r){if(t){var u=t.getAttribute("h")||t.getAttribute("data-h");u&&(t.removeAttribute("h"),t.removeAttribute("data-h"),t.setAttribute("h1",u),t.addEventListener("click",function(){n.callGLink(t,i);r&&r()}))}},n.callGLink=function(n,t){var r=n.getAttribute("h1"),u,i;if(r){u=_G.IG;try{_G.IG=t;i="&"+r+"&url="+encodeURIComponent(n.href);_w.si_sbwu&&_w.si_sbwu(i)||_w.si_T&&_w.si_T(i)}finally{_G.IG=u}}},n.getTracingTag=function(n){return n?ii[n]:""},n.logAdClick=function(n,t,i,r){var u=n.getAttribute("data-log"),f;u&&(i&&(u=u.replace("T","S")),f={L:u},r&&(f.D=r),et.logEvent(t,tt.C,f))},n.listItemClickHandler=function(t,i,r,u){function e(t){var e=t.getElementsByTagName("a"),f;e&&e.length>0&&(f=e[0],n.logAdClick(f,i,!0,u),n.callGLink(f,r),_w.open(f.href,"_blank"))}for(var f=t.target;f;){if(f.tagName==="A")return!0;if(f.className.indexOf("ad_sc")!==-1)break;else if(f.className.indexOf("infobubble_item")!==-1||f.className.indexOf("qv_noclick")!==-1)return!1;f=f.parentNode}return f?(e(f),t.stopPropagation(),!1):!1},n.logQueryEvent=function(n){et.logEvent("WF",tt.Q,{D:n})},n.logAdsShown=function(n){et.logEvent("WF",tt.V,{D:n})},n}(),tf=function(n){function t(t,r,u){var f=this,e={};return f=n.call(this,e,r,ku)||this,f.resources=i,e.defineProperty("ads"),f._syndicatedAds=t,f.choiceUrl=pt.choiceUrl,f.className="bm_syndicatedAds syndicatedAds",u&&(f.className+=" saCardified"),f}return s(t,n),t.prototype.onClick=function(n){var f="data-log",t=n.target,i=t&&t.getAttribute(f),u;if(i||(t=n.currentTarget,i=t&&t.getAttribute(f)),i){var r=i.split("|"),e={L:r[0]},o=this._syndicatedAds.getLogData();o&&(e.D=o);et.logEvent(this._syndicatedAds.getTracingTag(),tt.C,e);this._pingUrlBase&&r[1]&&(u=new XMLHttpRequest,u.open("GET",this._pingUrlBase+r[1],!0),u.send())}},t.prototype.SetResponse=function(n){var h=[],i={},l=!0,r,e,u,f,c,t,o,s;try{if(n&&n.length&&(r=JSON.parse(n),r))if(r._type==="Ads"){if(e=r,u=e.value,u&&u.length)for(f=0;f<u.length&&f<pt.maxTextAdCount;f++)c=this._buildAdV5(u[f],i),c&&h.push(c);e.instrumentation&&(this._pingUrlBase=e.instrumentation.pingUrlBase);i.C=h.length;l=!1}else if(r._type==="ErrorResponse"){if(t="",o=r.errors,o)for(s=0;s<o.length;s++)t.length>0&&(t+=","),t+=o[s].code;i.ER=t}this.setAds(h)}catch(t){this.setAds(null);i.EX=t&&t.message}return l&&(i.RE=typeof n=="string"?n.substring(0,50):""),i},t.prototype.Clear=function(){this.setAds(null)},t.prototype._buildAdV5=function(n,t){var i,o,u,r,f,e,s,h,c,l;if(n.extensions)for(u=0;u<n.extensions.length;u++)if(r=n.extensions[u],r)switch(r._type){case"Ads/MerchantRatingExtension":o=r;break;case"Ads/CreativeAnnotation":if(f=r.overrides,f)for(e=0;e<f.length;++e)s=f[e],(!i||s.maxTitleLength<i.maxTitleLength)&&(i=s)}return h="T,"+n.rank,c=n.urlPingSuffix,c&&(h+="|"+c),l={rank:n.rank,title:{text:i&&i.title?i.title:n.title,url:n.url,log:h},displayUrl:n.displayUrl,description:i&&i.description?i.description:n.description},o&&(l.rating=o,t.M=t.M?t.M+1:1),t.P||(t.P=""),t.P+=n.position&&n.position.length?n.position.charAt(0):"?",l},t.prototype.adsToDisplay=function(n){return this.boolToDisplay(n&&n.length>0)},t.prototype.onAdChoiceClick=function(n){var u=this,t,i;n&&(n.stopPropagation(),n.preventDefault(),o&&o.UserTipControl&&n.target&&(t=new o.UserTipControl(null,null,[this.resources.L_AdAbout],!0,!0,!1,!0),t.setShowClose(!1),t.setShowBeak(!0),t.setLinkUrl(this.choiceUrl),this.disposables.push(t.tipRemoved.add(function(){u.adChoicePopup=null})),i=r(n.target),i.append(t.getRootElement()),this.adChoicePopup&&this.adChoicePopup.removeTip(),this.adChoicePopup=t))},t}(wt),rf=function(){function n(n,t){this._controlTemplateFactory=n;this.setScenario(t)}return n.prototype.getControl=function(){return this._getViewModel().getControl()},n.prototype.requestAds=function(t,i,r,u,f){var e=this,o,s,c,l;if(n.isEnabled()&&(t&&(t=t.trim()),this._query!==t)){if(this._query=t,o=this._getViewModel(),!t||!t.length||!r){o.Clear();this.setPosition(null);return}if(u){if(s=n._cache=n._cache||new dr(16),c=s.getItem(u),c){l=o.SetResponse(c);this.setPosition(l);return}s.addItem(u,"{}")}var v=pt,y=i.latitude.toFixed(5),p=i.longitude.toFixed(5),w=a._formatString(v.adsEndpointUrl,encodeURIComponent(t),y,p,r,v.ratings?"r":"",h.dynamicProperties.market,this._tracingTag);ft.downloadGeneric(w,"ads",function(n){var t=o.SetResponse(n);e._logData&&(t.D=e._logData);et.logEvent(e._tracingTag,tt.R,t);u&&s&&t.C&&s.addItem(u,n);e.setPosition(t);f&&f()},null,function(n,t,i){o.Clear();e.setPosition(null);et.logEvent(e._tracingTag,tt.N,{ER:(t||"")+","+(i||"")})},null,0);et.logEvent(this._tracingTag,tt.Q,{})}},n.isEnabled=function(){return!!(pt&&pt.isEnabled)},n.prototype.setScenario=function(n){this._tracingTag=n?ii[n]:""},n.prototype.getTracingTag=function(){return this._tracingTag},n.prototype.setLogData=function(n){this._logData=n},n.prototype.getLogData=function(){return this._logData},n.prototype.setPosition=function(n){this._position=n&&n.P&&n.P.length?n.P[0]:null},n.prototype.getPosition=function(){return this._position},n.logError=function(n,t){var i=typeof n=="string"?n:n&&(n.message||n.result);et.logEvent(t||"",tt.E,{EX:i||""})},n.prototype._getViewModel=function(){if(!this._viewModel){var n=this.getTracingTag().substring(0,2)==="LI";this._viewModel=new tf(this,this._controlTemplateFactory,n)}return this._viewModel},n}(),uf=function(){function n(){}return n.setShownAds=function(t,i,r,u,f){var e,s,o;if(r&&r.length&&(e=r.select(i),e&&e.length))for(n.logEvent(t,u,"CI.TnAAdsShown",f),s=function(i){var o=e[i].getElementsByTagName("A"),r=o&&o[0];r&&rr.updateAdLink(r,u,function(){return n.logEvent(t,u,"CI.TnAAdsClick",f,r.href)})},o=0;o<e.length;o++)s(o)},n.logEvent=function(t,i,r,e,o){var s={SC:t},h;o&&(s.adsUrl=o);e&&(s.CAT=e);h={logData:{feature:n.featureName,action:r,data:s},impressionGuid:i};f.invokeHandler(u.instrumentationDataHandlerKey,h)},n.featureName="TnAAds",n}(),li=function(n){function t(t,i,r,u,f){var e=this,o={};return e=n.call(this,o)||this,e.suggestion=t,o.defineProperty("isSelected",null,null,{defaultValue:!1}),e._formatSuggestion(e.suggestion),e._applyImageClass(t),e.setSimpleSearchText(),e._itemSelectionEvent=i,e._itemClickEvent=r,e._instrumentationHelper=u,e.optionId=f,e}return s(t,n),t.prototype.setSimpleSearchText=function(){var n=this._formattingRule&&this._formattingRule["b:groupSeparator"]||", ";if(this.suggestion.type==="Favorite"){var t=this.suggestion,i=t.name,r=t.address&&t.address.streetAddress;this._searchText=i===r||!r?i:i+n+r}else this._searchText=this.suggestionTextLine2?e.searchTextFormat?e.searchTextFormat.replace("{line1}",this.suggestionTextLine1).replace("{line2}",this.suggestionTextLine2).replace("{separator}",n):this.suggestionTextLine1+n+this.suggestionTextLine2:this.suggestionTextLine1;this.suggestion&&(this.suggestion.searchText=this._searchText)},t.prototype.handleSuggestionClick=function(n){n.currentTarget&&(this._itemClickEvent&&this._itemClickEvent.invoke(this.suggestion),this._instrumentationHelper&&this._instrumentationHelper.instrumentSearchEvent(this._searchText,1,this.suggestion))},t.prototype.select=function(){this._itemSelectionEvent&&this._itemSelectionEvent.invoke(this.suggestion)},t.prototype.dispose=function(){a._disposeEvents(this);this.suggestion=null;n.prototype.dispose.call(this)},t.prototype._formatSuggestion=function(n){var r=this.suggestion.formattingRule,t=n;if(n.type==="Favorite"){this.suggestionTextLine1=t.subType==="Home"?i.L_Home:t.subType==="Work"?i.L_Work:t.alternateName?t.alternateName:t.name;this.suggestionTextLine2=t.address&&t.address.streetAddress;this.suggestion.formatedAddress=t.address&&t.address.streetAddress;this.suggestion.title=t.name;return}t.name&&(this.suggestionTextLine1=t.name,n.title=t.name);t.query&&(this.suggestionTextLine1=t.query);r?(this._formattingRule=r,this.suggestion.address?this._applyFormattingRule(this.suggestion.address):this._applyFormattingRule(n.root)):(this.suggestionTextLine1=n.title,this.suggestionTextLine2=n.formatedAddress);this.suggestion.formatedLine1=this.suggestionTextLine1;this.suggestion.formatedLine2=this.suggestionTextLine2},t.prototype._applyFormattingRule=function(n){var t=0,i=this._formattingRule["b:fieldGroups"]||this._formattingRule.fieldGroups,r,u,f,e;if(!this.suggestionTextLine1&&i)for(;t<i.length;t++)if(r=this._getFormattedGroupString(n,i[t]),r){this.suggestionTextLine1=r;this.suggestion.title=r;++t;break}if(u=[],i)for(;t<i.length;t++)f=this._getFormattedGroupString(n,i[t]),f&&u.push(f);e=this._formattingRule["b:groupSeparator"]||this._formattingRule.groupSeparator||", ";this.suggestionTextLine2=u.join(e);this.suggestion.formatedAddress=this.suggestionTextLine2},t.prototype._applyImageClass=function(n){var r=e.showXSRColors&&(h.isMapsVertical||e.isMobileShellAutosuggest),u=!e.showXSRIcons&&h.isMapsVertical;this.suggestionImgClass=n.type==="s:BusinessEntityType"&&n.subType==="BusinessCategory"||n.type==="SearchAction"?r?"as_img maps_searchsvg":"as_img maps_search":n.type==="s:LocalBusiness"&&n.subType?r?"as_img maps_businesssvg":u?"as_img maps_address":"as_img maps_business":n.type&&(n.type.indexOf("Place")>=0||n.type.indexOf("PostalAddress")>=0)?r?"as_img maps_addresssvg":"as_img maps_address":n.title===i.L_Work||n.subType==="Work"?r?"as_img maps_worksvg":"as_img maps_work":n.title===i.L_Home||n.subType==="Home"?r?"as_img maps_homesvg":"as_img maps_home":n.type==="Favorite"?r?"as_img maps_favsvg":"as_img maps_favorite":n.type==="History"||n.type===t.HistorySuggestionType?"as_img maps_history":n.title===i.L_MyLocation?"as_img maps_mylocation":n.entityId&&n.entityId.indexOf("local_geoid")<0?r?"as_img maps_businesssvg":u?"as_img maps_address":"as_img maps_business":r?"as_img maps_searchsvg":"as_img maps_search"},t.prototype._getFormattedGroupString=function(n,t){for(var e,f=[],i,u=t.fields,r=0;r<u.length;r++)i=this._getPrimaryField(n,u[r]),i||(i=this._getAlternateField(n,u[r])),i&&f.push(i);return e=t.fieldSeparator||" ",f.join(e)},t.prototype._getPrimaryField=function(n,t){var i;return n&&t&&(i=n[t.name]),i},t.prototype._getAlternateField=function(n,t){var r,u,f,i;if(n&&t&&(u=t.alternateField,u))for(f=u.split(","),i=0;i<f.length;i++)if(r=n[f[i]],r)break;return r},t.HistorySuggestionType="history",t}(ot),ut=function(){function n(){}return n.autosuggestFeature="MapsAutoSuggest",n.actionSearchEvent="Search Event",n.searchEventSuggestionSelectSuggestionClick="Suggestion Select:Suggestion Click",n.searchEventSuggestionSelectEnterPress="Suggestion Select:Enter Press",n.searchEventSuggestionSelectSearchButtonClick="Suggestion Select:Search Button Click",n.searchEventEnterPress="Enter Press",n.searchEventSuggestionShown="Suggestions Shown",n.searchEventSearchButtonClick="Search Button Click",n.AppNameSpace="App",n.AppName="web",n.UIFieldName="UI",n.UIType="sbx",n.LocalTime="LTime",n.suggestionSourceServer="S",n.sdkEntryPoint="SDK",n.mapsEntryPoint="Maps",n}(),ff=function(){function n(n){this._resetConversationId();this._refreshCid=!1;this._entryPoint=n?ut.sdkEntryPoint:ut.mapsEntryPoint}return n.prototype.setRequestAndSuggestions=function(n,t){this._request=n;this._suggestions=t},n.prototype.setResponseModel=function(n){this._responseModel=n},n.prototype.createDirectionsInstrumentationData=function(n,t,i){var r,u;for(this._directionsInstrumentationData={},this._directionsInstrumentationData.cmdir=n,this._directionsInstrumentationData.contextId=i,r=0;r<t.length;r++)u="from",r===1?u="to":r>=2&&(u="to"+r),t[r].address&&(this._directionsInstrumentationData["cq"+u]=t[r].address),t[r].eid&&(this._directionsInstrumentationData["ce"+u]=t[r].eid),t[r].type&&(this._directionsInstrumentationData["cc"+u]=t[r].type),t[r].stype&&(this._directionsInstrumentationData["cg"+u]=t[r].stype)},n.prototype.resetLastShownSuggestionsTime=function(){this._lastShownSuggestionsTimeStamp=new Date},n.prototype.setSearchStartTimeStamp=function(){this._searchStartTimeStamp||(this._searchStartTimeStamp=new Date)},n.prototype.dismissSearchStartTimeStamp=function(){this._searchStartTimeStamp&&(this._lastConverationDuration=Date.now()-this._searchStartTimeStamp.getTime(),this._searchStartTimeStamp=null)},n.prototype.instrumentSearchEvent=function(n,t,i){var r,o,s,e;if(this._request){if((t===1||t===3)&&this.instrumentSelectionEvent(i),r={},this._responseModel&&(r.Md=this._responseModel),r.App=ut.AppName,r.LTime=this._getFormattedDate(new Date,"{yyyy}{mm}{dd}{hh}{nn}"),r.FN=ut.autosuggestFeature,r.EP=this._entryPoint,r.UL=this._request.userLocation,r.Bx=this._request.localMapView,r.M=h.dynamicProperties.market,r.L=h.dynamicProperties.uiLanguage,r.Q=n,r.NS=this._suggestions.length,r.NR=this._suggestions.length,r.S=this._getEventNameFromType(t),r.Cid=this._conversationId,i&&(r.Clk=i.suggestionRank),this._refreshCid&&(this._resetConversationId(),this._refreshCid=!1),t!==4&&(this._refreshCid=!0,this.dismissSearchStartTimeStamp(),r.E=this._lastConverationDuration),this._directionsInstrumentationData&&(r.Direction=this._directionsInstrumentationData),this._suggestions&&i&&t!==4)o=[],o.push(this._getSuggestionItemInstrumentationData(this._suggestions[i.suggestionRank])),r.Sg=o;else if(this._suggestions&&t===4){for(s=[],e=0;e<this._suggestions.length;e++)s.push(this._getSuggestionItemInstrumentationData(this._suggestions[e]));r.Sg=s}f.invokeHandler(u.instrumentationDataHandlerKey,{logData:r})}},n.prototype.instrumentLoadCompeleteEvent=function(n){ft.downloadGeneric(n,ri.autosuggestCallerId,null)},n.prototype.instrumentSelectionEvent=function(n){if(n.instrumentationInfo){var t=n.instrumentationInfo.pingUrlBase;t+=n.readLinkPingSuffix;ft.downloadGeneric(t,ri.autosuggestCallerId,null)}},n.prototype.getConversationId=function(){return this._conversationId},n.prototype._resetConversationId=function(){this._conversationId=a._generateRandomKey()},n.prototype._getFormattedDate=function(n,t){var o=n.getFullYear().toString(),i=n.getMonth()+1,r=n.getDate(),u=n.getHours(),f=n.getMinutes(),e=n.getSeconds();return t.replace("{yyyy}",o).replace("{mm}",i<10?"0"+i.toString():i.toString()).replace("{dd}",r<10?"0"+r.toString():r.toString()).replace("{hh}",u<10?"0"+u.toString():u.toString()).replace("{nn}",f<10?"0"+f.toString():f.toString()).replace("{ss}",e<10?"0"+e.toString():e.toString())},n.prototype._getEventNameFromType=function(n){switch(n){case 1:return ut.searchEventSuggestionSelectSuggestionClick;case 2:return ut.searchEventEnterPress;case 3:return ut.searchEventSuggestionSelectEnterPress;case 4:return ut.searchEventSuggestionShown;case 6:return ut.searchEventSearchButtonClick;case 5:return ut.searchEventSuggestionSelectSearchButtonClick}},n.prototype._getSuggestionItemInstrumentationData=function(n){var t={};return n&&(t.S=ut.suggestionSourceServer,t.Eid=n.suggestionTextLine1+"~"+n.suggestionTextLine2+"~"+(n.suggestion.entityId||n.suggestion.geoId||""),t.C=n.suggestion.type,t.G=n.suggestion.subType),t},n}(),ri=function(){function n(n){this._suggestionTypes=n||"";this._parseLocationFromAS=!0;this._isSearchAlongRoute=!1}return n.prototype.addExtraASParams=function(n){return n},n.prototype.setInstrumentationHelper=function(n){this.instrumentationHelper=n},n.prototype.getDefaultSuggestions=function(){return[]},n.prototype.getIsSearchAlongRoute=function(){return this._isSearchAlongRoute},n.prototype.setIsSearchAlongRoute=function(n){this._isSearchAlongRoute=n},n.prototype.getSuggestions=function(t,i){var r=this,u,f,o,s;if(!t.disableThisRequest){if((!t.searchText||t.searchText.trim()==="")&&(!e.autosuggestFavorites||!this._useFavoriteSuggestions)){this._currentRequestCallbackId="";u=this.getDefaultSuggestions();f=this.getHistorySuggestions();u=this._combineSuggestions(f,u);this._updateSuggestionsRank(u);o={suggestions:u};i(o);return}s=this._constructASRequestUrl(t);this._currentRequestCallbackId=Date.now().toString()+t.searchText;su.instance.authenticateClientAndRetrieveSessionId(function(){r._currentNetworkRequestId=ft.downloadJson(s,n.autosuggestCallerId,function(n,u){var o;if(u===r._currentRequestCallbackId){var f=r._parseSuggestionsV6(n),s=r.getHistorySuggestions(t.searchText),h=!t.searchText||t.searchText.trim()===""?r.getDefaultSuggestions():[];f.suggestions=r._combineSuggestions(f.suggestions,s);f.suggestions=r._combineSuggestions(f.suggestions,h);r._updateSuggestionsRank(f.suggestions);i(f,e.enableSmartCompose?n.queryCompletion:null);n.instrumentation&&r.instrumentationHelper&&(o=n.instrumentation.pageLoadPingUrl,r.instrumentationHelper.instrumentLoadCompeleteEvent(o))}},function(){},r._currentRequestCallbackId,!0,null,!1,null)})}},n.prototype.getHistorySuggestions=function(){return[]},n.prototype.getMaxResults=function(){return e.autoSuggestMaxResults},n.prototype._constructASRequestUrl=function(n){var t=e.autoSuggestServiceUrlFormat,l=encodeURIComponent(n.searchText),i=h.dynamicProperties,f=e.autoSuggestServiceHostUrlFormat.replace("{BingHostName}",i.bingRequestDomain),o=window.location.search.substr(1),s=o.indexOf("asep"),c,r,u;if(s>=0){t=t.replace("?","&");var a=o.substr(s),v=a.split("&"),y=v[0].split("=");f=decodeURIComponent(y[1])}return c=n.maxResults?n.maxResults:this.getMaxResults(),t=t.replace("{host_url}",f).replace("{local_map_view}",n.localMapView||"").replace("{user_location}",n.userLocation||"").replace("{max_results}",c.toString()).replace("{app}",n.applicationName||"webv8").replace("{query}",l).replace("{ig}",i.impressionGuid).replace("{conversation_id}",this.instrumentationHelper&&this.instrumentationHelper.getConversationId()).replace("{appid}",n.applicationId||e.autosuggestAppid||i.appId).replace("{market}",n.market||i.market).replace("{lang}",i.uiLanguage).replace("{suggestionTypes}",n.suggestionTypes||this._suggestionTypes),t=this.addExtraASParams(t,n),t=t.replace("{histcnt}",""),t=t.replace("{favcnt}",""),n.countryCode&&n.countryCode.length===2&&(t+="&constraints=country:"+n.countryCode),r=e.autosuggestFavorites&&!n.disableFavorites,u=e.autosuggestHistory&&!n.disableHistory,(r||u)&&(t+="&ptypes=",this.getIsSearchAlongRoute()||(t+=r?"favorite":"history",t+=r&&u?",history":"")),t+="&clientid="+i.clientId,e.abbrSuggestions&&(t+="&abbrtext=1"),e.enableSmartCompose&&(t+="&features=qcon"),t},n.prototype._combineSuggestions=function(n,t){var u=[],f,i,o,r;if(t&&t.length)for(u=t,f=!1,i=0;i<n.length;i++){var l=n[i].root,e=n[i].address,s=e&&e.streetAddress,h=e&&e.addressLocality,c=n[i].name;for(o=0;o<t.length;o++)if(r=t[o],s&&r.formatedAddress&&r.formatedAddress.indexOf(s)>-1&&(h&&r.formatedAddress.indexOf(h)>-1||c&&r.title&&r.title.indexOf(c)>-1)){f=!0;break}if(f){f=!1;continue}else u.push(n[i])}else u=n;return u},n.prototype._updateSuggestionsRank=function(n){for(var t=0;t<n.length;t++)n[t].suggestionRank=t},n.prototype.buildSuggestion=function(n,t,i,r,u){var f={},s,o,h,c,l;return f.root=n,f.type=n._type,f.readLink=n.readLink,f.readLinkPingSuffix=n.readLinkPingSuffix,f.instrumentationInfo=i,f.suggestionRank=t,f.formattingRuleId=n.formattingRuleId,f.formattingRule=r,f.entityId=e.enableSmartCompose&&u?null:n.id,f.name=n.name,f.query=n.query,s=n.categories,f.primaryCategoryPath=s&&s.length&&s[0],f.entityId&&f.entityId.indexOf("local_geoid")===0&&(f.geoId=f.entityId,f.entityId=""),o=n.entityPresentationInfo,o&&o.entitySubTypeHints&&o.entitySubTypeHints.length&&(f.subType=o.entitySubTypeHints[0]),h=n.geo,h&&this._parseLocationFromAS&&(c=h.latitude,l=h.longitude,c&&l&&(f.location=new at(c,l))),n.address?f.address=n.address:n.location&&n.location.length?f.address=n.location[0].address:f.type==="PostalAddress"&&(f.address=n),f.type=="Favorite"&&(f.alternateName=n.alternateName,f.subType=n.subType,this._processFavoriteItemId(n,f)),f},n.prototype._parseSuggestionsV6=function(n){var t={},e=[],o,s,u,i,f,r,h;if(n)for(o=n.instrumentation,t.formattingRules=this._createFormattingRulesV6(n.formattingRules),s=this._getDefaultFormattingRuleV6(t.formattingRules),this.instrumentationHelper&&this.instrumentationHelper.setResponseModel(n.model),u=n.value,i=0;i<u.length;i++){f={};try{r=u[i];h=r.formattingRuleId&&t.formattingRules[r.formattingRuleId]||s;f=this.buildSuggestion(r,i,o,h);e.push(f)}catch(c){}}return t.suggestions=e,t},n.prototype._createFormattingRulesV6=function(n){var r={},t,i;if(n)for(t=0;t<n.length;t++)i=JSON.parse(n[t]),r[i.identifier]=i;return r},n.prototype._getDefaultFormattingRuleV6=function(n){var t=n&&n.Default||null,i,r;for(i in n)if(t||(t=n[i]),r=h.dynamicProperties.market.toLowerCase(),r.indexOf(i.toLowerCase())>-1){t=n[i];break}return t},n.prototype._processFavoriteItemId=function(n,t){var i=n.bingId;i&&(i.indexOf("local_ypid:")===0||i.indexOf("sid")===0||i.indexOf("local_vdpid")===0)&&(t.entityId=i);t.bingId=i},n.autosuggestCallerId="autosug",n}(),ef=function(n){function t(t,r,u,f,e,o){var s=this,c={};return s=n.call(this,c)||this,c.defineProperty("showNearBySearchText"),c.defineProperty("showSuggestionsPanel",function(n,t){s._onVisibleChanged(n,t)},null,{defaultValue:!1}),c.defineProperty("showBingLogo",null,null,{defaultValue:!a._hasBingHeaders()}),c.defineProperty("width",null,null,{defaultValue:0}),c.defineProperty("cssClass"),c.defineProperty("id"),c.defineProperty("ariaOwns"),c.defineProperty("showInPrivateLink"),h.isInPrivateMode&&(h.isMapsVertical||h.isMapsAnswer)&&s.setShowInPrivateLink(!0),s._displayWaterMarkText=u,s._controlTemplateFactory=r,s._autosuggestDataModel=t,s.templateId=cu,s._suggestions=[],s._currentQueryCompletion=null,s._currentSuggestion=null,s._mapTemplateSelectorReadyEvent=new w,s.taskName=f||a._generateRandomKey(),s._visibilityChangedEvent=e,s._selectionChangedEvent=o,s.inPrivateText=i.InPrivateAutosuggestFooterText,s.inPrivateLinkText=i.InPrivateAutosuggestFooterLink,s}return s(t,n),t.prototype.setMap=function(n){var t=this;this._map=n;this._map&&this._map.getTemplateSelector().then(function(n){t._mapTemplateSelector=n;t._mapTemplateSelectorReadyEvent.invoke()})},t.prototype.setAsTextBox=function(n){this._asTextBox=n},t.prototype.setRefreshSuggestionEvent=function(n){this._updateSuggestions=n},t.prototype.setItemSelectionEventHandler=function(n){this._itemSelectionEvent=n},t.prototype.setItemClickEventHandler=function(n){this._itemClickEvent=n},t.prototype.getIsSearchAlongRoute=function(){return this._autosuggestDataModel&&this._autosuggestDataModel.getIsSearchAlongRoute()},t.prototype.setIsSearchAlongRoute=function(n){this._autosuggestDataModel&&this._autosuggestDataModel.setIsSearchAlongRoute(n)},t.prototype.updateSuggestions=function(n,t){var i=this;this.selectedItemIndex=-1;this._selectionChangedEvent&&this._selectionChangedEvent.invoke("");this._request=n;this.setSuggestions([]);this._instrumentationHelper&&this._instrumentationHelper.setSearchStartTimeStamp();this._autosuggestDataModel.getSuggestions(n,function(r,u){i._onSuggestionsCallBack(n.searchText,t,r,u)})},t.prototype.boolToVisibility=function(n){return n?"visible":"hidden"},t.prototype.boolToSelectedClassName=function(n){return n?"suggestLink selected":"suggestLink"},t.prototype.boolToDisplay=function(n){return n?"inline":"none"},t.prototype.numberToPixelString=function(n){return n?n.toString()+"px":""},t.prototype.stopAutosuggestion=function(){this.removeWidth();this.setShowSuggestionsPanel(!1);this._instrumentationHelper.dismissSearchStartTimeStamp();this._hideCompletedQuery()},t.prototype.selectNextItem=function(){var n=this._suggestions.length;if(n!==0)return(this.selectedItemIndex>=0&&this._suggestions[this.selectedItemIndex].setIsSelected(!1),this.selectedItemIndex++,this.selectedItemIndex>=n)?(this.selectedItemIndex=-1,!1):(this._suggestions[this.selectedItemIndex].setIsSelected(!0),this._suggestions[this.selectedItemIndex].select(),this._selectionChangedEvent&&this._selectionChangedEvent.invoke(this._suggestions[this.selectedItemIndex].optionId),this._hideCompletedQuery(),!0)},t.prototype.selectPreviousItem=function(){var n=this._suggestions.length;if(n!==0)return(this.selectedItemIndex>=0&&this._suggestions[this.selectedItemIndex].setIsSelected(!1),this.selectedItemIndex--,this.selectedItemIndex<0)?(this.selectedItemIndex=-1,!1):(this._suggestions[this.selectedItemIndex].setIsSelected(!0),this._suggestions[this.selectedItemIndex].select(),this._selectionChangedEvent&&this._selectionChangedEvent.invoke(this._suggestions[this.selectedItemIndex].optionId),this._hideCompletedQuery(),!0)},t.prototype.completeCurrentQuery=function(){if(this._currentQueryCompletion){var t=r("#maps_sb"),n=this._autosuggestDataModel.buildSuggestion(this._currentQueryCompletion.completionEntity,-1,null,this._currentQueryCompletion.completionEntity.formattingRuleId,this._currentQueryCompletion.completionType!=="Query"),i=this._currentQueryCompletion.prefix+this._currentQueryCompletion.suffix;n.query=n.name=n.title=i;t.length>0&&(t[0].value=i);this._currentSuggestion=new li(n,this._itemSelectionEvent,this._itemClickEvent,this._instrumentationHelper,this.taskName+"-as-qc");this.selectedItemIndex>=0&&(this._suggestions[this.selectedItemIndex].setIsSelected(!1),this.selectedItemIndex=-1);this._currentSuggestion.setIsSelected(!0);this._hideCompletedQuery();this._updateSuggestions&&this._updateSuggestions.invoke()}},t.prototype.hideQueryCompletion=function(){this._hideCompletedQuery()},t.prototype.getCurrentSuggestion=function(){return this._currentSuggestion},t.prototype.clearCurrentQueryCompletionState=function(){this._currentQueryCompletion=null;this._currentSuggestion=null;this._hideCompletedQuery()},t.prototype.hasCompletionQuery=function(){return this._currentQueryCompletion!==null},t.prototype.completePredictedQuery=function(){return this._currentQueryCompletion?this._currentQueryCompletion.prefix+this._currentQueryCompletion.suffix:null},t.prototype.logAutosuggestClientInst=function(n,t,i,r){var e={},o;t&&(e.keyPress=t);i&&(e.seedQuery=i);r&&(e.query=r);o={logData:{feature:"ASSC",action:n,data:e}};f.invokeHandler(u.instrumentationDataHandlerKey,o)},t.prototype.removeWidth=function(){var n=r(".as_container_search"),t;n&&(t=n.get_attr("style"),t.indexOf("width")>-1&&t.indexOf("visibility")===-1&&(n.remove_attr("style"),n.set_attr("style","visibility: hidden")))},t.prototype.inPrivateLinkClick=function(n){n.stopPropagation();window.location.href=e.inPrivateLink},t.prototype._setWidth=function(){var t=r(".as_container_search"),n;if(t.length&&this._asTextBox.id&&this._asTextBox.id.indexOf("maps_sb")>-1){if(n=t[0].parentElement,n&&n.id.indexOf("maps_sb_container")>-1&&n.querySelector(":focus")){var o=n.parentElement,l=Number(o.clientWidth),a=r(o).select(".searchbox").get_style("borderWidth"),i=parseInt(a);i=isNaN(i)?0:i;var s=r(".bm_overflowCountContainer")[0],u=s?Number(s.clientWidth):0,f=l-u+i*2,c=u;e.enableSmartCompose?(t.set_style({width:f+"px","margin-left":c+"px"}),this._adjustQueryCompletionWidth(f,u)):t.set_style({width:f+"px","margin-left":c+"px"});e.showXSRColors&&(h.isMapsVertical||e.isMobileShellAutosuggest)||this._adjustIconCentering()}}else this.removeWidth()},t.prototype._hideCompletedQuery=function(){e.enableSmartCompose&&r(".bm_completionBox").add_class("bm_completionBoxHidden")},t.prototype._showCompletedQuery=function(){e.enableSmartCompose&&r(".bm_completionBox").remove_class("bm_completionBoxHidden")},t.prototype._adjustQueryCompletionWidth=function(n,t){if(e.enableSmartCompose){var u=t?t:0,i=r(".bm_completionBox");i.length>0&&i.set_style({width:n+"px","padding-left":u+"px"})}},t.prototype._showQueryCompletionSuggestion=function(n){if(n&&n.suffix){var t=r("#maps_sb"),i=r(".bm_overflowCountContainer"),u=r(".bm_completionBox"),f=n.prefix+n.suffix;u.length>0&&(u[0].value=f);this._currentQueryCompletion=n;this._showCompletedQuery();t.add_class("bm_as_queryComp");t.length>0&&this._adjustQueryCompletionWidth(t[0].clientWidth,i.length>0?i[0].clientWidth:0);this.logAutosuggestClientInst("QCSHOW",null,n.prefix,f)}},t.prototype._onSuggestionsCallBack=function(n,t,i,r){var f=i.suggestions,o,u;if((document.activeElement===this._asTextBox||!this._asTextBox)&&n===this._request.searchText)if(f.length>0){for(o=[],u=0;u<f.length;u++)o.push(new li(f[u],this._itemSelectionEvent,this._itemClickEvent,this._instrumentationHelper,this.taskName+"-as-"+u));this._instrumentationHelper&&this._instrumentationHelper.resetLastShownSuggestionsTime();this.setSuggestions(o);this._instrumentationHelper&&this._instrumentationHelper.instrumentSearchEvent(n,4,this.getSelectedSuggestion());this._applyAutoSuggestControlTemplateBinding(t,n);e.enableSmartCompose&&r&&this._showQueryCompletionSuggestion(r);e.showXSRIcons&&this._updateCategoryIconsAfterSelectorReady(t);this.removeWidth();this._setWidth();e.showXSRColors&&(h.isMapsVertical||e.isMobileShellAutosuggest)||this._adjustIconCentering()}else this.removeWidth(),this.setShowSuggestionsPanel(!1)},t.prototype._updateCategoryIconsAfterSelectorReady=function(n){var t=this;!this._mapTemplateSelector&&this._map?this._mapTemplateSelectorReadyEvent.addOne(function(){t._updateCategoryIcons(n)}):this._mapTemplateSelector&&this._updateCategoryIcons(n)},t.prototype._updateCategoryIcons=function(n){for(var f,i,e,u=this.getSuggestions(),o=n.select("[data-tag=as_img]"),t=0;t<u.length;t++)f=u[t].suggestion.primaryCategoryPath,f&&(i=it.extractCategoryId(f,!1),i&&(u[t].categoryId=i,e=r(o[t]),this._updateCategoryIconAfterDownload(i,e)))},t.prototype._updateCategoryIconAfterDownload=function(n,t){this._mapTemplateSelector.getCategoryIconTemplate(function(n){var i=n&&n.icon;i&&(t.clear(),t.remove_class("maps_search maps_business maps_address maps_skiarea maps_airport maps_searchsvg maps_businesssvg maps_addresssvg"),t.append(i.renderIcon()))},n,e.showXSRColors&&(h.isMapsVertical||e.isMobileShellAutosuggest)?null:br.black,30,30)},t.prototype._onVisibleChanged=function(n,t){if(r.Browser.is_ie&&n!==t){var u=!fu.showTaskBarL2Nav||this._asTextBox.getAttribute("placeholder")!==i.SearchGhostText;this.nearBySearchText=u&&this._asTextBox&&this._displayWaterMarkText?this._asTextBox.getAttribute("placeholder"):""}this.setShowNearBySearchText(this.nearBySearchText&&this.nearBySearchText!=="");this.removeWidth();this._visibilityChangedEvent&&this._visibilityChangedEvent.invoke(t)},t.prototype._applyAutoSuggestControlTemplateBinding=function(n,t){var f={templateText:this.templateId,staticResources:this},u,i;this._controlTemplate&&this._controlTemplate.dispose();this._controlTemplate=this._controlTemplateFactory(f);u=this._controlTemplate.applyDataTemplate(this);i=r(".as_container",n[0]);i&&i.removeFromParent();t===this._request.searchText&&(n.append(u),this.setShowSuggestionsPanel(!0))},t.prototype.setSuggestions=function(n){this._suggestions=n;this._instrumentationHelper&&this._instrumentationHelper.setRequestAndSuggestions(this._request,n)},t.prototype.setInstrumentationHelper=function(n){n&&(this._instrumentationHelper=n,this._autosuggestDataModel.setInstrumentationHelper(this._instrumentationHelper))},t.prototype.getSuggestions=function(){return this._suggestions},t.prototype.getSelectedSuggestion=function(){return this.selectedItemIndex>=0?this._suggestions[this.selectedItemIndex].suggestion:null},t.prototype.getFirstSuggestion=function(){return this._suggestions.length>0?this._suggestions[0].suggestion:null},t.prototype.dispose=function(){this._map=null;a._disposeEvents(this);a._clearDisposables(this._suggestions);n.prototype.dispose.call(this)},t.prototype._adjustIconCentering=function(){for(var n,u,f,i=r(".as_suggestion_root_inside"),t=0;t<i.length;t++)n=i[t],n&&(u=n.clientHeight,f=n.getElementsByClassName("as_img")[0],r(f).set_style({height:u}))},t}(ot),ur=function(){function n(n,t,i,u,f,o){var h=this,s=t[0];this._map=f;this._searchBoxContainer=n;this._instrumentationHelper=new ff(o);this._autosuggestViewModel=u;this._autosuggestViewModel.setAsTextBox(s);this._autosuggestViewModel.setInstrumentationHelper(this._instrumentationHelper);this._autosuggestViewModel.setCssClass(i+" as_container");i.indexOf("search")>-1&&(this._autosuggestViewModel.setId("as_containerSearch"),t&&t.length>0&&this._autosuggestViewModel.setAriaOwns(t[0].id));this._autosuggestViewModel.setMap(f);this.asTextBox=t;this._autosuggestViewModel.setIsSearchAlongRoute(!1);r(s).set_attr("autocorrect","off").set_attr("autocapitalize","off");this.attachEvents();e.enableSmartCompose&&(this._onUpdateSuggestions=new w,this._onUpdateSuggestions.add(function(){h.refreshAutosuggest()}),this._autosuggestViewModel.setRefreshSuggestionEvent(this._onUpdateSuggestions))}return n.prototype.stopAutosuggest=function(n){n===void 0&&(n=!0);this._removeGlobalEventHandlers();this._onAutosuggest&&this._onAutosuggest.invoke(!1);this._onFocusEvent&&this._onFocusEvent.invoke(!1);this._autosuggestViewModel.stopAutosuggestion();n&&this.asTextBox[0].blur()},n.prototype.removeEventHandlers=function(){this._onKeyDownHandler&&this.asTextBox.remove_event("keydown",this._onKeyDownHandler);this._onKeyDownHandler=null;this._onFocusHandler&&this.asTextBox.remove_event("focus",this._onFocusHandler);this._onFocusHandler=null;this._onClickHandler&&this.asTextBox.remove_event("click",this._onClickHandler);this._onClickHandler=null;this._onTextboxBlurHandler&&this.asTextBox.remove_event("blur",this._onTextboxBlurHandler);this._onTextboxBlurHandler=null;this._onInputChangeHandler&&this.asTextBox.remove_event("input",this._onInputChangeHandler);this._onInputChangeHandler=null},n.prototype.setItemSelectionEventHandler=function(n){this._autosuggestViewModel.setItemSelectionEventHandler(n)},n.prototype.setItemClickEventHandler=function(n){this._autosuggestViewModel.setItemClickEventHandler(n)},n.prototype.setSuggestionRequestHandler=function(n){this._suggestionRequestHandler=n},n.prototype.setFocusEventHandler=function(n){this._onFocusEvent=n},n.prototype.setClickEventHandler=function(n){this._onClickEvent=n},n.prototype.setAutosuggestKeydownHandler=function(n){this._onAutosuggestKeydown=n},n.prototype.setOnAutosuggestHandler=function(n){this._onAutosuggest=n},n.prototype.setAutosuggestBlurHandler=function(n){this._onAutosuggestBlur=n},n.prototype.getIsSearchAlongRoute=function(){return this._autosuggestViewModel&&this._autosuggestViewModel.getIsSearchAlongRoute()},n.prototype.setIsSearchAlongRoute=function(n){this._autosuggestViewModel&&this._autosuggestViewModel.setIsSearchAlongRoute(n)},n.prototype.instrumentSearchButtonClickEvent=function(){var n=this._autosuggestViewModel.getSelectedSuggestion(),t=6;n&&(t=5);this._instrumentationHelper&&this._instrumentationHelper.instrumentSearchEvent(this._getSearchTerm(),t,n)},n.prototype.refreshAutosuggest=function(){e.isEnabled&&this._updateSuggestions()},n.prototype.getConversationId=function(){return this._instrumentationHelper&&this._instrumentationHelper.getConversationId()},n.prototype.attachEvents=function(){var n=this;this._onKeyDownHandler||(this._onKeyDownHandler=function(t){return n._onKeyDown(t)},this.asTextBox.add_event("keydown",this._onKeyDownHandler));this._onFocusHandler||(this._onFocusHandler=function(){return n.onFocus()},this.asTextBox.add_event("focus",this._onFocusHandler));this._onClickHandler||(this._onClickHandler=function(){return n._onClick()},this.asTextBox.add_event("click",this._onClickHandler));this._onTextboxBlurHandler||(this._onTextboxBlurHandler=function(){return n._onBlur()},this.asTextBox.add_event("blur",this._onTextboxBlurHandler));this._onInputChangeHandler||(this._onInputChangeHandler=function(){return n._startAutosuggest()},this.asTextBox.add_event("input",this._onInputChangeHandler))},n.prototype._attachGlobalEvents=function(){var n=this;this._onWindowsBlurHandler||(this._onWindowsBlurHandler=function(t){t.target&&t.target.tagName!=="INPUT"&&document.activeElement&&document.activeElement.tagName!=="INPUT"&&!n._searchBoxContainer.has(t.target)&&n._onBlur()},r(window).add_event("blur,mousewheel,mousedown,touchmove",this._onWindowsBlurHandler));!this._onMapObjectBlurHandler&&this._map&&(this._onMapObjectBlurHandler=function(){return n._onBlur()},this._map.mapTapped.add(this._onMapObjectBlurHandler),this._map.mapPanStarted.add(this._onMapObjectBlurHandler))},n.prototype._removeGlobalEventHandlers=function(){this._onWindowsBlurHandler&&r(window).remove_event("blur,mousewheel,mousedown,touchmove",this._onWindowsBlurHandler);this._onWindowsBlurHandler=null;this._onMapObjectBlurHandler&&this._map&&(this._map.mapTapped.remove(this._onMapObjectBlurHandler),this._map.mapPanStarted.remove(this._onMapObjectBlurHandler),this._onMapObjectBlurHandler=null)},n.prototype.onFocus=function(){this._attachGlobalEvents();h.isMobile||e.enableSmartCompose||this.asTextBox.set_style({"background-color":"#fff"});this._onAutosuggest&&this._onAutosuggest.invoke(!0);this._onFocusEvent&&this._onFocusEvent.invoke(!0)},n.prototype._onClick=function(){this._onClickEvent&&this._onClickEvent.invoke()},n.prototype._onBlur=function(){h.isMapsVertical&&this.asTextBox.set_style({"background-color":"transparent"});this.stopAutosuggest();this._onAutosuggestBlur&&this._onAutosuggestBlur.invoke()},n.prototype._onKeyDown=function(n){var u=n,t=u.keyCode||u.which,i,f,o,r;t===38?(n.preventDefault(),this._autosuggestViewModel.selectPreviousItem()):t===40?(n.preventDefault(),this._autosuggestViewModel.selectNextItem()):t===27?(n.preventDefault(),this._autosuggestViewModel.stopAutosuggestion()):t===13?(i=this._autosuggestViewModel.getSelectedSuggestion(),e.enableSmartCompose&&!i&&(f=this._autosuggestViewModel.getCurrentSuggestion(),f&&(i=f.suggestion),this._autosuggestViewModel.logAutosuggestClientInst("SCQSS",t,this._getSearchTerm())),o=2,i&&(o=3),this._instrumentationHelper&&this._instrumentationHelper.instrumentSearchEvent(this._getSearchTerm(),o,i)):e.enableSmartCompose&&(r=this._getSearchTerm(),t===35||t===39?(this._autosuggestViewModel.completeCurrentQuery(),this._autosuggestViewModel.logAutosuggestClientInst("CMPL",t,r,this._getSearchTerm())):t===46?(this._autosuggestViewModel.hideQueryCompletion(),this._autosuggestViewModel.logAutosuggestClientInst("HID",t,r)):t===9?this._autosuggestViewModel.hasCompletionQuery()&&this._getSearchTerm()!==this._autosuggestViewModel.completePredictedQuery()?(n.preventDefault(),this._autosuggestViewModel.completeCurrentQuery(),this._autosuggestViewModel.logAutosuggestClientInst("CMPL",t,r,this._getSearchTerm())):this._autosuggestViewModel.logAutosuggestClientInst("TB",t,r):this._autosuggestViewModel.clearCurrentQueryCompletionState());this._onAutosuggestKeydown&&this._onAutosuggestKeydown.invoke(u)},n.prototype._startAutosuggest=function(){var n=this,t=function(){n.refreshAutosuggest()};Microsoft.Maps.setTimeout(t,0)},n.prototype._updateSuggestions=function(){var n={searchText:this._getSearchTerm(),userLocation:this._getUserLocation(),localMapView:this._getMapViewPort()};oi.categoryScopedAS&&!oi.isSDK&&this._autosuggestViewModel&&this._autosuggestViewModel.getIsSearchAlongRoute()&&(n.suggestionTypes=n.suggestionTypes&&n.suggestionTypes.length>0?",category":"category");this._suggestionRequestHandler&&this._suggestionRequestHandler.invoke(n);this._autosuggestViewModel.updateSuggestions(n,this._searchBoxContainer)},n.prototype._getMapViewPort=function(){if(this._map){var n=ni.getMapBounds(this._map),t=[n.getNorth(),n.getWest(),n.getSouth(),n.getEast()];return t.join(",")}return""},n.prototype._getUserLocation=function(){var n=h.dynamicProperties.location||h.dynamicProperties.reverseIPLocation;return n?n+",100":""},n.prototype._getSearchTerm=function(){return this.asTextBox[0].value},n}(),fr=function(){function n(){}return n.saveWaypoint=function(t){var u=t.getAddress(),i,r;if(u&&n._saveHistoryEnabled()){if(n.getWaypoints(),n.historyWaypoints.length)for(i=0;i<n.historyWaypoints.length;i++)if(r=n.historyWaypoints[i],r.getAddress().toLowerCase()===u.toLowerCase()&&r.getTitle().toLowerCase()===t.getTitle().toLowerCase()){n.historyWaypoints.splice(i,1);break}n.historyWaypoints.unshift(t);n.historyWaypoints.length>=n.Max_limit&&n.historyWaypoints.splice(n.Max_limit,n.historyWaypoints.length-n.Max_limit);n.commitChanges()}},n.getWaypoints=function(t){var f,e,r,o,u,s,h,i;if(!n._saveHistoryEnabled())return[];if((!n.historyWaypoints||n.historyWaypoints.length===0)&&(f=ct.getItem(n.SearchHistoryLocalStorageKey),n.historyWaypoints=[],f))for(e=f.split("$"),i=0;i<e.length;i++)r=e[i].split("|"),o=null,r[2].length>0&&r[3].length>0&&(o=new at(parseFloat(r[2]),parseFloat(r[3]))),u=new pi(r[0],r[1],"",null,o),n.historyWaypoints.push(u);if(!t||t.length===0)return n.historyWaypoints;for(t=t.toLowerCase(),s=[],h=[],i=0;i<n.historyWaypoints.length;i++){var u=n.historyWaypoints[i],c=u.getAddress(),l=u.getTitle(),a=c&&c.toLowerCase().indexOf(t),v=l&&l.toLowerCase().indexOf(t);a===0||v===0?h.push(u):Math.max(a,v)>0&&s.push(u)}return h.concat(s)},n.commitChanges=function(){var r,t;if(n.historyWaypoints.length>0){for(r="",t=0;t<n.historyWaypoints.length;t++){var i=n.historyWaypoints[t],u=i.getRoutableLocation(),f=u&&i.getLocationType()==="StreetAddress",e=n.SerializedWaypointFormat.replace("{title}",i.getTitle().replace(/[\|$]/g,"")).replace("{address}",i.getAddress().replace(/[\|$]/g,"")).replace("{lat}",f?u.latitude.toString():"").replace("{long}",f?u.longitude.toString():"");t!==n.historyWaypoints.length-1&&(e+="$");r+=e}ct.setItem(n.SearchHistoryLocalStorageKey,r)}},n.removeAll=function(){n._saveHistoryEnabled()&&(n.historyWaypoints=[],ct.removeItem(n.SearchHistoryLocalStorageKey))},n.isHistoryEnabled=function(){if(n._saveHistoryEnabled()){var t=ct.getItem(n.SaveSearchHistoryKey);return t==="0"?!1:!0}return!1},n.resetIsHistoryEnabled=function(t){n._saveHistoryEnabled()&&ct.setItem(n.SaveSearchHistoryKey,t?"1":"0")},n._saveHistoryEnabled=function(){return ct.isEnabled()&&!(e&&e.autosuggestHistory)},n.SearchHistoryLocalStorageKey="BingMapsSearchHistory",n.SaveSearchHistoryKey="BingMapsSaveSearchHistory",n.historyWaypoints=[],n.Max_limit=100,n.SerializedWaypointFormat="{title}|{address}|{lat}|{long}",n}(),ui=function(n){function t(t){var i=n.call(this,t&&t.suggestionTypes?t.suggestionTypes:"place,business,address")||this;return i._parseLocationFromAS=e.useAutosuggestLocationForDirections,i._useDefaultSuggestions=!0,i._useFavoriteSuggestions=!0,i._parseLocationFromAS=!0,i._setDefaultOptions(),i.updateOptions(t),i}return s(t,n),t.updateCurrentLocalDetailCards=function(n){t.localDetailCards=n},t.appendLocalDetailCards=function(n){t.localDetailCards=t.localDetailCards.concat(n)},t.resetCurrentLocalDetailsCards=function(){t.localDetailCards=[]},t.updateCurrentTransitStopCards=function(n){t.transitStopCards=n},t.prototype.updateOptions=function(n){n&&(this._options.suggestionTypes=n.suggestionTypes?n.suggestionTypes:this._options.suggestionTypes,this._options.showHistorySuggestions=typeof n.showHistorySuggestions=="boolean"?n.showHistorySuggestions:this._options.showHistorySuggestions,this._options.showDetailCards=typeof n.showDetailCards=="boolean"?n.showDetailCards:this._options.showDetailCards,this._options.showMyLocation=typeof n.showMyLocation=="boolean"?n.showMyLocation:this._options.showMyLocation,this._options.prevWaypoint=n.prevWaypoint!==undefined?n.prevWaypoint:this._options.prevWaypoint,this._options.dirMode=n.dirMode!==undefined?n.dirMode:this._options.dirMode,this._options.width=n.width!==undefined?n.width:0,this._options.maxHistoryWaypoints=typeof n.maxHistoryWaypoints=="number"?n.maxHistoryWaypoints:this._options.maxHistoryWaypoints,this._prevWaypoint=n.prevWaypoint?n.prevWaypoint:this._prevWaypoint,this._dirMode=n.dirMode?this._getDirMode(n.dirMode):this._dirMode)},t.prototype.update=function(n,t,i,r){n&&(this._prevWaypoint=n);this._dirMode=this._getDirMode(t);this.instrumentationHelper&&this.instrumentationHelper.createDirectionsInstrumentationData(this._dirMode,i,r)},t.prototype._setDefaultOptions=function(){this._options={suggestionTypes:"place,business,address",showHistorySuggestions:!e.autosuggestHistory,showDetailCards:!0,showMyLocation:!0,maxHistoryWaypoints:5}},t.prototype._getDirMode=function(n){var t="car";switch(n){case gt.transit:t="bus";break;case gt.walking:t="walk"}return t},t.prototype.getDefaultSuggestions=function(){var r,e,f,n,u;if(!this._useDefaultSuggestions)return[];if(r=[],this._options.showMyLocation&&(u=this.createSuggestion(i.L_MyLocation,null),r.push(u)),this._options.showDetailCards&&(t.localDetailCards||t.transitStopCards))for(e=Array.prototype.concat.apply(t.localDetailCards,t.transitStopCards),f=0;f<e.length;f++)n=e[f],n&&(u=this.createSuggestion(n.getTitle(),n.getDescription(),n.getRoutableLocation(),n.id,n.getPrimaryCategoryPath(),!!n.getLocationType()),r.push(u));return r},t.prototype.addExtraASParams=function(n,t){if(this._dirMode&&(n+="&cmdir="+this._dirMode),this._prevWaypoint){n+="&ctx=to";var i=this._prevWaypoint.point;i&&(n+="&clFrom="+i.latitude.toString()+","+i.longitude.toString());this._prevWaypoint.eid&&(n+="&ceFrom="+this._prevWaypoint.eid);this._prevWaypoint.type&&(n+="&ccFrom="+this._prevWaypoint.type)}else n+="&ctx=from";return e.autosuggestHistory&&(n=n.replace("{histcnt}",e.autosuggestDirectionsMaxHistCount.toString()),n=n.replace("{favcnt}",t.searchText?e.autosuggestDirectionsMaxFavCount.toString():"")),n},t.prototype.createSuggestion=function(n,t,i,r,u,f){var e={defaultSuggestion:!0,title:n,formatedAddress:t,location:i,entityId:r,primaryCategoryPath:u,type:"Default"};return f&&(e.type="Place"),e},t.prototype.getHistorySuggestions=function(n){var r,u,t,i,f;if(this._options&&!this._options.showHistorySuggestions)return[];for(r=[],u=fr.getWaypoints(n),t=0;t<Math.min(u.length,this._options.maxHistoryWaypoints);t++)i=u[t],i&&(f=this.createSuggestion(i.getTitle(),i.getAddress()),f.type=li.HistorySuggestionType,r.push(f));return r},t.prototype.getMaxResults=function(){return e.autosuggestDirectionsMaxResults},t.localDetailCards=[],t}(ri),of=function(n){function t(){return n.call(this)||this}return s(t,n),t.prototype.getDefaultSuggestions=function(){var r,u,t,n;if(!this._useDefaultSuggestions)return[];if(r=[],this._options.showMyLocation&&(n={},n.title=i.L_MyLocation,n.defaultSuggestion=!0,r.push(n)),ui.localDetailCards)for(u=0;u<ui.localDetailCards.length;u++)t=ui.localDetailCards[u],t&&(n=this.createSuggestion(t.getTitle(),t.getDescription(),t.getRoutableLocation(),t.id),r.push(n));return r},t}(ui),sf=function(n){function t(t,i,u,f,e,o){var s=n.call(this,t,i,u,f,e)||this;return s._backButton=o,s._rootContainer=r("#container"),s.attachEvents(),s}return s(t,n),t.prototype.stopAutosuggest=function(){n.prototype.stopAutosuggest.call(this);this._onBackButtonClick(null)},t.prototype.removeEventHandlers=function(){n.prototype.removeEventHandlers.call(this);this._onBackButtonClickHandler&&this._backButton&&this._backButton.remove_event("click",this._onBackButtonClickHandler)},t.prototype.attachEvents=function(){var t=this;n.prototype.attachEvents.call(this);!this._onBackButtonClickHandler&&this._backButton&&(this._onBackButtonClickHandler=function(n){return t._onBackButtonClick(n)},this._backButton.add_event("click",this._onBackButtonClickHandler))},t.prototype._onBackButtonClick=function(n){this.asTextBox.remove_class("focused");this.asTextBox.set_style({width:null});this._rootContainer.remove_class("hideAll");n&&n.preventDefault();n&&n.stopPropagation()},t.prototype.onFocus=function(){var i,r;n.prototype.onFocus.call(this);this.asTextBox.add_class("focused");i=parseInt(this._backButton.get_style("width").replace("px",""));this.asTextBox.set_style({width:window.innerWidth-i-t.focusedInputboxMargin+"px"});this._rootContainer.add_class("hideAll");r={action:"updateLayout",state:{layoutType:"expandCard"}};f.invokeHandler(u.layoutDataHandlerKey,r)},t.focusedInputboxMargin=16,t}(ur),hf=function(n){function t(){var t=n.call(this)||this;return t._defaultSuggestions=[],t._useFavoriteSuggestions=!0,t}return s(t,n),t.prototype.updateDefaultSuggestions=function(n,t){this._defaultSuggestions=n;this._mapBounds=t;this._useDefaultSuggestions=!0;this._useFavoriteSuggestions=!1},t.prototype.clearDefaultSuggestions=function(){this._defaultSuggestions=[];this._mapBounds=null;this._useDefaultSuggestions=!1;this._useFavoriteSuggestions=!0},t.prototype.getDefaultSuggestions=function(){var r=[],t,i,n;if(this._defaultSuggestions&&this._useDefaultSuggestions)for(t=0;t<this._defaultSuggestions.length;t++)i=this._defaultSuggestions[t],i&&(n={},n.defaultSuggestion=!0,n.title=i,n.searchText=i,n.mapBounds=this._mapBounds,r.push(n));return r},t.prototype.getMaxResults=function(){return e.autosuggestSearchBoxMaxResults},t}(ri),bi=function(n){function t(t,r,u,f,e,o,s,h,c,l,a,v){var y,p,b,w,k,d;return l===void 0&&(l=!1),a===void 0&&(a=!1),y=this,p={},y=n.call(this,p)||this,y._map=r,y._container=u,y._label=f,y._message=e,y._calendarSync=t,y.resources=i,b=r.getContainer(),y._showDateTimeOnLabel=!1,y.updatingStartTime=!1,y.updatingEndTime=!1,y._startCalendar=null,y._endCalendar=null,y.OneMinute=6e4,y.OneHour=36e5,y.TwentyFourHours=864e5,y.ElevenFiftyFivePm=1435*y.OneMinute,y._allowPastTimes=l,y._userUtcOffset=-(new Date).getTimezoneOffset(),h&&(y._utcOffset=h,y._userUtcOffset===y._utcOffset||c||(y._displayLocalTime=!0,o&&!isNaN(o)&&(o+=(y._utcOffset-y._userUtcOffset)*y.OneMinute),s&&!isNaN(s)&&(s+=(y._utcOffset-y._userUtcOffset)*y.OneMinute))),p.defineProperty("hasPresetStartEndTime"),p.defineProperty("startDate",y._onStartDateTimeChanged),p.defineProperty("startTime",y._onStartDateTimeChanged),p.defineProperty("endDate",y._onEndDateTimeChanged),p.defineProperty("endTime",y._onEndDateTimeChanged),p.defineProperty("calendarType",y._onCalendarTypeChanged),p.defineProperty("isAllDayEvent",y._onIsAllDayEventChanged),p.defineProperty("startEditingTime"),p.defineProperty("endEditingTime"),p.defineProperty("showStartCalendarSelector"),p.defineProperty("showEndCalendarSelector"),p.defineProperty("showEndCalendar"),p.defineProperty("showEndTimeLink"),p.defineProperty("timeControlDisabled"),p.defineProperty("showTimeZoneDisclaimer"),p.defineProperty("showStartEndTimeLinks"),p.defineProperty("startTaskId"),p.defineProperty("endTaskId"),y._prePopulateCalendarTypeDropdowns(),y.startDateTime=y.endDateTime=i.L_CalendarSync_SelectDateTime,y.setShowStartCalendarSelector(!1),y.setShowEndCalendarSelector(!1),y.setHasPresetStartEndTime(a),y.setShowStartEndTimeLinks(!a),y.setShowEndCalendar(s&&!isNaN(s)?!0:!1),y.setShowEndTimeLink(!1),y.setTimeControlDisabled(!1),y.setIsAllDayEvent(!1),y.setShowTimeZoneDisclaimer(y._displayLocalTime),v&&(y.setStartTaskId(v+"Start"),y.setEndTaskId(v+"End")),c&&o&&!isNaN(o)&&(y.setIsAllDayEvent(!0),y.setTimeControlDisabled(!0),o=Math.floor(o/y.TwentyFourHours)*y.TwentyFourHours,o-=y._userUtcOffset*y.OneMinute,s&&!isNaN(s)?(s=Math.floor(s/y.TwentyFourHours)*y.TwentyFourHours,s-=y._userUtcOffset*y.OneMinute,s===o&&(s=s+y.ElevenFiftyFivePm)):s=o+y.ElevenFiftyFivePm),w=new Date,o&&!isNaN(o)?(w=new Date(o),y._setDateAndTime(o,!1,!1)):y._setDateAndTime(w.getTime(),!1,!0),s&&!isNaN(s)?y._setDateAndTime(s,!0,!1):(k=!(o&&!isNaN(o)),w.setHours(w.getHours()+1),y._setDateAndTime(w.getTime(),!0,k)),d={boolToDisplay:function(n){return y.boolToDisplay(n)},addPrefixSpace:function(n){return y.addPrefixSpace(n)}},u&&b&&b.instanceAsync("ControlTemplate",function(n){var t=n.applyDataTemplate(y);t.appendTo(u);y._addCalendar(t,o)},{templateText:tr,staticResources:d}),f.add_event("click",function(n){y._onLabelClick(n)}),y._showHideCalendarSyncControl(!1||y.getHasPresetStartEndTime()),y}return s(t,n),t.prototype.addPrefixSpace=function(n){return n&&n.charAt(n.length-1)!==" "?n.concat(" "):n},t.prototype.adjustEndTime=function(){if(!this.updatingEndTime){this.updatingEndTime=!0;var i=t.getDate(this.getStartDate(),this.getStartTime()),n=new Date(this.getStartDate()+this.getStartTime()*1e3);n.setTime(n.getTime()+this.OneHour);this.setEndTime(t.getTimeInSeconds(n));n.setHours(0,0,0,0);this.setEndDate(n.getTime());this.endDateTime=t.formatDateTimeString(this.getEndDate(),this.getEndTime(),this.getIsAllDayEvent());this._endCalendar&&this._endCalendar.SetDate(this.getEndDate());this.updatingEndTime=!1}},t.prototype._onStartDateTimeChanged=function(){var n,i,r;this.updatingStartTime||(this.updatingStartTime=!0,n=new Date(Date.now()),i=t.getDate(this.getStartDate(),this.getStartTime()),!this._allowPastTimes&&i<n&&(this.setStartTime(n.getHours()*this.OneHour),this.setStartDate(n.getTime())),this.startDateTime=t.formatDateTimeString(this.getStartDate(),this.getStartTime(),this.getIsAllDayEvent()),this.updatingStartTime=!1,r=t.getDate(this.getEndDate(),this.getEndTime()),(r<i||!this.getShowEndCalendar())&&this.adjustEndTime(),this._showHideMessage(!1))},t.prototype._onEndDateTimeChanged=function(){if(!this.updatingEndTime){var n=t.getDate(this.getStartDate(),this.getStartTime()),i=t.getDate(this.getEndDate(),this.getEndTime());i<n&&this.adjustEndTime();this.endDateTime=t.formatDateTimeString(this.getEndDate(),this.getEndTime(),this.getIsAllDayEvent());this._showHideMessage(!1)}},t.prototype._onCalendarTypeChanged=function(){this._message.set_style({display:"none"})},t.prototype._onIsAllDayEventChanged=function(){this.setTimeControlDisabled(this.getIsAllDayEvent());this.startDateTime=t.formatDateTimeString(this.getStartDate(),this.getStartTime(),this.getIsAllDayEvent());this.endDateTime=t.formatDateTimeString(this.getEndDate(),this.getEndTime(),this.getIsAllDayEvent())},t.prototype._setDateTimeToLabel=function(){this._calendarSync.getPermalink()},t.prototype._addCalendar=function(n,t){var i=this,u=this._map.getContainer(),e=n.select(".calendarSyncStartDate"),o,f,s;e&&u&&u.instanceAsync("SingleCalendar",function(n){i._startCalendar=n;n.init(e,t);n.onDateChangeEvent.add(function(n){n.setHours(0,0,0,0);i.setStartDate(n.getTime())})});o=t;f=n.select(".calendarSyncEndDate");f&&u&&u.instanceAsync("SingleCalendar",function(n){i._endCalendar=n;n.init(f,o);n.onDateChangeEvent.add(function(n){n.setHours(0,0,0,0);i.setEndDate(n.getTime())})});this.getHasPresetStartEndTime()&&(s=this._container.select(".dropdownEntry"),s.for_each(function(n){var t=r(n);t.add_event("click",function(n){var t=n.target.attributes.getNamedItem("data-dropdown").nodeValue;i.setCalendarType(i.calendarTypes[t]);i.onExportClick(n)})}))},t.prototype.onStartTimeClick=function(n){n.preventDefault();n.stopPropagation();this.setShowStartCalendarSelector(!this.getShowStartCalendarSelector());this.getShowStartCalendarSelector()&&(this.getShowEndCalendar()||this.setShowEndTimeLink(!0),this.setShowEndCalendarSelector(!1),this._calendarSync.log("C","STC"))},t.prototype.onEndTimeClick=function(n){n.preventDefault();n.stopPropagation();this.setShowEndCalendarSelector(!this.getShowEndCalendarSelector());this.getShowEndCalendarSelector()&&(this.setShowStartCalendarSelector(!1),this.setShowEndTimeLink(!1),this._calendarSync.log("C","ETDD"))},t.prototype.onEndTimeLinkClick=function(n){n.preventDefault();n.stopPropagation();this.getShowEndTimeLink()&&(this.setShowStartCalendarSelector(!1),this.setShowEndTimeLink(!1),this.setShowEndCalendar(!0),this.setShowEndCalendarSelector(!0),this._calendarSync.log("C","ETL"))},t.prototype.onExportClick=function(n){var t=this;n.preventDefault();n.stopPropagation();this.setStartEditingTime(!1);this.setEndEditingTime(!1);this.setShowEndCalendarSelector(!1);this.setShowStartCalendarSelector(!1);this.setShowEndCalendar(!0);this.setShowEndTimeLink(!1);this._calendarSync.log("S",this.getCalendarType().value.toString(),this._calendarSync.getEntityInfoForLogging());this._calendarSync.logIn(this.getCalendarType().value,function(){var r=t.getStartDate()+t.getStartTime()*1e3,n=t.getEndDate()+t.getEndTime()*1e3,u,f;t._displayLocalTime&&(r-=(t._utcOffset-t._userUtcOffset)*t.OneMinute,n-=(t._utcOffset-t._userUtcOffset)*t.OneMinute);t.getIsAllDayEvent()&&(t._utcOffset?(r+=t._utcOffset*t.OneMinute,n+=t._utcOffset*t.OneMinute):t._userUtcOffset&&(r+=t._userUtcOffset*t.OneMinute,n+=t._userUtcOffset*t.OneMinute),n+=t.TwentyFourHours);u=new Date(r);f=new Date(n);r>=n?(t._updateCalendarText(a._formatString(i.L_CalendarSync_StartEndDateError),!1,!0),t._calendarSync.log("ERR",t.getCalendarType().value.toString(),"Start Date greater End Date Mismatch")):t._calendarSync.createEvent(u,f,t.getIsAllDayEvent(),t._calendarSync.entity,function(){t.getCalendarType().value!==2?t._updateCalendarText(a._formatString(i.L_CalendarSync_Message,t.getCalendarType().text),!0):t._updateCalendarText(a._formatString(i.L_CalendarSync_ICS_Downloaded),!0)},function(){t._updateCalendarText(a._formatString(i.L_CalendarSync_APIErrorMessage),!1,!0);t._calendarSync.log("ERR",t.getCalendarType().value.toString(),"Login Failed")})},function(){t._updateCalendarText(a._formatString(i.L_CalendarSync_LoginErrorMessage),!1,!0)})},t.prototype._updateCalendarText=function(n,t,i){this._message.set_html(a._formatString(n));(t||i)&&(t?this._message.remove_class("failureMessage").add_class("successMessage"):this._message.remove_class("successMessage").add_class("failureMessage"));this._showHideMessage(!0)},t.prototype._onLabelClick=function(n){var t,i;n.stopPropagation();n.preventDefault();t=this._container?this._container.get_style("display")==="none":!1;t&&this._calendarSync.getPermalink();this._container&&this._showHideCalendarSyncControl(t);i=r(".calendarSyncLabel");i&&i.length>0&&i[0].setAttribute("aria-expanded",t);this._showHideMessage(!1);this._calendarSync.preAuth();this._calendarSync.log("A")},t.prototype._setDateAndTime=function(n,t,i){var r=new Date(n),u,f;i&&r.setHours(r.getHours()+1,0,0,0);u=r.getHours()*3600+r.getMinutes()*60+r.getSeconds()*60;t?this.setEndTime(u):this.setStartTime(u);r.setHours(0,0,0,0);f=r.getTime();t?this.setEndDate(f):this.setStartDate(f);t||!this._calendarSync.entity||this._calendarSync.entity.getDateTime&&this._calendarSync.entity.getDateTime()||this._calendarSync.entity.setDateTime(n)},t.prototype.getStartDateTime=function(){return this.getStartDate()+this.getStartTime()*1e3},t.prototype._prePopulateCalendarTypeDropdowns=function(){this.calendarTypes=[{text:i.L_CalendarSync_Outlook,value:0},{text:i.L_CalendarSync_Google,value:1},{text:i.L_CalendarSync_OutlookDesktop,value:2}];this.setCalendarType({text:i.L_CalendarSync_Outlook,value:0})},t.prototype._showHideCalendarSyncControl=function(n){this._container&&this._container.set_style({display:n?"block":"none"});var t="expandArrow",i="collapseArrow";n?(this._label.add_class(i),this._label.remove_class(t)):(this._label.add_class(t),this._label.remove_class(i))},t.prototype._showHideMessage=function(n){this._message.set_style({display:n?"inline":"none"})},t.getDate=function(n,i){return new Date(t.getDateInMilliseconds(n,i))},t.getDateInMilliseconds=function(n,t){return n+t*1e3},t.formatDateTimeString=function(n,t,i){return i?a._formatLongDateString(new Date(n)):a._formatLongDateString(new Date(n))+" "+a._formatUTCTimeString(new Date(t*1e3))},t.getTimeInSeconds=function(n){return n.getHours()*3600+n.getMinutes()*60+n.getSeconds()},t}(wt),cf=function(){function n(n){this._clientId=nt.gCalClientId;this._scopes=nt.gCalScopes;this.loggedIn=!1;this._calendarSync=n;this._addRemoteAPIScript()}return n.getInstance=function(t){return n._instance||(n._instance=new n(t)),n._instance},n.prototype.logOut=function(){gapi.auth.signOut();this.loggedIn=!1},n.prototype.logIn=function(n,t){var i=this;gapi.auth.authorize({client_id:this._clientId,scope:this._scopes,immediate:!1},function(r){return i._handleAuthenticationResult(r,n,t)})},n.prototype.preAuth=function(n){n&&n()},n.prototype._addRemoteAPIScript=function(){window.AM&&window.AM.push("google.com");var t=document.head,n=document.createElement("script");n.type="text/javascript";n.src=nt.gCalApiSource;t.appendChild(n)},n.prototype._handleAuthenticationResult=function(n,t,i){n&&!n.error?(gapi.client.load("calendar",nt.gCalVersion,function(){t&&t()},function(){i&&i()}),this.loggedIn=!0):i&&i()},n.prototype.createOrUpdateEvent=function(n,t,i){this.createNewEvent(n,t,i)},n.prototype.createNewEvent=function(n,t,i){var r=this,u=this._parseEvent(n);gapi.client.load("calendar",nt.gCalVersion,function(){var n=gapi.client.calendar.events.insert({calendarId:"primary",resource:u});n.execute(function(n){n.error?i&&i():(r._calendarSync.createdEventIdGoogle=n.id,t&&t())})})},n.prototype.updateEvent=function(n,t,i,r){var u=this,f=this._parseEvent(n);gapi.client.load("calendar",nt.gCalVersion,function(){var n=gapi.client.calendar.events.update({calendarId:"primary",eventId:t,resource:f});n.execute(function(n){n.error?r&&r():(u._calendarSync.createdEventIdGoogle=n.id,i&&i())})})},n.prototype._parseEvent=function(n){return n.isAllDayEvent?{summary:n.title,location:n.location,description:n.description,start:{date:n.eventStart},end:{date:n.eventEnd}}:{summary:n.title,location:n.location,description:n.description,start:{dateTime:n.eventStart},end:{dateTime:n.eventEnd}}},n.prototype.getEventsByDateRange=function(n,t,i,r){var u=gapi.client.calendar.events.list({calendarId:"primary",timeMin:n,timeMax:t,maxResults:20,singleEvents:!0,orderBy:"startTime"});u.execute(function(n){n.error?r&&r():i&&i()})},n}(),lf=function(){function n(){this._store=window.sessionStorage}return n.prototype.set=function(n,t){this._store.setItem(n,t)},n.prototype.get=function(n){return this._store.getItem(n)},n.prototype.clear=function(){this._store.clear()},n.prototype.remove=function(n){this._store.removeItem(n)},n}(),af=function(){function n(){}return n}(),vf=function(n){function t(t){var i=this,r={};return i=n.call(this,r)||this,i._store=new lf,i._config=nt,i._calendarSync=t,r.defineProperty("isSignedIn",function(n,t){return i._onSignInStateChange(n,t)}),i._consumersPayloadTypeId="9188040d-6c67-4c5b-b112-36a304b66dad",i._silentAuthUrl="{authUrl}&prompt=none&domain_hint={userDomainType}&login_hint={userSigninName}",i._issuerTenantId="https://login.microsoftonline.com/{payloadTid}/v2.0",i.isUserSignedIn()||i.clearUserState(),i}return s(t,n),t.prototype.CreateMapsAuthCallback=function(){var i=this,t=this,n=this._store;return function(r){if(r.accessToken&&r.idToken){n.remove("accessToken");n.remove("idToken");var u=n.get("authState");if(r.state!==u){n.remove("authState");n.remove("authNonce");return}n.set("authState","");n.set("accessToken",r.accessToken);n.set("tokenExpires",r.expires);n.set("idToken",r.idToken);t.validateIdToken(function(n){var u,f,r;n?(i.setIsSignedIn(!0),sj_evt&&sj_evt.fire("wl:auth"),Identity&&Identity.wlProfile&&Identity.popupLoginUrls&&(u=Identity.popupLoginUrls,u&&(f=u.WindowsLiveId,f&&(r=document.createElement("iframe"),r.style.display="none",r.src=f+"&checkda=1",document.body.appendChild(r))))):t.clearUserState();t._authCallback&&t._authCallback(n)})}else t.clearUserState(),t.getCalendarSync().log("ERR",0..toString(),r.error)}},t.prototype.isAuthenticated=function(){if(!this.isUserSignedIn())return this.clearUserState(),!1;var n=this._store.get("accessToken");return n!==null&&n.length>0},t.prototype.getCalendarSync=function(){return this._calendarSync},t.prototype.retrieveEmailIfSignedIn=function(){var n=this;this.isUserSignedIn()&&this.getSignedInUserEmail(function(t){t&&n._store.set("WindowsLiveEmail",t)})},t.prototype.isUserSignedIn=function(){return typeof Identity!="undefined"&&Identity.wlProfile&&Identity.wlProfile()!==null},t.prototype.dispose=function(){if(this._disposables){for(var n=0;n<this._disposables.length;n++)this._disposables[n].dispose();this._disposables=null}},t.prototype.sendInvite=function(n,t){var i=this;this.getUserEmailAddress(function(r,u){u?t&&t(!1):i.sendCalendarInvite(r,n,function(n,i){i||t&&t(!0)})})},t.prototype.addDays=function(n,t){var i=new Date(n.valueOf());return i.setDate(i.getDate()+t),i},t.prototype.addHours=function(n,t){var i=new Date(n.valueOf());return i.setTime(i.getTime()+t*36e5),i},t.prototype._onSignInStateChange=function(n,t){this.notifySignedIn&&this.notifySignedIn.invoke(t)},t.prototype.buildAuthUrl=function(){var u=this.guid(),f=this.guid(),n,t,i,r;this._store.set("authState",u);this._store.set("authNonce",f);n={};n.response_type="id_token token";n.client_id=this._config.appId;n.redirect_uri=this._config.authorizationRedirectUrl;n.scope=this._config.scopes.replace("+"," ");n.state=u;n.nonce=f;n.response_mode="fragment";t=this._config.authorizationEndpointBase+this._config.authorizationEndpoint;i=0;for(r in n)t+=r+"="+n[r]+"&",i++;return i>1&&(t=t.slice(0,-1)),t},t.prototype.popupAuthenticate=function(n,t){var i=this.buildAuthUrl(),f=this._store.get("WindowsLiveEmail"),u,r;this.isUserSignedIn()&&t?(u=this._store.get("userDomainType"),r=this._store.get("userSigninName"),r=r||f,u=u||"consumers",r&&(i=this._silentAuthUrl.replace("{authUrl}",i).replace("{userDomainType}",u).replace("{userSigninName}",r),this.openPopupAuthWindow(i,n))):t?n&&n(!1):(this.isUserSignedIn()&&f&&(i=i+"&login_hint="+f),this.openPopupAuthWindow(i,n))},t.prototype.openPopupAuthWindow=function(n,t){this._authPopupWindow=window.open(n,"_blank","resizable,scrollbars,status");t&&(this._authCallback=t)},t.prototype.validateIdToken=function(n){var u=this._store.get("idToken"),c=this._store.get("authNonce"),i,o,t,f;if(null===u||u.length<=0){n(!1);return}if(i=u.split("."),i.length!==3){n(!1);return}if(o=r.Internals.parseJSON(atob(i[0])),t=r.Internals.parseJSON(atob(i[1])),t.nonce!==this._store.get("authNonce")){this._store.set("authNonce","");n(!1);return}if(t.aud!=this._config.appId){n(!1);return}if(f=this._issuerTenantId.replace("{payloadTid}",t.tid),t.iss!==f){n(!1);return}var e=new Date,s=new Date((t.nbf-300)*1e3),h=new Date((t.exp+300)*1e3);if(e<s||e>h){n(!1);return}this._store.set("userDisplayName",t.name);this._store.set("userSigninName",t.preferred_username);this._store.set("userDomainType",t.tid===this._consumersPayloadTypeId?"consumers":"organizations");n(!0)},t.prototype.makeSilentTokenRequest=function(n){var t=this;this.popupAuthenticate(function(i){i&&n&&n(t._store.get("accessToken"))},!0)},t.prototype.getAccessToken=function(n){var i=this._store.get("tokenExpires"),t=this._store.get("accessToken"),r=Date.now(),u=r>parseInt(i);t&&!u?n&&n(t):this.makeSilentTokenRequest(n)},t.prototype.makeApiCall=function(n,t){var i={Authorization:"Bearer "+n.token,"client-request-id":this.guid(),"return-client-request-id":"true"},r;n.email&&(i["X-AnchorMailbox"]=n.email);n.method==="POST"&&(i["Content-Type"]="application/json",i.Accept="application/json");r={url:n.url,dataType:"json",type:n.method,headers:i};n.query&&(r.data=n.query);this.makeRequest(r,t)},t.prototype.makeRequest=function(n,t){n.type==="POST"?(n.onSuccess=function(n){t(n)},n.onError=function(n,i,r){i>400||!n?t(null,r+","+n):r==="Created"?t(n):t(null,r+","+n)},ft.doPost(n.url,n.data,n)):ft.downloadJson(n.url,"tokens",function(n){t(n)},function(n,i,r){t(null,r)},n,!1,0,!0,n.headers)},t.prototype.getSignedInUserEmail=function(n){this.isUserSignedIn()?ft.downloadGeneric(this._config.emailEndpoint,"email",function(t){n&&n(t)},null,function(){n&&n(null)}):n&&n(null)},t.prototype.getUserEmailAddress=function(n){var t=this,i=this._store.get("userEmail");if(i)return i;this.getAccessToken(function(i){var r,u;i?(r={url:t._config.apiEndpoint+"/Me",token:i,method:"GET"},t.makeApiCall(r,function(t,i){i||!t?n(null,i):n({email:t.EmailAddress,name:t.DisplayName})})):(u={responseText:"Could not retrieve access token"},n(null,u))})},t.prototype.sendCalendarInvite=function(n,t,i){var r=this,u=n.email,e=n.name,f=t.isAllDayEvent?Intl.DateTimeFormat().resolvedOptions().timeZone:"UTC",o='{"Subject": "'+t.title+'","Location":{"DisplayName": "'+t.location+'"},"Body": {"ContentType": "HTML","Content": "'+t.description+'" },"Start": {"DateTime": "'+t.eventStart+(t.isAllDayEvent?"T00:00:00":"")+'", "TimeZone": "'+f+'"}, "End": { "DateTime": "'+t.eventEnd+(t.isAllDayEvent?"T00:00:00":"")+'", "TimeZone": "'+f+'"}, "IsAllDay": '+t.isAllDayEvent+', "Attendees": [{"EmailAddress": {"Address": "'+u+'", "Name": "'+e+'" }, "Type": "Required" } ]}';this.getAccessToken(function(n){var t,f;n?(t={url:r._config.apiEndpoint+"/Me/events",token:n,method:"POST",email:u,query:o},r.makeApiCall(t,function(n,t){t?i(null,t):i(n.value)})):(f={responseText:"Could not retrieve access token"},i(null,f))})},t.prototype.guid=function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(n){var t=Math.random()*16|0,i=n=="x"?t:t&3|8;return i.toString(16)})},t.prototype.decodePlusEscaped=function(n){return n?decodeURIComponent(n.replace(/\+/g," ")):""},t.prototype.clearUserState=function(){this._store.clear();this.setIsSignedIn(!1)},t.prototype.formatDate=function(n){var t=new Date(n);return t.toLocaleDateString()+" "+t.toLocaleTimeString()},t}(ot),yf=function(){function n(n){this.loggedIn=!1;this._calendarSync=n;this._calendarHelper=new vf(n);window.MapsAuthCallback=this._calendarHelper.CreateMapsAuthCallback()}return n.getInstance=function(t){return n._instance||(n._instance=new n(t)),n._instance},n.prototype.createOrUpdateEventWithAPI=function(n,t,i){this._calendarSync.createdEventIdO365?this.updateEvent(n,this._calendarSync.createdEventIdO365,t,i):this.createNewEvent(n,t,i)},n.prototype.createOrUpdateEvent=function(n,t,i){var r=this;this._calendarHelper.popupAuthenticate(function(u){u?(r._writeInviteToCalendar(n),t&&t()):i&&i()})},n.prototype._writeInviteToCalendar=function(n){var i=new Date,t=this._calendarHelper;t.sendInvite(n,function(){})},n.prototype.createNewEvent=function(n,t,i){this.createOrUpdateEvent(n,t,i)},n.prototype.updateEvent=function(n,t,i,r){this.createOrUpdateEvent(n,i,r)},n.prototype._parseEvent=function(n){return JSON.stringify({Subject:n.title,Body:{ContentType:"HTML",Content:n.description},Location:{DisplayName:n.location},Start:n.eventStart,End:n.eventEnd})},n.prototype.logIn=function(n){n&&n()},n.prototype.preAuth=function(){this._calendarHelper.retrieveEmailIfSignedIn()},n.prototype.logOut=function(){this.loggedIn=!1},n.prototype.getEventsByDateRange=function(n,t,i,r){r&&r()},n}(),pf=function(){function n(){this.loggedIn=!0}return n.getInstance=function(t){return n._instance||(n._instance=new n(t)),n._instance},n.prototype.logIn=function(n){n&&n()},n.prototype.logOut=function(){},n.prototype.preAuth=function(n){n&&n()},n.prototype.createOrUpdateEvent=function(n,t){var r="BEGIN:VCALENDAR\nVERSION:2.0\nBEGIN:VEVENT\nSUMMARY:"+n.title+"\nDESCRIPTION:"+n.description+"\nLOCATION:"+n.location+"\nDTSTART;"+(n.isAllDayEvent?"VALUE=DATE:":"TZID=UTC:")+n.eventStart+"\nDTEND;"+(n.isAllDayEvent?"VALUE=DATE:":"TZID=UTC:")+n.eventEnd+"\nEND:VEVENT\nEND:VCALENDAR",u,i;window.navigator.msSaveOrOpenBlob?(u=new Blob([r]),window.navigator.msSaveOrOpenBlob(u,n.title+".ics")):(i=document.createElement("a"),i.href="data:text/calendar;charset=utf-8,"+encodeURIComponent(r),i.setAttribute("download",n.title+".ics"),document.body.appendChild(i),i.click(),document.body.removeChild(i));t&&t()},n.prototype.updateEvent=function(){},n.prototype.getEventsByDateRange=function(){},n}(),wr=function(){function n(n,t,i,r,u,f,e){var o=this;this.APIs={};this._hasCalendarCustomizations=!1;this.localSearchTaskConfigs=e;n.getContainer()&&n.getContainer().instanceAsyncAll([{name:"Permalink"},{name:"TaskManager"}],function(e){if(o.permalinkAPI=e.Permalink,o.taskManager=e.TaskManager,t){var s=t.get_attr("startDate"),h=t.get_attr("endDate"),c=s?Date.parse(s):null,l=h?Date.parse(h):null;o._hasCalendarCustomizations=s?h?!0:!1:!1;o._calendarSyncViewModel=f?new bi(o,n,t,i,r,c?c:f.getDateTime(),l?l:f.getEndDateTime(),f.getUtcOffset(),f.getIsAllDayEvent(),!0,o._hasCalendarCustomizations,u):new bi(o,n,t,i,r,c,l,null,null,!1,o._hasCalendarCustomizations,u)}});this.map=n;this.entity=f;this.taskId=u;nt.saveIntoCalendar&&(this.APIs[1]=cf.getInstance(this),this.APIs[2]=pf.getInstance(this),this.APIs[0]=yf.getInstance(this))}return n.prototype.logOut=function(){this.selectedAPI.logOut()},n.prototype.logIn=function(n,t,i){this.selectedAPI=this.APIs[n];this.currentCalendarType=n;this.selectedAPI&&(this.selectedAPI.loggedIn?t():this.selectedAPI.logIn(t,i))},n.prototype.preAuth=function(n,t){this.APIs[0].preAuth(n,t)},n.prototype.getPermalink=function(n){var t=this;this.permalinkAPI.getGeneralPermalink(this.map,function(i){if(i){var r=i.permalink;t._permalink=r.toLowerCase().indexOf("form=")!=-1?r.replace(/(form=).*?(&|$)/,"$1"+nt.formCode+"$2"):r+"&form="+nt.formCode;t.permalinkAPI.shorten(function(i){i&&(t._shortLink=i);n&&n()},function(){t.log("ERR","Permalink Shortening","Error while shortening permalink");t._shortLink=null;n&&n()},null,nt.formCode)}},function(){t.log("ERR","Permalink Generation","Error while building permalink");t._permalink=nt.defaultPermalink},null,!0)},n.prototype.createEvent=function(n,t,r,u,f,e){var l=this,h,c,s,o;u&&(h=u.getTitle(),h||(h=u.getAddress()),c=u.getAddress(),c||(c=u.getTitle()),s=this._hasCalendarCustomizations,o=new af,o.title=s?i.L_CalendarSync_OpenHouse_Subject+h:h,o.location=c,r?(o.eventStart=n.toISOString().substring(0,10),o.eventEnd=t.toISOString().substring(0,10),o.isAllDayEvent=!0):(o.eventStart=n.toISOString(),o.eventEnd=t.toISOString(),o.isAllDayEvent=!1),this._shortLink||this._permalink?this._ensureShortUrlAndCreateEvent(o,u,s,f,e):s?this.getPermalink(function(){l._ensureShortUrlAndCreateEvent(o,u,s,f,e)}):this._ensureShortUrlAndCreateEvent(o,u,s,f,e))},n.prototype._ensureShortUrlAndCreateEvent=function(n,t,r,u,f){var e=this._shortLink?this._shortLink:this._permalink,o=null,s=null;switch(this.currentCalendarType){case 0:o=r?i.L_CalendarSync_OpenHouse_EventMessage_HTML:i.L_CalendarSync_EventMessage_HTML;s='<a href=\\"'+e+'\\">'+e+"<\/a>";break;case 1:o=r?i.L_CalendarSync_OpenHouse_EventMessage_PlainText:i.L_CalendarSync_EventMessage_PlainText;s=e;break;default:case 2:o=r?i.L_CalendarSync_OpenHouse_EventMessage:i.L_CalendarSync_EventMessage;s=e}n.description=o.replace("{0}",t.getTitle())+s;this.selectedAPI.createOrUpdateEvent(n,u,f)},n.prototype.getStartDateTime=function(){var n;return this._calendarSyncViewModel&&(n=this._calendarSyncViewModel.getStartDateTime()),n},n.prototype.getEntityInfoForLogging=function(){var n=[];return this.entity&&(n.push(this.entity.id?this.entity.id:""),n.push(this.entity.entitySource.toString()),n.push(this.entity.getSegmentTypes()?this.entity.getSegmentTypes().join("~"):"")),n.join("|")},n.prototype.log=function(n,t,i){var e=this.taskManager.getTaskById(this.taskId),o=e&&pr.getImpressionGuid(e.panelRoot),r={logData:{feature:"CAL",action:n,data:{}},impressionGuid:o};switch(n){case"ERR":r.logData.data.TYP=t;r.logData.data.Error=i;break;case"C":r.logData.data.TYP=t;break;case"S":r.logData.data.TYP=t;r.logData.data.EntityInfo=i}f.invokeHandler(u.instrumentationDataHandlerKey,r)},n}(),wf=function(){function n(n,t,i,r,u,f){if(ir)this._viewModel=new df(n,t,ir,i,r,u,f),this.categorySelected=this._viewModel.categorySelected;else throw new Error("Template is not defined!");}return n.prototype.setIsVisible=function(n){this._viewModel.setIsVisible(n)},n.prototype.getIsVisible=function(){return this._viewModel.getIsVisible()},n.prototype.deactivate=function(){this._viewModel.getControl().removeFromParent()},n.prototype.getControl=function(){return this._viewModel.getControl()},n}(),bf=function(){function n(n,t,r,u,f,e){this.cssClassName=n;this.displayName=t;this.instrumentationId=r;this.category=u;this.titleString=i.L_AlongTheRouteText.replace("{0}",t);this.categoryId=f;this.altQuery=e}return n}(),kf=function(n){function t(t){var i=this,r={};return i=n.call(this,r)||this,r.defineProperty("cssClass"),i.itemData=t,i.setCssClass(t.cssClassName),i.instrumentationData=i._createInstrumentationData(t.instrumentationId),i}return s(t,n),t.prototype._createInstrumentationData=function(n){var t={logData:{feature:kt.CategoriesBar,action:d.Clicked,data:{CT:n}}};return r.Internals.stringify(t)},t}(ot),df=function(n){function t(t,r,u,f,e,o,s){var c=this,l={};return c=n.call(this,l,f,u)||this,l.defineProperty("isVisible"),l.defineProperty("isNewCard"),c._map=t,c._taskBar=o,c._directionsTask=s,c.resources=i,c.categorySelected=new w,c._taskFrameworkConfig=h.features.taskFramework,c.setIsNewCard(c._taskFrameworkConfig&&c._taskFrameworkConfig.enableNewCardL2&&(s!==null||s!==undefined)),c._createCategoriesBarItems(r),e&&c._setMapModeEventsHandlers(),c}return s(t,n),t.prototype.getCategoryTitle=function(n){return n?i.CategoriesBar_NewHeader_Text:i.L_CategoriesBar_Header_Text},t.prototype.stringify=function(n){return r.Internals.stringify(n)},t.prototype._createCategoriesBarItems=function(n){var t,i;for(this.categoriesBarItems=[],t=0;t<n.length;t++)i=this._createCategoriesBarItem(n[t]),this.categoriesBarItems.push(i)},t.prototype._handleCustomSatrClick=function(){if(this._taskBar&&oi.customSATREnabled&&!oi.isSDK){this._taskBar.setSearchBoxGhostText(i.L_SatrGhostTextFormat);var n=[this.resources.L_Directions_Categories_Bar_Entity_Starbucks,this.resources.L_Directions_Categories_Bar_Entity_Costco,this.resources.L_Directions_Categories_Bar_Entity_FastFood,this.resources.L_Directions_Categories_Bar_Entity_Walmart,this.resources.L_Directions_Categories_Bar_Entity_Pharmacies];this._taskFrameworkConfig.enableNewCardL2&&(n.push(this.resources.L_Directions_Categories_Bar_Entity_GroceryStores),n.push(this.resources.L_Directions_Categories_Bar_Entity_GasStations));this._directionsTask&&this._taskBar.updateSearchBoxAutosuggestDefault(n,null,this._directionsTask.getRoutePoints(),this._directionsTask.id,this._directionsTask.getTraceId())}},t.prototype._createCategoriesBarItem=function(n){var t=this,i=new kf(n);return i.clickHandler=function(i){i.currentTarget.className==="customSatrIcon"||n.category==="Custom"?t._handleCustomSatrClick():t.categorySelected.invoke(n);i.preventDefault()},i},t.prototype._setMapModeEventsHandlers=function(){var n=this;this._map&&(this.disposables.push(this._map.mapTypeChanged.add(function(t){n._setLightOrDark(0,t.newMapTypeId)})),this.disposables.push(this._map.mapModeChanged.add(function(t){n._setLightOrDark(t.newMode)})),this._setLightOrDark(this._map.getMode().mapModeType))},t.prototype._setLightOrDark=function(n,t){var i=!0,r=this.getControl(),u="Dark";n===0&&(t||(t=this._map.getMapType().id),i=t===rt.aerial||t===rt.birdseye);i?r.add_class(u):r.remove_class(u)},t}(wt),gf=function(){function n(){}return n.requestTabControl=function(t,i,r,u,f,e){var c=function(t){var r=n._convertToResponseObject(t),u=r.select(".tab-container"),f=u.length&&u[0].id;i(r,f);n.prepareTabControl(r)},l=function(){},s=t.join("_"),o,h;return s=encodeURI(s),o=bt.tabCreatorUrl.replace("{names}",s),o+="&count="+n.count,r&&r>=50&&(o+="&w="+r),u&&u<t.length&&(o+="&dft="+u),f&&(o+="&hero=1"),e&&(o+="&button=1"),yi.getFunctionalTestHooksEnabled()&&(o+="&testhooks=1"),h=ft.downloadGeneric(o,"tabctrl",c,null,l,null,0),n.count++,h},n.prepareTabControl=function(n){var t=n.select(".tabControlRoot");t&&t.length&&Microsoft.Maps.setTimeout(function(){sj_evt.fire("tab_init",tabcontrol)},200)},n._convertToResponseObject=function(n){var t=r(document.createElement("div"));return t.set_html(n),t},n.count=0,n}(),ne=function(n){function t(t,u,f,e,o,s){var h=n.call(this,e)||this,c,l;return h.resources=o||i,c=f||{},c.onCloseClick||(c.onCloseClick=function(n){n.preventDefault();n.stopPropagation();h.CloseDialog()}),c.onDlgKeydown=function(n){var t=n,f=t.keyCode||t.which,i,u;f===27&&h.CloseDialog();f===9&&(i=h.getFirstTabbableChild(h._getRootElement()),u=r(".dialogClose")[0],t.target!==u||t.shiftKey?t.target===i&&t.shiftKey&&(u.focus(),t.preventDefault()):(i.focus(),t.preventDefault()))},l=s?' id="'+s+'"':"",h.setTemplate(new g('<div class="bm_modalDialog MicrosoftMap" event:keydown="onDlgKeydown" tabindex="-1"><div><div class="'+u+'"'+l+">"+t+'<a href="#" class="dialogClose closeIcon" data-tag="Dialog.Close" event:click="onCloseClick" aria-label="'+i.L_Dlg_Close+'" role="button"><\/a><\/div><\/div><\/div >',c)),h}return s(t,n),t.prototype.OpenDialog=function(){var n=this._getRootElement();n&&(document.body.appendChild(n),n.focus())},t.prototype.CloseDialog=function(){this.getRootElement().removeFromParent()},t.prototype._getRootElement=function(){var n=this.getRootElement();return n?n[0]:null},t}(dt),te=function(){function n(n,t,i,r,u){this.value=n;this.label=t;this.augmentation=i||"";this.isSelected=r||!1;this.isEnabled=typeof u=="undefined"?!0:u}return n}(),ie=function(){function n(n,t,i,r,u,f){this.id=n;this.cssClass=t;this.displayName=i;this.filterType=r;this.options=[];this.selectionRenderer=f;this.instId=u;this.instrumentationData=this._createInstrumentationData(this.instId)}return n.prototype.getSelectedOptions=function(){for(var t=[],n=0;n<this.options.length;n++)this.options[n].isSelected&&t.push(this.options[n]);return t},n.prototype.hasSelectedOptions=function(){for(var n=0;n<this.options.length;n++)if(this.options[n].isSelected)return!0;return!1},n.prototype.isEnabled=function(){if(this.options.length==0)return!1;for(var n=0;n<this.options.length;n++)if(this.options[n].isEnabled)return!0;return!1},n.prototype.addAllOptions=function(n){var t=this;return n.forEach(function(n){t.addOption(n)}),this},n.prototype.addOption=function(n){return this.options.push(n),n.item=this,this},n.prototype.removeOptionAt=function(n){if(n<0||n>=this.options.length)throw new Error("Index ["+n+"] of option to remove is out of bound, must be in (0, "+this.options.length+"] range!");return this.options.splice(n,1)[0]},n.prototype.getOptionByValue=function(n){for(var t=0;t<this.options.length;t++)if(n==this.options[t].value)return this.options[t];return null},n.prototype.equals=function(n){if(!n)return!1;if(n==this)return!0;if(this.id!==n.id||this.options.length!=n.options.length)return!1;for(var t=0;t<this.options.length;t++)if(this.options[t].value!=n.options[t].value||this.options[t].label!=n.options[t].label)return!1;return!0},n.prototype.applySelection=function(n){var i,t,r;if(this.id!=n.id)throw new Error("Filter items id missmatch "+this.id+"/"+n.id+"! Selection could not be applied!");for(i=0;i<this.options.length;i++)t=this.options[i],r=n.getOptionByValue(t.value),r&&(t.isSelected=r.isSelected,t.isEnabled=t.isEnabled||t.isSelected)},n.prototype.displaySelection=function(){return this.selectionRenderer?this.selectionRenderer(this):this.getSelectedOptions().map(function(n){return n.label}).join(", ")},n.prototype.unselectAllOptions=function(){for(var n=0;n<this.options.length;n++)this.options[n].isSelected=!1},n.prototype.prune=function(){for(var t,n=this.options.length-1;n>=0;n--)t=this.options[n],t.isEnabled||this.removeOptionAt(n)},n.prototype.clear=function(){this.options=[]},n.prototype.hasOptions=function(){return this.options&&this.options.length>0},n.prototype._createInstrumentationData=function(n){var t={logData:{feature:kt.FiltersBar,action:d.Clicked,data:{FT:n}}};return r.Internals.stringify(t)},n}(),re=function(){function n(n,t){var i=this;this._items=[];n.forEach(function(n){i.addItem(n)});this._isAlongTheRouteItemSupported=t||!1}return n.prototype.getItems=function(){return this._items.slice()},n.prototype.isAlongTheRouteItemSupported=function(){return this._isAlongTheRouteItemSupported},n.prototype.getItemsNumber=function(){return this._items.length},n.prototype.getItemAt=function(n){return this._checkRange(n),this._items[n]},n.prototype.addItem=function(n){this._items.push(n)},n.prototype.addItemAt=function(n,t){if(t<0||t>this._items.length)throw new Error("Index ["+t+"] is out of bound, must be in [0, "+this._items.length+"] range!");this._items.splice(t,0,n)},n.prototype.removeItemAt=function(n){return this._checkRange(n),this._items.splice(n,1)[0]},n.prototype._checkRange=function(n){if(n<0||n>=this._items.length)throw new Error("Index ["+n+"] is out of bound, must be in [0, "+this._items.length+") range!");},n.prototype.removeItem=function(n){var t=this.indexOf(n);return t>=0?(this.removeItemAt(t),!0):!1},n.prototype.clear=function(){this._items=[]},n.prototype.indexOf=function(n){for(var t=0;t<this._items.length;t++)if(n.id===this._items[t].id)return t;return-1},n.prototype.hasSelectedOptions=function(){for(var n=0;n<this._items.length;n++)if(this._items[n].hasSelectedOptions())return!0;return!1},n.prototype.getItemById=function(n){for(var t=0;t<this._items.length;t++)if(n===this._items[t].id)return this._items[t];return null},n.prototype.getSelectedItems=function(){var n=[];return this._items.forEach(function(t){t.hasSelectedOptions()&&n.push(t)}),n},n.prototype.applyHistograms=function(t){var u=this,i,r;if(t){for(this._isAlongTheRouteItemSupported=t._isAlongTheRouteItemSupported,i=this.getItemsNumber()-1;i>=0;i--)r=this.getItemAt(i),r.id!==n.AlongTheRouteItemId&&this.removeItemAt(i);t._items.forEach(function(n){u.addItem(n)})}},n.AlongTheRouteItemId="AlongTheRoute",n}(),er=function(n){function t(i,r,u){var f=this;return f=n.call(this,{},r,au)||this,t._initializeFilterItemTemplates(),f._eventHandlers=[],f._filtersBar=i,f.filterOptionClicked=new w,f._createFiltersViewModels(),f._expansionState=u||{isExpanded:!1},f._processExpansionState(),f}return s(t,n),t.prototype.unselectItem=function(n){for(var i,t=0;t<this._filtersViewModels.length;t++)if(i=this._filtersViewModels[t],n.id===i.filterItem.id){i.filterItem.unselectAllOptions();i.refresh();break}},t.prototype.dispose=function(){this._eventHandlers.forEach(function(n){n.item.remove_event(n.eventName,n.handler)});this._eventHandlers=[]},t._initializeFilterItemTemplates=function(){t._filterItemTemplates[2]=lu;t._filterItemTemplates[1]=wu;t._filterItemTemplates[0]=wi},t._resolveFilterItemTemplate=function(n){var i=t._filterItemTemplates[n.filterType];return i?i:(yi.logDebugData("There's no template defined for filter type: "+n.filterType+", returning ListDropdownTemplate as default one."),wi)},t.prototype._processExpansionState=function(){var n=this,t=this._getExpandButton(),i;if(!this._isExpandable()){this._expansionState.isExpanded=!1;t&&t.length===1&&t.removeFromParent();return}this._synchronizeExpansionStateWithView();i=function(t){t.preventDefault();n._expansionState.isExpanded=!n._expansionState.isExpanded;n._synchronizeExpansionStateWithView();n._logExpandButtonClick(n._expansionState.isExpanded)};t.add_event("click",i);this._addEventsToEventList(t,"click",i)},t.prototype._getExpandButton=function(){var n="a[class="+t._expandButtonCssClass+"]";return this.getControl().select(n)},t.prototype._synchronizeExpansionStateWithView=function(){var n=this._getExpandButton(),r=this.getControl();this._expansionState.isExpanded?(r.add_class(t._filtersBarExpandedCssClass),n.set_text(i.L_FiltersBar_Less_Text)):(r.remove_class(t._filtersBarExpandedCssClass),n.set_text(i.L_FiltersBar_More_Text))},t.prototype._isExpandable=function(){return this._filtersViewModels.length>=t._expandButtonThreshold},t.prototype._logExpandButtonClick=function(n){var t={logData:{feature:kt.FiltersBar,action:d.Expanded,data:{ED:n}}};f.invokeHandler(u.instrumentationDataHandlerKey,t)},t.prototype._createFiltersViewModels=function(){var r=this,n;for(this._filtersViewModels=[],this._filtersBar.getItems().forEach(function(n){if(n.options.length>0){var i=new he(n,t._resolveFilterItemTemplate(n));i.filterOptionClicked.add(function(n){r.filterOptionClicked.invoke(n)});r._filtersViewModels.push(i)}}),n=0;n<this._filtersViewModels.length;n++){var i=this._filtersViewModels[n],u=i.filterItem,f=this.getControl().select("a."+u.cssClass),e=this.getControl().select("div."+u.cssClass);i.setViewModelData(e,f);this._addFilterButtonClickHandler(f,i)}},t.prototype._addFilterButtonClickHandler=function(n,t){var i=function(n){return t.filterButtonButtonClicked(n)};n.add_event("click",i);this._addEventsToEventList(n,"click",i)},t.prototype._addEventsToEventList=function(n,t,i){this._eventHandlers.push({item:n,eventName:t,handler:i})},t._filterItemTemplates={},t._expandButtonCssClass="expandFiltersButton",t._expandButtonThreshold=4,t._filtersBarExpandedCssClass="Expanded",t}(wt),or=function(n){function t(t,i){var r=this,u={};return r=n.call(this,u,i,vu)||this,u.defineProperty("selectedItems",function(n,t){r.setIsVisible(t.length>0)}),u.defineProperty("isVisible"),r.setSelectedItems(t.getSelectedItems()),r.filterItemDiscardedFromSelection=new w,r}return s(t,n),t.prototype.onDiscardFilterItemSelection=function(n){n.stopPropagation();n.preventDefault();var t=r(n.target).get_attr("class"),u=this._getItemById(t),i=this.getSelectedItems().slice();i.splice(this._getItemIndex(t),1);this.setSelectedItems(i);this.filterItemDiscardedFromSelection.invoke(u)},t.prototype.itemToString=function(n){if(n){var t=this._getItemById(n);return t.displaySelection()}return""},t.prototype._getItemById=function(n){var t=this._getItemIndex(n);return t==-1?null:this.getSelectedItems()[t]},t.prototype._getItemIndex=function(n){for(var i,t=0;t<this.getSelectedItems().length;t++)if(i=this.getSelectedItems()[t],n===i.id)return t;return-1},t}(wt),ue=function(){function n(n){this._controlTemplateFactory=n;this._filtersBarViewModelExpansionState={isExpanded:!1};this.filterOptionClicked=new w;this.filtersBarRecreated=new w;this.filterItemDiscardedFromSelection=new w}return n.prototype.update=function(n,t){var i=this;this.dispose();this._control=t;t.getParent().remove_class("withFilters");t.clear();n&&n.getItemsNumber()>0&&(this._filtersBarViewModel=new er(n,this._controlTemplateFactory,this._filtersBarViewModelExpansionState),this._filtersBarViewModel.filterOptionClicked.add(function(t){i._filtersStatusBarViewModel.setSelectedItems(n.getSelectedItems());i.filterOptionClicked.invoke(t)}),t.append(this._filtersBarViewModel.getControl()),this._filtersStatusBarViewModel=new or(n,this._controlTemplateFactory),this._filtersStatusBarViewModel.filterItemDiscardedFromSelection.add(function(n){i._filtersBarViewModel.unselectItem(n);i.filterItemDiscardedFromSelection.invoke(n)}),t.append(this._filtersStatusBarViewModel.getControl()),t.getParent().add_class("withFilters"),this.filtersBarRecreated.invoke())},n.prototype.disableInteraction=function(){if(this._control){var n=a._createElement("div").add_class("bm_filtersBarModuleOverlay").set_html("&nbsp;");this._control.append(n);Microsoft.Maps.setTimeout(function(){n.append(a._createElement("div").add_class("spinner"))},400)}},n.prototype.enableInteraction=function(){this._control&&this._control.select(".bm_filtersBarModuleOverlay").removeFromParent()},n.prototype.dispose=function(){this._filtersBarViewModel&&this._filtersBarViewModel.dispose();this._filtersStatusBarViewModel&&this._filtersStatusBarViewModel.dispose()},n}(),fe=function(n){function t(){var t=n.call(this)||this;return t._templateString='<div class="{TemplateBinding Class}" data-tag="canvasIcon"><\/div>',t.defineProperty("class",null,null,{defaultValue:""}),t.defineProperty("vectorTemplate",function(n,i){t._onVectorTemplateChanged(n,i)}),t.setTemplate(new g(t._templateString,null)),t}return s(t,n),t.prototype._onVectorTemplateChanged=function(n,t){var i=this.getRootElement();i.clear();t&&i.append(t.renderIcon())},t}(dt);g.registerControl("CanvasControl",fe);var ee=function(n){function t(t,i){return n.call(this,t,i)||this}return s(t,n),t.prototype.setMap=function(t){var i=this;n.prototype.setMap.call(this,t);this.mouseenter.add(function(){i.preventAutoClose=!0});this.mouseleave.add(function(){i.preventAutoClose=!1;i.setOptions({visible:!1,closeDelayTime:500})})},t.prototype.setOptions=function(t){t.htmlContent&&(t.htmlContent=this._updateHtmlContent(t.htmlContent));n.prototype.setOptions.call(this,t)},t.prototype._updateHtmlContent=function(n){return'<div class="MapsInfoboxContainer">'+n+"<\/div>"},t.prototype.dispose=function(){n.prototype.dispose.call(this)},t}(kr),oe=function(n){function t(t,i){var r=this;return i=i||{},r=n.call(this,i)||this,i.defineProperty("name"),i.defineProperty("checked",function(n,t){r._onChanged(n,t)},null,{defaultValue:!1}),i.defineProperty("icon"),r.setName(t),r.onCheckedChanged=new w,r}return s(t,n),t.prototype.onItemClick=function(n){this.setChecked(!this.getChecked());n.preventDefault()},t.prototype._onChanged=function(n,t){t?this.onCheckedChanged.invoke(!0):n&&this.onCheckedChanged.invoke(!1)},t}(ot),se=function(n){function t(){var t=this,i={};return t=n.call(this,i)||this,i.defineProperty("itemList"),i.defineProperty("displayDropdown",null,null,{defaultValue:!1}),i.defineProperty("buttonName"),i.defineProperty("buttonIcon"),i.defineProperty("dropdownTitle"),t.setTemplate(new g(hu,{boolToDisplay:function(n){return t._boolToDisplay(n)},onDropdownButtonClick:function(n){t._onDropdownButtonClick(n)},itemCheckedClass:function(n){return t._itemCheckedClass(n)},dropdownOpenClass:function(n){return t._dropdownOpenClass(n)},mouseoverDropdown:function(n){t._mouseoverDropdownHandler(n)},mouseexitDropdown:function(n){t._mouseexitDropdownHandler(n)}})),t}return s(t,n),t.prototype._boolToDisplay=function(n){return n?"":"none"},t.prototype._onDropdownButtonClick=function(n){this.setDisplayDropdown(!0);n&&n.preventDefault&&n.preventDefault()},t.prototype._itemCheckedClass=function(n){return"multiselectCheckbox"+(n?" checked":"")},t.prototype._dropdownOpenClass=function(n){return"dropdownButton"+(n?" open":"")},t.prototype._mouseoverDropdownHandler=function(n){var t=this;window.clearTimeout(this._mouseoverDelay);this._mouseoverDelay=Microsoft.Maps.setTimeout(function(){t.setDisplayDropdown(!0)},50);this._tempButtonIcon||(this._tempButtonIcon=this.getButtonIcon());this.setButtonIcon(this._tempButtonIcon+" hover");n&&n.preventDefault&&n.preventDefault()},t.prototype._mouseexitDropdownHandler=function(n){var t=this;window.clearTimeout(this._mouseoverDelay);this._mouseoverDelay=Microsoft.Maps.setTimeout(function(){t.setDisplayDropdown(!1)},200);this.setButtonIcon(this._tempButtonIcon);n&&n.preventDefault&&n.preventDefault()},t}(dt);g.registerControl("MultiselectDropdown",se);var sr=function(n){function t(t,i,r,u){var f=this,e={};return f=n.call(this,e)||this,f.title=t,f.linkTitle=i,f.linkData=r,f._buttonElement=u,e.defineProperty("showLink",null,null,{defaultValue:!0}),e.defineProperty("nickName"),e.defineProperty("showAnnotate"),e.defineProperty("parentClass"),f.setShowAnnotate(!1),f}return s(t,n),t.prototype.getButtonElement=function(){return this._buttonElement},t.prototype.setButtonElement=function(n){this._buttonElement=n},t.prototype.onLinkClick=function(n){this.linkData&&f.invokeHandler(u.taskDataHandlerKey,this.linkData);n&&n.preventDefault&&n.preventDefault()},t.prototype.onEditLinkClick=function(n){n&&n.preventDefault&&n.preventDefault()},t.prototype.onCloseLinkClick=function(n){n&&n.preventDefault&&n.preventDefault()},t.prototype.onSaveLinkClick=function(n){return n&&n.preventDefault&&n.preventDefault(),!0},t.prototype.onKeyPress=function(){},t.prototype.boolToDisplay=function(n){return n?"inline":"none"},t.prototype.boolToNotDisplay=function(n){return n?"none":"block"},t}(ot),ki=function(n){function t(t,i,r,u,f,e){var o=n.call(this,t,i,r,u)||this;return o.setShowLink(!0),o.processOptions=f,o.entityId=e,o.showFooter=f&&f.requestState&&f.requestState.entityId?"":"none",o}return s(t,n),t.prototype.onLinkClick=function(t){this.linkData?n.prototype.onLinkClick.call(this,t):this.processOptions?f.invokeHandler(u.taskProcessDataHandlerKey,this.processOptions):this.activateOptions&&this.isTempCollectionMessage&&f.invokeHandler(u.taskDataHandlerKey,this.activateOptions);t&&t.preventDefault&&t.preventDefault()},t.prototype.onSaveLinkClick=function(t){var i,r,e,o;return n.prototype.onSaveLinkClick.call(this,t),i=this.getNickName().trim(),i?(this.processOptions&&this.processOptions.requestState?(r=this.processOptions.requestState,r.action=v.UpdateEntity,r.entityId=this.entityId,r.data={title:i},this.processOptions.useActiveTasks=!1,f.invokeHandler(u.taskProcessDataHandlerKey,this.processOptions)):(e=this.activateOptions&&this.activateOptions.state&&this.activateOptions.state.collectionId,o={type:l.collectionsTask,requestorType:this.requestorType,requestorId:this.requestorId,requestState:{action:v.UpdateEntity,entityId:this.entityId,collectionId:e,data:{title:i}}},f.invokeHandler(u.taskProcessDataHandlerKey,o)),this.saveNicknameClicked=!0,!0):(this.focusMessageOrTextBox(),!1)},t.prototype.onKeyPress=function(n){if(n.keyCode===13)this.onSaveLinkClick(null)},t.prototype.focusMessageOrTextBox=function(){this.getShowAnnotate()?Microsoft.Maps.setTimeout(function(){var n=r(".nameEditBox"),t,i,f,u;if(n&&n.length)for(t=null,i=0;i<n.length;i++)if(n[i].focus(),t=document.activeElement,t&&t.classList.contains("nameEditBox"))break;f=document.activeElement;f.classList.contains("nameEditBox")||(u=r(".messageContainer"),u.length>0&&u[0].focus())},500):Microsoft.Maps.setTimeout(function(){var n=r(".messageContainer");n.length>0&&n[0].focus()},100)},t}(sr),st=function(){function n(n){this._buttonElement=n;this.setDropdown([])}return n.prototype.getButtonElement=function(){return this._buttonElement},n.prototype.setButtonElement=function(n){this._buttonElement=n},n.prototype.setDropdown=function(n){this.dropdownList=n||[]},n.prototype.onEntryClicked=function(n){if(n>=0&&n<this.dropdownList.length){var t=this.dropdownList[n];t.options?f.invokeHandler(u.taskDataHandlerKey,t.options):t.handler&&t.handler.call(this,null,n);t.instData&&f.invokeHandler(u.instrumentationDataHandlerKey,this.dropdownList[n].instData)}},n.prototype.onEntryMouseover=function(n){if(n>=0&&n<this.dropdownList.length){var t=this.dropdownList[n];t.mouseoverhandler&&(t.mouseoverhandler.call(this,null,n),t.instData&&f.invokeHandler(u.instrumentationDataHandlerKey,this.dropdownList[n].instData))}},n.prototype.onEntryMouseout=function(n){if(n>=0&&n<this.dropdownList.length){var t=this.dropdownList[n];t.mouseouthandler&&t.mouseouthandler.call(this,null,n)}},n}(),di=function(n){function e(t,i,r,u,f,e){var o=n.call(this,i)||this,s;return o._map=t,o.entityDescription=e,o.entityNickName=u,o.entityOriginalName=f,o.isMoveToMenu=r,s=h.features.travel,o._showItineraries=s&&s.isEditable,o.newCollectionCreated=new w,o.contextMenuFinished=new w,o}return s(e,n),e.prototype.setDropdownData=function(n,t,i,r,u,f,e,o){var s=this,h,c;this._entityId=t.id;h=new ai;this._showItineraries&&h.getIsSignedIn()?(c=this._map.getContainer(),c.instanceAsync("ItineraryDataManager",function(h){s._dataManager=h;s._dataManager.retrieveAllItinerariesMetaData(function(h,c){h&&c===0&&(s.dropdownList=s._populateDropDownListData(n,t,i,r,u,f,h,o));e&&e()})})):(this.dropdownList=this._populateDropDownListData(n,t,i,r,u,f),e&&e())},e.prototype.onEntryClicked=function(n){if(!(n<0)&&!(n>=this.dropdownList.length)){var t=this.dropdownList[n],i=t.options,r;i&&(i.requestState?r=u.taskProcessDataHandlerKey:(r=u.taskDataHandlerKey,this.newCollectionCreated.invoke()),f.invokeHandler(r,i));t.handler&&t.handler(null,n)}},e.prototype._populateDropDownListData=function(n,t,r,u,f,e,o){var ut=this,h=[],a,p,ht,ct,l,nt,g;if(!n||!t||!r||!u&&!f)return h;var s=t,w=t instanceof pi?s:null,tt=s.categoryId||w&&w.getSelectedCategoryForIcon(),ft=s.addressFields,et=s.interests,ot=s.stayDuration,b=s.getImageUrl(),c=k.getMyPlacesTaskOptions(s.getTitle(),r,this.entityDescription,s.getAddress(),b&&b.length>0?b:null,tt,this._entityId,ft,s.metadataString,s.mainSegmentType);if(c.activateOptions={parentId:u},this.entityNickName&&this.entityOriginalName?(c.state.data.nickName=this.entityNickName,c.state.data.title=this.entityOriginalName):s.getNickname&&s.getNickname()&&(c.state.data.nickName=s.getNickname()),a=e.logData.data,c.state.entryPoint=a&&(a.EP&&a.EP===y.LocalDetails||a.ID)?3:2,p=a&&a.EP,this.isMoveToMenu&&(c.state.isMove=!0),this._pushFavoritesAction(h,this.isMoveToMenu?i.L_MoveToFavorites:i.L_AddFavorite,v.AddFavorite,c,f,p,"newFavorite icon"),h.push({name:"",separator:!0}),this._showItineraries){var d=!1,lt=w&&w.getSegmentTypes(),at=w&&w.getPrimaryCategoryName(),vt=k.createNewItineraryOption(s.getTitle(),r,t.id,b,u,tt,et,ot,lt,at,ft,f);h.push({name:i.L_CreateNewItinerary,options:vt,iconClass:"newItinerary icon"});d=!0;var st=function(){ut.contextMenuFinished.invoke()},it=c.state,rt=k.getItineraryItem(it.data.nickName||it.data.title,r,t.id,b,tt,et,ot);if(rt.OriginalName=it.data.title,p!==y.ContextMenu&&this._pushMostRecentlyUsedListEntries(h,rt,st,c,f,u,p)&&(d=!0),o&&o.length)for(d=!0,l=0,ht=o.length;l<ht;l++)ct=o[l],g=this._createSaveToItineraryAction(rt,st,ct,f,u),h.push(g);d&&h.push({name:"",separator:!0})}for(h.push({name:i.L_CreateNewCollection,handler:function(){ut._createNewCollectionControl(c.state)},iconClass:"newCollection icon"}),l=0;l<n.collections.length;l++)nt=n.collections[l],g=this._createSaveToCollectionAction(nt.name,nt.id,c,f,u,p),nt.name&&h.push(g);return h.push({name:"",separator:!0}),this._pushFavoritesAction(h,this.isMoveToMenu?i.L_MoveToHome:i.L_SetAsHome,v.SetHome,c,f,p,"setHome icon"),this._pushFavoritesAction(h,this.isMoveToMenu?i.L_MoveToWork:i.L_SetAsWork,v.SetWork,c,f,p,"setWork icon"),h},e.prototype._pushFavoritesAction=function(n,t,i,r,u,f,e){var o={type:r.type,requestorId:r.activateOptions.parentId,requestorType:u,requestState:{action:i,data:r.state.data},requestorState:{entryPoint:f}};n.push({name:t,options:o,iconClass:e})},e.prototype._pushSaveToTempAction=function(n,t,r,u,f){var e={requestorId:t.activateOptions.parentId,requestorType:r,type:l.collectionsTask,requestState:{action:v.AddToTemporaryCollection,data:t.state.data},requestorState:{entryPoint:u}};n.push({name:i.L_TemporaryCollectionTitle,options:e,iconClass:f?"newCollection icon":"icon"})},e.prototype._createSaveToCollectionAction=function(n,t,i,r,u,f){var e={type:i.type,requestorId:u,requestorType:r,requestState:{action:v.AddEntity,data:i.state.data,collectionId:t},requestorState:{title:n,entryPoint:f}};return{name:n,options:e,iconClass:"icon"}},e.prototype._createSaveToItineraryAction=function(n,t,i,r,u){var f={type:l.itineraryDetailsTask,requestorId:u,requestorType:r,requestState:{action:5,itineraryItem:n,itineraryCollectionId:i.collectionId}};return{name:i.getName(),options:f,handler:t,iconClass:"icon"}},e.prototype._createSaveToOpenItineraryAction=function(n,t,i,r){var u={type:l.itineraryDetailsTask,requestState:{action:1,itineraryItem:n},taskId:r};return{name:i,options:u,handler:t,iconClass:"icon"}},e.prototype._pushMostRecentlyUsedListEntries=function(n,i,r,u,f,e,o){var v=t.CloudGraphDataManager.MostRecentlyUsedList&&t.CloudGraphDataManager.MostRecentlyUsedList.instance,l,h,s,c,y,a;if(v.getLength()>0){for(n.splice(0,0,{name:"",separator:!0}),l=v.getList(),h=l.length-1;h>=0;h--)s=l[h],s.IsItinerary?s.IsOpenTask?c=this._createSaveToOpenItineraryAction(i,r,s.TaskTitle,s.TaskId):(y=s.Itinerary,c=this._createSaveToItineraryAction(i,r,y,f,e)):(a=s.Collection,c=this._createSaveToCollectionAction(a.name,a.id,u,f,e,o)),h===0&&(c.iconClass="recentlyUsed icon"),n.splice(0,0,c);return!0}return!1},e.prototype._createNewCollectionControl=function(n){var t=this,i;this.newCollectionCreated.invoke();i=this._map.getContainer();i.instanceAsync("NewCollectionControl",function(i){var e=r("#transientLens"),o,s,f,u;e.length>0?(u=e.getParent(),f=t._map.getRootElement().getParent(),u.getParent().has_class("bm_listMenu")&&(u=u.getParent(),f=u.getParent()),o=u.get_style("left"),s=u.get_style("top")):f=t.popOutRoot;i.setLeftPosition(o);i.setTopPosition(s);i.setEntityData(n);t.contextMenuFinished.invoke();t.contextMenuFinished.invoke();i.finished.add(function(){t._removeNewCollectionControl()});t._newCollectionControl=i.getControl();f&&f.append(t._newCollectionControl)})},e.prototype._removeNewCollectionControl=function(){this._newCollectionControl&&this._newCollectionControl.removeFromParent();this._newCollectionControl=null},e}(st),hr=function(n){function r(t,i,r,u,f,e){var o=n.call(this,u)||this;return o._addToRouteMode=e,o.setDropdownData(t,i,r,f),o}return s(r,n),r.prototype.setDropdownData=function(t,i,r,u){n.prototype.setDropdown.call(this,this._populateDropDownListData(t,i,r,u))},r.prototype._populateDropDownListData=function(n,r,u,f){var o=[],ut,nt,a,h,v,y,e,ft,et,g,ot,tt,it,st,ht;if(!n||!r||!u)return o;var p,w,c,d=r.getDescription()||r.getTitle(),rt=r.entitySource,l=rt?rt===1:!1,s=r,b;if(s&&s.id&&s.id.indexOf("event")>-1&&(ut=t.GlobalConfig.features.localSearch.eventPreArrivalTime,b=s&&s.getDateTime&&s.getDateTime()?s.getDateTime()+s.getUtcOffset()*6e4-ut*6e4:null),nt=k.getDirectionTaskOptions(d,u,f.logData.data.EP,r.getTitle(),r.id,null,l,b),f){p={logData:{feature:f.logData.feature,action:f.logData.action,data:{}}};w={logData:{feature:f.logData.feature,action:f.logData.action,data:{}}};c={logData:{feature:f.logData.feature,action:f.logData.action,data:{}}};l&&(c.logData.data.ID=r.id,c.logData.data.AL=l);a=f.logData.data;for(h in a)a.hasOwnProperty(h)&&(p.logData.data[h]=a[h],w.logData.data[h]=a[h],c.logData.data[h]=a[h]);p.logData.data.DT="DirectionsTo";w.logData.data.DT="DirectionsFrom";c.logData.data.DT="AddWaypoint"}for(v=null,y=0;y<n.length;y++)e=n[y].data,e.activationState!==1||this._addToRouteMode?(e.routeTitle&&e.mode!==gt.transit||e.isIncomplete)&&(g="",this._addToRouteMode||(g=i.L_Directions_AddToRoute+"\n"),g+=e.routeTitle,e.isIncomplete&&(nt.state.waypoints[0].waypointType=4),ot={action:"focus",state:nt.state,id:n[y].processorId},o.push({name:g,options:ot,instData:c})):(v=n[y].processorId,e.routeTitle&&e.mode!==gt.transit&&(ft=k.getDirectionTaskOptions(d,u,f.logData.data.EP,r.getTitle(),r.id,3,l,b),et={action:"focus",state:ft.state,id:v},o.splice(0,0,{name:i.L_Add_To_Current_Route,options:et,instData:c})));return this._addToRouteMode||(tt=k.getDirectionTaskOptions(d,u,f.logData.data.EP,r.getTitle(),r.id,2,l,b),it=k.getDirectionTaskOptions(d,u,f.logData.data.EP,r.getTitle(),r.id,1,l,b),v?(st={action:"focus",state:it.state,id:v},o.splice(0,0,{name:i.L_Directions_From,options:st,instData:w}),ht={action:"focus",state:tt.state,id:v},o.splice(0,0,{name:i.L_Directions_To,options:ht,instData:p})):(o.splice(0,0,{name:i.L_Directions_From,options:it,instData:w}),o.splice(0,0,{name:i.L_Directions_To,options:tt,instData:p}))),o},r}(st),gi=function(n){function t(t,u,f,e,o){var s=this,h={},c,l;return s=n.call(this,h)||this,h.defineProperty("popOutTemplate",function(n,t){return s._onTemplateChange(n,t)}),h.defineProperty("popOutContent"),h.defineProperty("isDisplayed",function(n,t){return s._onDisplayChange(n,t)},null,{defaultValue:!1}),h.defineProperty("buttonClass"),s.setButtonClass("hidePopupButton"),h.defineProperty("popOut"),h.defineProperty("ariaLabel"),h.defineProperty("dropdownClass"),h.defineProperty("parentClass"),s.setParentClass(o?o:""),s.resources=i,s.dropdownList=new tu,s.setDropdownClass("popOutTop"),t&&s.setDropdown(t),u&&s.setPopOut(u),c=f?f:wi,l=e?e:pu,s._dropdownListTemplate=new g(c,{onEntryClicked:function(n){s._dropdownListViewModel.onEntryClicked(n);t.dropdownList&&t.dropdownList[n]&&t.dropdownList[n].subMenu||s.setIsDisplayed(!1)},onEntryMouseover:function(n){s._dropdownListViewModel.onEntryMouseover(n);t.dropdownList&&t.dropdownList[n]&&t.dropdownList[n].subMenu||s.setIsDisplayed(!0)},onEntryMouseout:function(n){s._dropdownListViewModel.onEntryMouseout(n)}}),s._popoutMessageTemplate=new g(l,{onPopOutLinkClick:function(n){return s.onPopOutLinkClicked(n)},onPopOutEditLinkClick:function(n){return s.onPopOutEditLinkClick(n)},onPopOutCloseLinkClick:function(n){return s.onPopOutCloseLinkClick(n)},onPopOutSaveLinkClick:function(n){return s.onPopOutSaveLinkClick(n)},onPopOutKeyPressed:function(n){return u.onKeyPress(n)},onTextBoxClick:function(n){return s.onTextBoxClick(n)},onPopOutClick:function(n){return s.onPopOutClick(n)},boolToDisplay:function(n){return u.boolToDisplay(n)},boolToNotDisplay:function(n){return u.boolToNotDisplay(n)}}),s.popOutHidden=new w,s.setPopOutTemplate(s._dropdownListTemplate),s.setPopOutContent(s),s._windowKeyupEventHandler=function(n){var f=n,t=s.getParentClass()&&r("."+s.getParentClass()),i,u;if(f.keyCode===9){if(i=document.activeElement,u=i&&i.classList,u&&u.contains("dropdownEntry"))return;s._hideControls();t&&t.length>0&&t[0].focus()}else if(f.keyCode===37)s._hideControls(),t&&t.length>0&&t[0].focus();else if(f.keyCode===38){if(i=document.activeElement,u=i&&i.classList,u&&u.contains("dropdownEntry"))return}else if(f.keyCode===39)s._hideControls(),t&&t.length>0&&t[0].focus();else if(f.keyCode===40&&(i=document.activeElement,u=i&&i.classList,u&&u.contains("dropdownEntry")))return},s}return s(t,n),t.prototype.dispose=function(){n.prototype.dispose.call(this);this.dropdownList.clear()},t.prototype.isPopOutInListMode=function(){return this.getPopOutTemplate()===this._dropdownListTemplate},t.prototype.setDropdown=function(n,t){var u=this._dropdownListViewModel&&this._dropdownListViewModel.getButtonElement(),i;u&&u.remove_class("selected");this._dropdownListViewModel=n;i=this._dropdownListViewModel.getButtonElement();i&&i.add_class("selected");this.dropdownList.clear();this.dropdownList.insertAll(this._dropdownListViewModel.dropdownList);this.setPopOutTemplate(t?t:this._dropdownListTemplate);r(window).add_event("keyup",this._windowKeyupEventHandler)},t.prototype.setTemplateToPopOutMessage=function(){this.setPopOutTemplate(this._popoutMessageTemplate);var n=this.getPopOut();n&&n instanceof ki?n.focusMessageOrTextBox():Microsoft.Maps.setTimeout(function(){var n=r(".messageContainer");n.length>0&&n[0].focus()},100)},t.prototype.onPopOutLinkClicked=function(n){this.getPopOut().onLinkClick(n);this.setIsDisplayed(!1)},t.prototype.onPopOutEditLinkClick=function(n){this.getPopOut().onEditLinkClick(n);this.setIsDisplayed(!1)},t.prototype.onPopOutCloseLinkClick=function(n){this.getPopOut().onCloseLinkClick(n);this.setIsDisplayed(!1)},t.prototype.onPopOutSaveLinkClick=function(n){var t=this.getPopOut().onSaveLinkClick(n);this.setIsDisplayed(!t)},t.prototype.onTextBoxClick=function(n){n&&n.preventDefault&&n.preventDefault()},t.prototype.onPopOutClick=function(n){n&&n.preventDefault&&n.preventDefault()},t.prototype.buildPopOut=function(n){var t=n?n:yu,i=new g(t);return i.applyDataTemplate(this)},t.prototype._onTemplateChange=function(n,t){var i=this._dropdownListViewModel&&this._dropdownListViewModel.getButtonElement(),r=this.getPopOut()&&this.getPopOut().getButtonElement();n===this._dropdownListTemplate?i&&i.remove_class("selected"):n===this._popoutMessageTemplate?r&&r.remove_class("selected"):(i&&i.remove_class("selected"),r&&r.remove_class("selected"));t===this._dropdownListTemplate?i&&i.add_class("selected"):t===this._popoutMessageTemplate&&r&&r.add_class("selected")},t.prototype._onDisplayChange=function(n,t){var i=this._dropdownListViewModel&&this._dropdownListViewModel.getButtonElement(),u=this.getPopOut()&&this.getPopOut().getButtonElement(),o=this.getPopOutTemplate(),f,e;o===this._dropdownListTemplate?(u&&u.remove_class("selected"),i&&(t?(i.add_class("selected"),f=i.select(".feedbackMenuLink"),f&&f.length>0&&i.set_attr("aria-expanded","true")):(i.remove_class("selected"),i.get_attr("aria-expanded")?i.set_attr("aria-expanded","false"):null))):o===this._popoutMessageTemplate&&(i&&i.remove_class("selected"),u&&(t?u.add_class("selected"):u.remove_class("selected")));n&&!t?(this.popOutHidden.invoke(),i&&i.remove_class("selected"),u&&u.remove_class("selected"),r(window).remove_event("keyup",this._windowKeyupEventHandler)):!n&&t&&(e=this.getPopOut(),e&&e.setNickName(""))},t.prototype._hideControls=function(){this.setIsDisplayed(!1);var n=this._dropdownListViewModel&&this._dropdownListViewModel.getButtonElement();n&&n.length>0&&n[0].focus()},t}(ot),cr=function(n){function t(t,i,r){var u=n.call(this,i)||this;return u.setDropdown(t),u._isMultipleSelection=r||!1,u._updateItemsCssClasses(),u}return s(t,n),t.prototype.onEntryClicked=function(t){if(t>=0&&t<this.dropdownList.length){var i=this.dropdownList[t];if(i.isSelected&&!this._isMultipleSelection)return;i.isSelected||this._isMultipleSelection||this._unselectAllItems();i.isSelected=!i.isSelected;this._updateItemsCssClasses();n.prototype.onEntryClicked.call(this,t)}},t.prototype._unselectAllItems=function(){for(var n=0;n<this.dropdownList.length;n++)this.dropdownList[n].isSelected=!1},t.prototype._updateItemsCssClasses=function(){for(var i=0;i<this.dropdownList.length;i++){var n=this.dropdownList[i],r=t._selectedCssClass,u=n.cssClass&&n.cssClass.search(r)!=-1;n.isSelected&&!u?n.cssClass&&n.cssClass.length>0?n.cssClass+=" "+r:n.cssClass=r:!n.isSelected&&u&&(n.cssClass=n.cssClass.replace(r,""),n.cssClass=n.cssClass.replace("  "," ").trim())}},t._selectedCssClass="selected",t}(st),he=function(){function n(n,t){this._events=[];this.filterItem=n;this._filterItemTemplateName=t;this.filterOptionClicked=new w;this._viewModelInitialized=!1;this.hideParent=new w}return n.prototype.setViewModelData=function(n,t){this._popOutRootElement=n;this._filterButton=t},n.prototype.filterButtonButtonClicked=function(n){if(n.preventDefault(),this.filterItem.isEnabled()){var t=this._popOutButtonViewModel&&this._popOutButtonViewModel.getIsDisplayed();t||this._showPopOut()}},n.prototype._updatePopOutListDropdownViewModel=function(n){this._popOutButtonViewModel.setDropdown(n)},n.prototype.dispose=function(){this._popOutButtonViewModel&&this._popOutButtonViewModel.dispose()},n.prototype.refresh=function(){this._viewModelInitialized&&this._dropdownViewModel.setDropdown(this._createDropdownListData())},n.prototype._displayPopOut=function(){var n=this;Microsoft.Maps.setTimeout(function(){n._popOutButtonViewModel.setIsDisplayed(!0)},0)},n.prototype._showPopOut=function(){if(this._initializeViewModels(),this._dropdownViewModel.dropdownList.length>0){var t=a._isFeatureEnabled("mobileMyPlaces")?r("#filterChoiceBar"):this._popOutRootElement.select("div."+n.popOutCssClass);this._updatePopOutListDropdownViewModel(this._dropdownViewModel);t.append(this._popOutElement);this._displayPopOut()}else this.hideParent.invoke()},n.prototype._initializeViewModels=function(){var n=this;this._viewModelInitialized?this._dropdownViewModel.setButtonElement(this._filterButton):(this._dropdownViewModel=new cr(this._createDropdownListData(),this._filterButton,this.filterItem.filterType===2),this._popOutButtonViewModel=new gi(this._dropdownViewModel,this._PopOutMessageViewModel,this._filterItemTemplateName,null),this._events.push(this._popOutButtonViewModel.popOutHidden.add(function(){n._dropdownViewModel!=null&&n._dropdownViewModel.dropdownList.length>1?n.hideParent.invoke():n._popOutButtonViewModel.isPopOutInListMode()||n.hideParent.invoke()})),this._popOutElement=this._popOutButtonViewModel.buildPopOut(),this._viewModelInitialized=!0)},n.prototype._createDropdownListData=function(){for(var n,t=this,r=[],i=0;i<this.filterItem.options.length;i++)n=this.filterItem.options[i],r.push({value:n.value,name:n.label,isSelected:n.isSelected,cssClass:"variant",handler:function(n,i){t._applyViewModelSelection();t.filterOptionClicked.invoke(t.filterItem.options[i])}});return r},n.prototype._applyViewModelSelection=function(){for(var n=0;n<this._dropdownViewModel.dropdownList.length;n++)this.filterItem.options[n].isSelected=this._dropdownViewModel.dropdownList[n].isSelected},n.popOutCssClass="routesPopOut",n}(),lr=function(n){function t(t,i,r,u,f){var e=n.call(this,u)||this;return e.setDropdownData(t,i,r,f),e}return s(t,n),t.prototype.setDropdownData=function(t,i,r,u){n.prototype.setDropdown.call(this,this._populateDropDownListData(t,i,r,u))},t.prototype.onEntryClicked=function(n){if(!(n<0)&&!(n>=this.dropdownList.length)){var t=this.dropdownList[n].options,i;i=t.requestState?u.taskProcessDataHandlerKey:u.taskDataHandlerKey;f.invokeHandler(i,t)}},t.prototype._populateDropDownListData=function(n,t,r){var f=[],u,s,e;if(!n||!n.length||!t||!r)return f;var c=t,o=n[0].data.days,l=n[0].processorId;for(u=0;u<=o;u++)(s=k.getItineraryDayOptions(c,l,u),e=i.L_MoveToDay.replace("{0}",u+1),u===o&&(e=i.L_MoveToNewDay,h.isInPrivateMode))||f.push({name:e,options:s});return f},t}(st),ar=function(n){function t(t,i,r,u){var f=n.call(this,r)||this;return f._address=u,f.setDropdownData(t,i),f.contextMenuFinished=new w,f}return s(t,n),t.prototype.setDropdownData=function(t,i){n.prototype.setDropdown.call(this,this._populateDropDownListData(t,i))},t.prototype.setAddress=function(n){this._address=n},t.prototype.buildCategoryIcons=function(n,t,i){var u,f,r;if(this._categories&&this._categories.length!==0&&t&&t.length!==0)for(u=t.select(".nearbyCatIcon"),f=this._categories.length,r=0;r<f;r++)this._drawIcon(n,this._categories[r],u[r],i)},t.prototype.onEntryClicked=function(n){if(n>=0&&n<this.dropdownList.length){var t=this.dropdownList[n];t.options&&t.options.type===l.nearbyTransitTask?f.invokeHandler(u.taskDataHandlerKey,t.options):f.invokeHandler(u.taskProcessDataHandlerKey,t.options);f.invokeHandler(u.instrumentationDataHandlerKey,t.instData);this.contextMenuFinished.invoke()}},t.prototype._populateDropDownListData=function(n,i){var f=[],r,e,o,u;if(!n||n.length===0||!i)return f;for(this._categories=n,r=0;r<this._categories.length;r++)e={logData:{feature:kt.NearbyControl,action:d.Clicked,data:{query:this._categories[r].Name,lat:i.latitude,lon:i.longitude}}},this._categories[r].Id===t.nearbyTransitCategoryId?(o={location:i,title:this._address,entryPoint:2},f.push({name:this._categories[r].Name,options:{state:o,type:l.nearbyTransitTask},cssClass:"nearbyItem",instData:e,iconClass:"nearbyCatIcon"})):(u={},u.entryPoint=y.ContextMenu,u.query=this._categories[r].Name,u.point=[i.latitude,i.longitude],f.push({name:this._categories[r].Name,options:{requestState:u,type:l.localSearchTask},cssClass:"nearbyItem",instData:e,iconClass:"nearbyCatIcon"}));return f},t.prototype._drawIcon=function(n,i,r){var f=i.Id,u=null;a._isHighContrastMode()&&(u=t._suggestionHighContrastIconColor);n.getCategoryIconTemplate(function(n){var t=n&&n.icon;t&&r.appendChild(t.renderIcon()[0])},f,u,24,24)},t._suggestionRoadIconColor="rgb(64,64,64)",t._suggestionAerialIconColor="rgba(255, 255, 255, 0.8)",t._suggestionHighContrastIconColor="rgb(255, 255, 0)",t.nearbyTransitCategoryId="250",t}(st),ce=function(n){function t(){var r=n.call(this)||this;r.resources=i;r.defineProperty("linkTitle",null,function(n,t){return r._convertSaveMessage(n,t)});r.defineProperty("showLink",null,null,{defaultValue:!0});r._baseTemplate='<div class="saveLink" data-tag="saveLink" style:display="{TemplateBinding ShowLink Converter=displaySeeItLink}">{0}<\/div>';var f=i.L_SeeIt,e="seeItLink"+(f.indexOf("<link>")!==0?" spaceBeforeLink":""),o=t._linkStart.replace("{0}",e),u=f.replace("<link>",o).replace("<\/link>",t._linkEnd);return u=u.replace("{0}",'<TextBlock Text="{TemplateBinding LinkTitle}" />'),r._templateString=r._baseTemplate.replace("{0}",u),r._resetTemplate(r._templateString),r.popupLinkClicked=new w,r}return s(t,n),t.prototype._resetTemplate=function(n){var t=this;this.setTemplate(new g(n,{onPopOutLinkClick:function(n){return t._popupLinkClicked(n)},displaySeeItLink:function(n){return t.displaySeeItLink(n)}}))},t.prototype._popupLinkClicked=function(n){(n&&n.preventDefault&&n.preventDefault(),n.type!=="pointerup"||r(".mapContainer .MicrosoftMap").has(n.target))&&this.popupLinkClicked.invoke(n)},t.prototype.displaySeeItLink=function(n){return n?"":"none"},t.prototype._convertSaveMessage=function(n){return n&&n.length>0||(n=i.L_Favorite_Text),n},t._linkStart='<a href="#" class="{0}" data-tag="seeItLink" event:click="onPopOutLinkClick" event:touchend="onPopOutLinkClick" role="button">',t._linkEnd="<\/a>",t._linkText="",t}(dt);g.registerControl("PopUpMessageControl",ce);var le=function(n){function t(t,i,r,u,f,e,o,s){var h=n.call(this,t,o)||this;return h.setDropdownData(null,r,u,f,e,s,null,i),h}return s(t,n),t.prototype.setDropdownData=function(t,i,r,u,f,e,o,s){n.prototype.setDropdown.call(this,this._populateSaveListData(s,i,r,u,f,e))},t.prototype.onEntryClicked=function(n){if(!(n<0)&&!(n>=this.dropdownList.length)){var t=this.dropdownList[n].options,i;i=t.requestState?u.taskProcessDataHandlerKey:u.taskDataHandlerKey;f.invokeHandler(i,t)}},t.prototype._populateSaveListData=function(n,t,r,u,f,e){var w=this,l=[],o,a,c;if(!t||!r||!e)return l;o=t;o.getImageUrl()&&o.getImageUrl().length>0&&(a=o.getImageUrl());var p=k.getItineraryAddItemOptions(o.getTitle(),r,t.id,a,u,o.categoryId,o.interests,o.stayDuration),s=e.logData.data,v=s&&s.EP,b=function(){w.contextMenuFinished.invoke()},tt=h.features.collections;v!==y.ContextMenu&&this._pushMostRecentlyUsedListEntries(l,p.requestState.itineraryItem,b,p,f,u,v);var d=o.getSegmentTypes&&o.getSegmentTypes(),g=o.getPrimaryCategoryName&&o.getPrimaryCategoryName(),nt=k.createNewItineraryOption(o.getTitle(),r,t.id,a,u,o.categoryId,o.interests,o.stayDuration,d,g,o.addressFields,f);return l.push({name:i.L_CreateNewItinerary,options:nt,iconClass:"newItinerary icon"}),c=k.getMyPlacesTaskOptions(o.getTitle(),r,null,o.getAddress()),c.activateOptions={parentId:u},c.state.data.id=t.id,c.state.entryPoint=s&&(s.EP&&s.EP===y.LocalDetails||s.ID)?3:2,c.state.data.photoUrl=a,this._pushSaveToTempAction(l,c,f,v,!0),l},t}(di),ae=function(n){function t(t,i,r){var u=n.call(this,i)||this;return u.setDropdownData(t,null,r),u}return s(t,n),t.prototype.setDropdownData=function(t,i,r){var c=this,h,l,f,e,u,o,s;if(i){for(h=[],l=function(n,t){if(t<c.dropdownList.length){var i=c.dropdownList[t].value;i&&window.open(i)}},e=0;e<i.length;e++){if(u=i[e],r){f={logData:{feature:r.logData.feature,action:r.logData.action,data:{}}};o=r.logData.data;for(s in o)o.hasOwnProperty(s)&&(f.logData.data[s]=o[s]);f.logData.data.Source=u.DisplayName}h.push({name:u.DisplayName,value:u.Url,handler:l,iconClass:u.DisplayName+" icon",instData:f})}n.prototype.setDropdown.call(this,h)}},t}(st),ve=function(n){function t(t,i){var r=n.call(this,i)||this;return r.setDropdown(t),r.taskBarListDropDownTemplate=du,r}return s(t,n),t.prototype.boolTodisplay=function(n){return n?"inline-block":"none"},t.prototype.onEntryClicked=function(t){if(t>=0&&t<this.dropdownList.length){var i=this.dropdownList[t];i.cssClass==="feedbackMenuLink"?i.mouseoverhandler.call(this,null,t):n.prototype.onEntryClicked.call(this,t)}},t.prototype.onEntryMouseover=function(n){var r=this,i;n>=0&&n<this.dropdownList.length&&(i=this.dropdownList[n],i.cssClass==="feedbackMenuLink"&&(window.clearTimeout(t._mouseOverDelayHandle),t._mouseOverDelayHandle=Microsoft.Maps.setTimeout(function(){i.mouseoverhandler.call(r,null,n)},t._mouseTimeout)))},t.prototype.onEntryMouseout=function(n){if(n>=0&&n<this.dropdownList.length){var i=this.dropdownList[n];i.mouseouthandler&&(window.clearTimeout(t._mouseOverDelayHandle),i.mouseouthandler.call(this,null,n))}},t._mouseTimeout=250,t}(st),ai=function(n){function t(){var i=this,r;return t.instance?(t.instance.tryUpdateIsSignedIn(),t.instance):(r={},i=n.call(this,r)||this,r.defineProperty("isSignedIn",function(n,t){return i._onSignInStateChange(n,t)}),i.notifySignedIn=new w,sj_evt&&sj_evt.bind("wl:auth",function(){i._updateIsSignedIn()}),i._updateIsSignedIn(),t.instance=i,i)}return s(t,n),t.prototype.dispose=function(){n.prototype.dispose.call(this);t.instance=null},t.prototype.signIn=function(){typeof Identity!="undefined"&&Identity.popupAuthenticate&&(Identity.headerLoginMode=1,Identity.popupAuthenticate("WindowsLiveId"))},t.prototype.tryUpdateIsSignedIn=function(){var t,n,i;yi.getFunctionalTestHooksEnabled()||(t=this.getIsSignedIn(),n=!1,typeof Identity!="undefined"&&(i=Identity.wlProfile&&Identity.wlProfile(),n=i!==null),n!==t&&(this.setIsSignedIn(n),f.invokeHandler(u.instrumentationDataHandlerKey,{logData:{feature:"CX",action:"SI",data:{BSI:this.getIsSignedIn()}},isMapsAction:!0})))},t.prototype._onSignInStateChange=function(n,t){this.notifySignedIn.invoke(t)},t.prototype._updateIsSignedIn=function(){if(typeof Identity!="undefined"){var n=Identity.wlProfile&&Identity.wlProfile();this.setIsSignedIn(n!==null);f.invokeHandler(u.instrumentationDataHandlerKey,{logData:{feature:"CX",action:"SI",data:{BSI:this.getIsSignedIn()}},isMapsAction:!0})}},t.instance=null,t}(ot),ye=function(n){function t(){var t=n.call(this)||this;return t.signInStateHandler=new ai,t.resources=i,t.defineProperty("signInMessage",null,function(n,i){return t._convertSignInMessage(n,i)}),t._baseTemplate='<div class="signInControlTop" style:display="{TemplateBinding signInStateHandler.IsSignedIn Converter=displaySignInPopUpControl}"><div class="signInMessage">{0}<\/div>{1}<\/div>',t._templateString=t._baseTemplate.replace("{0}","").replace("{1}",""),t._resetTemplate(t._templateString),t.signInClicked=new w,t.signedIn=new w,t.signInStateHandler.notifySignedIn.add(function(n){n&&t.signedIn&&t.signedIn.invoke()}),t}return s(t,n),t.prototype.displaySignInPopUpControl=function(){return this.signInStateHandler.tryUpdateIsSignedIn(),this.signInStateHandler.getIsSignedIn()?"none":"block"},t.prototype._resetTemplate=function(n){var t=this;this.setTemplate(new g(n,{onSignInLinkClick:function(n){return t._onSignInLinkClick(n)},displaySignInPopUpControl:function(n){return t.displaySignInPopUpControl(n)}}))},t.prototype._onSignInLinkClick=function(n){f.invokeHandler(u.instrumentationDataHandlerKey,{logData:{feature:"CX",action:"SI",data:{SGNIN:"SigningIn"}},isMapsAction:!0});n.preventDefault();this.signInStateHandler.signIn();this.signInClicked.invoke(n);n&&n.preventDefault&&n.preventDefault()},t.prototype._convertSignInMessage=function(n){var i="",r="",u;if(n)switch(n.indexOf("<link>")){case-1:i=n;u=t._cardifiedSignInButton;r=u.replace("{0}",this.resources.L_SignInLink_Text);break;case 0:i=n.replace("<link>",t._linkStart).replace("<\/link>",t._linkEnd);break;default:i=n.replace("<link>",t._linkStartSpaceBefore).replace("<\/link>",t._linkEnd)}else i=t._linkStart.concat(this.resources.L_SignInLink_Text,t._linkEnd);return this._templateString=this._baseTemplate.replace("{0}",i).replace("{1}",r),this._resetTemplate(this._templateString),n},t._linkStart='<a href="#" class="signInLink" event:click="onSignInLinkClick" event:touchend="onSignInLinkClick" data-tag="signInLink">',t._linkStartSpaceBefore='<a href="#" class="signInLink spaceBeforeLink" event:click="onSignInLinkClick" event:touchend="onSignInLinkClick" data-tag="signInLink">',t._linkEnd="<\/a>",t._cardifiedSignInButton='<a href="#" class="signInButton secondaryButton" event:click="onSignInLinkClick" event:touchend="onSignInLinkClick" data-tag="signInLink">{0}<\/a>',t}(dt);g.registerControl("SignInPopUpControl",ye);var vr=function(){function n(){}return n.processResponse=function(n){var u=n&&n.inData&&n.inData.requestState&&n.inData.requestState,t=u&&u.action,i,r;if(n&&n.outData&&n.outData.length!==0){if(i=n.outData&&n.outData[0].data,i.notSignedIn)return 2;if(r=i.actionSucceeded,t===v.SetHome)return r?10:i.favorite?15:i.maxFavorites?16:9;if(t===v.SetWork)return r?12:i.favorite?15:i.maxFavorites?16:11;if(t===v.AddFavorite)return r?8:i.favorite?15:i.maxFavorites?16:7;if(t===v.AddToTemporaryCollection)return r?20:i.favorite?22:7;if(t===v.UpdateEntity)return r?25:7;if(t===v.AddEntity)return r&&i.collections?6:i.failureMessage?24:i.collections?17:3;if(i.collections.length===0){if(t===v.GetAllCollectionNamesAndIds)return 4;if(t===v.GetActiveTasks)return 13}else{if(t===v.GetAllCollectionNamesAndIds)return u.isMove?23:5;if(t===v.GetActiveTasks)return 13}}else return t&&t===v.GetActiveTasks?13:t&&t===v.AddToTemporaryCollection?21:1;return 1},n}(),pe=function(){function n(n){this._events=[];this._map=n;this._viewModelInitialized=!1;this.hideParent=new w;this.moveToNewCollection=new w;var t=h.features.collections}return n.prototype.setEntityData=function(n,t,i){this._entity=n;this._options=t;this._rootElement=i},n.prototype.setAddToRouteMode=function(n,t){this._directionsButton=n;this._addToRouteMode=t},n.prototype.setSaveButton=function(n){this._saveButton=n},n.prototype.processDirectionsData=function(n,t){this._showDirectionsPopOut(n.outData,t,n.inData.requestorState)},n.prototype.processCollectionsData=function(n,t){this._showCollectionsPopOut(n,t,n.inData.requestorState)},n.prototype.processTravelMoveToData=function(n,t){this._showTravelMoveToPopOut(n.outData,t,n.inData.requestorState)},n.prototype.processSaveWithTravelData=function(n,t){var u=t&&t.type==="mouseover",i;this._saveButton=t&&r(t.target);this.openItineraryTaskInfo=n.outData;i=n.inData.requestorState;i.isSignedIn?this.collectionMenuButtonClicked(t,i.location,i.instData,i.entryPoint):this._showSaveWithTravelPopOut(n.outData,i)},n.prototype.directionButtonClicked=function(n,t,i,e){n&&n.preventDefault();this._directionsButton=r(n.target);var o={requestorType:this._options.requestorType,requestorId:this._options.requestorId,type:l.directionsTask,requestState:{action:0},requestorState:{location:t,instData:i,entryPoint:e},useActiveTasks:!0};f.invokeHandler(u.taskProcessDataHandlerKey,o)},n.prototype.scheduleContactTourButtonClicked=function(n,t,i){n&&n.preventDefault();this._scheduleContactButton=n&&r(n.target);this._showScheduleContactPopOut(t,i)},n.prototype.collectionButtonClicked=function(n,t,i,u){var f,e,o,s;n&&n.preventDefault();n&&(this._saveButton=r(n.target));f=this._entity;e={title:f.getTitle(),address:f.getAddress&&f.getAddress(),location:t,id:f.id};this.entityNickName&&this.entityOriginalName&&(e.nickName=this.entityNickName,e.title=this.entityOriginalName);this.entityDescription&&(e.description=this.entityDescription);o=f.getImageUrl();o&&o.length&&(e.photoUrl=o);s=v.AddToTemporaryCollection;this._trySaveProcessCall(e,s,i,u,!0);this._logData(i)},n.prototype.collectionMenuButtonClicked=function(n,t,i,e,o){var s,h;n&&n.preventDefault();n&&(this._saveButton=r(n.target));s={action:v.GetAllCollectionNamesAndIds};o&&(s.isMove=!0);h={requestorType:this._options.requestorType,requestorId:this._options.requestorId,type:l.collectionsTask,requestState:s,requestorState:{location:t,instData:i,entryPoint:e}};f.invokeHandler(u.taskProcessDataHandlerKey,h);this._logData(i)},n.prototype.travelMoveToButtonClicked=function(n,t,i,e){n&&n.preventDefault();this._travelButton=r(n.target);var o={requestorType:this._options.requestorType,requestorId:this._options.requestorId,type:l.itineraryDetailsTask,requestState:{action:2},requestorState:{location:t,instData:i,entryPoint:e},taskId:this._options.requestorId};f.invokeHandler(u.taskProcessDataHandlerKey,o)},n.prototype.saveWithTravelButtonClicked=function(n,t,i,e,o){n&&n.preventDefault();this._saveButton=r(n.target);var s={requestorType:this._options.requestorType,requestorId:this._options.requestorId,type:l.itineraryDetailsTask,requestState:{action:0},requestorState:{location:t,instData:i,entryPoint:e,isSignedIn:o},useActiveTasks:!0};f.invokeHandler(u.taskProcessDataHandlerKey,s);o||this._logData(i)},n.prototype.nearbyButtonClicked=function(n,t,i,u,f,e){var o=this,s,h,c;n&&n.preventDefault();this._nearbyButton=r(n.target);this._initializeViewModels(t);s=this._rootElement?this._rootElement:r("#transientLens");this._nearbyListDropdownViewModel?(this._nearbyListDropdownViewModel.setAddress(e),this._nearbyListDropdownViewModel.setButtonElement(this._nearbyButton),this._nearbyListDropdownViewModel.setDropdownData(i,t)):(this._nearbyListDropdownViewModel=new ar(i,t,this._nearbyButton,e),this._events.push(this._nearbyListDropdownViewModel.contextMenuFinished.add(function(){o._popOutButtonViewModel.setIsDisplayed(!1);o._nearbyListDropdownViewModel.isDisplayed=!1;o.hideParent.invoke()})));this._popOutButtonViewModel.setAriaLabel(null);this._popOutButtonViewModel.setDropdownClass("popOutTop");this._updatePopOutListDropdownViewModel(this._nearbyListDropdownViewModel);this._nearbyListDropdownViewModel.isDisplayed=!0;h=this._nearbyButton&&this._nearbyButton.length>0?this._nearbyButton[0].className:"";this._popOutButtonViewModel.setParentClass(h);this._nearbyButton.add_class("selected");c=s.select("div.nearbyPopOut");c.append(this._popOutElement);this._nearbyListDropdownViewModel.buildCategoryIcons(u,s,f);this._displayPopOut();this._popOutElement.select&&this._popOutElement.select(".popOutTop").set_attr("aria-hidden","false")},n.prototype.hidePopout=function(){this._popOutButtonViewModel&&this._popOutButtonViewModel.setIsDisplayed(!1)},n.prototype.dispose=function(){this._popOutButtonViewModel&&this._popOutButtonViewModel.dispose()},n.prototype._showDirectionsPopOut=function(n,t,e){var o=e.location,s,h,c;this._initializeViewModels(o);this._directionsListDropdownViewModel.setButtonElement(this._directionsButton);this._directionsListDropdownViewModel.setDropdownData(n,this._entity,o,e.instData);this._directionsListDropdownViewModel.dropdownList.length>1?(s=this._rootElement?this._rootElement:r("#transientLens"),h=s.select("div.directionsPopOut"),this._popOutButtonViewModel.setAriaLabel(i.L_DirectionsPopOutAriaLabel),this._popOutButtonViewModel.setDropdownClass("popOutTop"),c=this._directionsButton&&this._directionsButton.length>0?this._directionsButton[0].className:"",this._popOutButtonViewModel.setParentClass(c),this._updatePopOutListDropdownViewModel(this._directionsListDropdownViewModel),h.append(this._popOutElement),this._displayPopOut(),this._popOutElement.select&&this._popOutElement.select(".popOutTop").set_attr("aria-hidden","false")):(this.hideParent.invoke(),f.invokeHandler(u.taskDataHandlerKey,t))},n.prototype._showSaveWithTravelPopOut=function(n,t){var o=t.location,u,e,f,s;this._initializeViewModels(o);u=this._saveWithTravelDropdownViewModel;u.setButtonElement(this._saveButton);u.setDropdownData(null,this._entity,o,this._options.requestorId,this._options.requestorType,t.instData,null,n);u&&u.dropdownList.length>0?(e=this._rootElement?this._rootElement:r("#transientLens"),f=e.select("div.collectionsPopOut"),this._handleCollectionsPopoutLocation(f,e),this._popOutButtonViewModel.setAriaLabel(i.L_TravelPopOutAriaLabel),s=this._saveButton&&this._saveButton.length>0?this._saveButton[0].className:"",this._popOutButtonViewModel.setParentClass(s),this._popOutButtonViewModel.setDropdownClass("popOutTop listDropdown"),this._updatePopOutListDropdownViewModel(this._saveWithTravelDropdownViewModel),f.append(this._popOutElement),this._displayPopOut(),this._popOutElement.select&&this._popOutElement.select(".popOutTop").set_attr("aria-hidden","false"),this._setPopoutFocus(f)):this.hideParent.invoke()},n.prototype._showScheduleContactPopOut=function(n,t){var f,e,i,o,u,s,h;this._initializeViewModels(null);f=this._scheduleTourDropdownViewModel;f&&(f.setButtonElement(this._scheduleContactButton),f.setDropdownData(null,n,t));f&&f.dropdownList.length>0?(e=this._rootElement?this._rootElement:r("#transientLens"),i=e.select("div.scheduleContactPopOut"),(!i||i.length<1)&&(i=r(document.createElement("div")),i.add_class("bm_popout scheduleContactPopOut")),o="popOutTop listDropdown scheduleContact",u=this._scheduleContactButton&&this._scheduleContactButton.get_ancestor(3),u&&u.has_class("b_sgmbtns")?u.append(i):(this._handleCollectionsPopoutLocation(i,e,"House"),s=u&&u[0]&&u[0].childElementCount||3,o+=s===1?" leftScheduleContact":s===2?" middleScheduleContact":" rightScheduleContact"),this._popOutButtonViewModel.setAriaLabel("scheduleTourLabel"),h=this._scheduleContactButton&&this._scheduleContactButton.length>0?this._scheduleContactButton[0].className:"",this._popOutButtonViewModel.setParentClass(h),this._popOutButtonViewModel.setDropdownClass(o),this._updatePopOutListDropdownViewModel(this._scheduleTourDropdownViewModel),i.append(this._popOutElement),this._displayPopOut(),this._popOutElement.select&&this._popOutElement.select(".popOutTop").set_attr("aria-hidden","false"),this._setPopoutFocus(i)):this.hideParent.invoke()},n.prototype._handleCollectionsPopoutLocation=function(n,t,i){var u,r,f,e,o,s;(i===void 0&&(i=""),u=t.select(".b_subModule"),!u||u.length<1)||(r=null,i||(f=this._entity,e=f&&f.getSegmentTypes&&f.getSegmentTypes(),i=e&&e.length&&e[0]||f&&f.getSearchCategory&&f.getSearchCategory()),a._isHouseCategory(i))&&(o=u.select(".b_actionBtns"),s=u.select(".b_mapbtns"),s&&s.length>0&&o&&o.length>0?(n.add_class("houseCollectionsPopout"),o.insertBefore(n,s)):(r=u.select(">.b_mort"),r&&r.length!==0||(r=u.select(">.b_subscomp")),r&&r.length!==0||(r=u.select(">.b_lBottom.b_snippet")),r&&r.length!==0||(r=u.select(">.b_infoCardCustFacts")),r&&r.length!==0||(r=u.select(".infoCardIcons")),r&&r.length!==0||(r=u.select(".b_vList")),r&&r.length>0&&u.insertBefore(n,r)))},n.prototype._showTravelMoveToPopOut=function(n,t,u){var e=u.location,f,o,s,h;this._initializeViewModels(e);f=this._itineraryDaysDropdownViewModel;f&&f.setButtonElement(this._travelButton);f&&f.setDropdownData(n,this._entity,e,u.instData);f&&f.dropdownList.length>0?(o=this._rootElement?this._rootElement:r("#transientLens"),s=o.select("div.travelPopOut"),this._popOutButtonViewModel.setAriaLabel(i.L_TravelPopOutAriaLabel),h=this._travelButton&&this._travelButton.length>0?this._travelButton[0].className:"",this._popOutButtonViewModel.setParentClass(h),this._popOutButtonViewModel.setDropdownClass("popOutTop"),this._updatePopOutListDropdownViewModel(f),s.append(this._popOutElement),this._displayPopOut(),this._popOutElement.select&&this._popOutElement.select(".popOutTop").set_attr("aria-hidden","false")):this.hideParent.invoke()},n.prototype._showCollectionsPopOut=function(n,t,r){var u=vr.processResponse(n),r;switch(u){case 2:this.showSignInMessage(r.location);break;case 1:case 4:case 5:case 23:this._showCollectionsList(n.outData[0].data,t,r.location,r.instData,u===23);break;case 3:this._showAddEntityMessage(!1,n.inData.requestState,n.inData.requestorState);break;case 24:this._showAddEntityMessage(!1,n.inData.requestState,n.inData.requestorState,n.outData[0].data);break;case 6:this._showAddEntityMessage(!0,n.inData.requestState,n.inData.requestorState,n.outData[0].data);break;case 7:this._showCollectionsMessage(i.L_AddFavoriteFailed);break;case 15:this._showCollectionsMessage(i.L_AddFavoriteExists_Text);break;case 22:this._showCollectionsMessage(i.L_AddTemporaryExists);break;case 16:this._showCollectionsMessage(i.L_TooManyFavorites);break;case 8:this._showAddFavoriteMessage(n.inData.requestState,n.inData.requestorState,n.outData[0].data);break;case 20:this._showAddTemporaryMessage(n.inData.requestState,n.inData.requestorState,n.outData[0].data);break;case 21:r=n.inData.requestorState;this._trySaveProcessCall(n.inData.requestState.data,v.AddToTemporaryCollection,r.instData,r.entryPoint);break;case 9:this._showCollectionsMessage(i.L_SetHomeFailed);break;case 10:this._showCollectionsMessage(i.L_SetHomeSucceeded);break;case 11:this._showCollectionsMessage(i.L_SetWorkFailed);break;case 12:this._showCollectionsMessage(i.L_SetWorkSucceeded);break;case 13:this._openCollection(n.inData.requestState,n.inData.requestorState,n.outData);break;case 25:this._showCollectionsMessage(i.L_EntityUpdateSucceeded);break;case 17:this._showAddEntityMessage(!0,n.inData.requestState,n.inData.requestorState,n.outData[0].data)}},n.prototype.showSignInMessage=function(n,t){var u,f,e;this._initializeViewModels(n);u=this._rootElement?this._rootElement:r("#transientLens");f=u.select("div.collectionsPopOut");this._collectionsPopOutMessageViewModel.title=t?i.L_SignInRequiredItinerary:i.L_SignInRequired;this._collectionsPopOutMessageViewModel.linkTitle=null;this._collectionsPopOutMessageViewModel.linkData=null;this._collectionsPopOutMessageViewModel.setButtonElement(this._saveButton);this._popOutButtonViewModel.setPopOutTemplate(this._signInControlTemplate);e=this._travelButton&&this._travelButton.length>0?this._travelButton[0].className:"";this._popOutButtonViewModel.setParentClass(e);this._saveButton.add_class("selected");this._popOutButtonViewModel.setPopOut(this._collectionsPopOutMessageViewModel);f.append(this._popOutElement);this._displayPopOut()},n.prototype._showAddEntityMessage=function(n,t,r,u){var e={action:v.GetActiveTasks,collectionId:t.collectionId,data:t.data,entityId:u&&u.entityId},f="",o="",s;n?(t.collectionId&&(f=e.entityId?i.L_SavedCollection.replace("{0}",t.data.title):i.L_EntityPreviouslySaved.replace("{0}",t.data.title)),o=r.title,s={type:l.collectionsTask,requestorType:this._options.requestorType,requestorId:this._options.requestorId,requestState:e,requestorState:r,useActiveTasks:!0}):f=u?u.failureMessage:i.L_SaveFailed.replace("{0}",r.title).replace("{1}",t.data.title);this._showCollectionsMessage(f,o,null,s)},n.prototype._showAddTemporaryMessage=function(n,t,r){var e={action:v.GetActiveTasks,data:n.data,entityId:r&&r.entityId,collectionId:r&&r.collections&&r.collections.length&&r.collections[0].id},u="",o=i.L_AddTemporaryCollectionTitle,f,s;r&&r.entityId&&(u=i.L_AddFavoriteSucceeded.replace("{0}",n.data.title),s=r.taskId,f={type:l.collectionsTask,requestorId:this._options.requestorId,requestorType:this._options.requestorType,requestState:e,requestorState:t,useActiveTasks:!0});this._showCollectionsMessage(u,o,null,f,null,!0)},n.prototype._showAddFavoriteMessage=function(n,t,r){var e={action:v.GetActiveTasks,data:n.data,entityId:r&&r.entityId},u="",f;r.entityId&&(u=i.L_AddFavoriteSucceeded.replace("{0}",n.data.title),f={type:l.collectionsTask,requestorType:this._options.requestorType,requestorId:this._options.requestorId,requestState:e,requestorState:t,useActiveTasks:!0});this._showCollectionsMessage(u,"",null,f)},n.prototype._showCollectionsMessage=function(n,t,u,f,e,o){var s,c,l,h;this._initializeViewModels(null);s=this._rootElement?this._rootElement:r("#transientLens");c=s.select("div.collectionsPopOut");this._handleCollectionsPopoutLocation(c,s);this._collectionsPopOutMessageViewModel.setParentClass(s[0].className);this._collectionsPopOutMessageViewModel.title=n;this._collectionsPopOutMessageViewModel.linkTitle=t||"";this._collectionsPopOutMessageViewModel.editButtonTitle=i.L_EditFavorite_Text;this._collectionsPopOutMessageViewModel.closeButtonTitle=i.L_Dlg_Close;this._collectionsPopOutMessageViewModel.saveButtonTitle=i.L_SaveUpdateButton;this._collectionsPopOutMessageViewModel.updateNicknameMessage=i.L_UpdateNicknameMessage;this._collectionsPopOutMessageViewModel.linkData=u;this._collectionsPopOutMessageViewModel.processOptions=f;this._collectionsPopOutMessageViewModel.activateOptions=e;this._collectionsPopOutMessageViewModel.isTempCollectionMessage=o;this._collectionsPopOutMessageViewModel.setShowLink(u||f||e?!0:!1);this._collectionsPopOutMessageViewModel.saveNicknameClicked=!1;f&&f.requestState?(h=f.requestState,this._collectionsPopOutMessageViewModel.entityId=h.entityId,l=h.data&&h.data.nickName):e&&(this._collectionsPopOutMessageViewModel.requestorId=this._options.requestorId,this._collectionsPopOutMessageViewModel.requestorType=this._options.requestorType,this._collectionsPopOutMessageViewModel.entityId=e.state.entityId);this._collectionsPopOutMessageViewModel.setShowAnnotate(!l&&!!t);this._collectionsPopOutMessageViewModel.showFooter=this._collectionsPopOutMessageViewModel.entityId&&this._collectionsPopOutMessageViewModel.entityId.length>0?"":"none";this._collectionsPopOutMessageViewModel.setButtonElement(this._saveButton);this._popOutButtonViewModel.setTemplateToPopOutMessage();this._popOutButtonViewModel.setPopOut(null);this._popOutButtonViewModel.setPopOut(this._collectionsPopOutMessageViewModel);c.append(this._popOutElement);this._displayPopOut()},n.prototype._showCollectionsList=function(n,t,e,o,s){var h=this,c;this._initializeViewModels(e);c=function(){var e,n,o;h._collectionsListDropdownViewModel.dropdownList.length>1?(e=h._rootElement?h._rootElement:r("#transientLens"),n=e.select("div.collectionsPopOut"),h._popOutButtonViewModel.setAriaLabel(i.L_CollectionsPopOutAriaLabel),o=h._travelButton&&h._travelButton.length>0?h._travelButton[0].className:"",h._popOutButtonViewModel.setParentClass(o),h._popOutButtonViewModel.setDropdownClass("popOutTop listDropdown"),h._updatePopOutListDropdownViewModel(h._collectionsListDropdownViewModel),n.append(h._popOutElement),h._displayPopOut(),h._popOutElement.select&&h._popOutElement.select(".popOutTop").set_attr("aria-hidden","false"),h._setPopoutFocus(n)):f.invokeHandler(u.taskDataHandlerKey,t)};this._updateCollectionsListViewModel(n,e,o,c,s)},n.prototype._openCollection=function(n,t,i){var e=i&&i.length&&i[0].data,o=e&&e.taskId,r=n.collectionId?v.ViewCollection:v.ViewFavorites,s,h;this._collectionsPopOutMessageViewModel.isTempCollectionMessage&&(r=v.ShowTemporaryCollection);s=n.collectionId?{action:r,collectionId:n.collectionId,entryPoint:2}:{action:r,entityId:n.entityId,entryPoint:2};h={action:o?"focus":"activate",id:o,type:l.collectionsTask,state:s};f.invokeHandler(u.taskDataHandlerKey,h)},n.prototype._updatePopOutListDropdownViewModel=function(n){this._popOutButtonViewModel.setDropdown(n)},n.prototype._displayPopOut=function(){var n=this;Microsoft.Maps.setTimeout(function(){if(n._popOutButtonViewModel.setIsDisplayed(!0),n._popOutElement.select){var t=n._popOutElement.select(".dropdownFocusDummy");t&&t.length!==0||(t=n._popOutElement.select(".dropdownEntry"));t&&t.length>0&&t[0].focus()}},0)},n.prototype._initializeViewModels=function(n){var t=this;this._viewModelInitialized||(this._directionsListDropdownViewModel=new hr(null,this._entity,n,this._directionsButton,null,this._addToRouteMode),this._scheduleTourDropdownViewModel=new ae(null,this._scheduleContactButton,null),this._entity&&(this._saveWithTravelDropdownViewModel=new le(this._map,null,this._entity,n,this._options.requestorId,this._options.requestorType,this._saveButton,null),this._collectionsListDropdownViewModel=new di(this._map,this._saveButton,!1,this.entityNickName,this.entityOriginalName,this.entityDescription),this._collectionsListDropdownViewModel.setDropdownData(null,this._entity,n,this._options.requestorId,this._options.requestorType,null,function(){},this.openItineraryTaskInfo),this._events.push(this._collectionsListDropdownViewModel.newCollectionCreated.add(function(){t.hideParent.invoke();t._collectionsListDropdownViewModel.isMoveToMenu&&t.moveToNewCollection.invoke()})),this._events.push(this._collectionsListDropdownViewModel.contextMenuFinished.add(function(){t.hideParent.invoke()})),this.isItineraryContextMenu&&(this._itineraryDaysDropdownViewModel=new lr(null,this._entity,n,this._travelButton,null))),this._collectionsPopOutMessageViewModel=new ki(i.L_SignInRequired,null,null,this._saveButton),this._signInControlTemplate=new g(bu,{onPopOutLinkClick:function(n){return t._popOutButtonViewModel.onPopOutLinkClicked(n)},onSignedIn:function(){return t._saveButton.fireEvent("click")}}),this._popOutButtonViewModel=new gi(this._directionsListDropdownViewModel,this._collectionsPopOutMessageViewModel),this._events.push(this._popOutButtonViewModel.popOutHidden.add(function(){t._directionsListDropdownViewModel!=null&&t._directionsListDropdownViewModel.dropdownList.length>1?t.hideParent.invoke():t._popOutButtonViewModel.isPopOutInListMode()||t._popOutButtonViewModel.getPopOutTemplate()===t._signInControlTemplate||t._collectionsPopOutMessageViewModel.isTempCollectionMessage&&t._collectionsPopOutMessageViewModel.saveNicknameClicked?t._popOutButtonViewModel.isPopOutInListMode()&&t._nearbyListDropdownViewModel&&t._nearbyListDropdownViewModel.isDisplayed&&t.hideParent.invoke():t.hideParent.invoke();t._popOutElement.select&&t._popOutElement.select(".popOutTop").set_attr("aria-hidden","true")})),this._popOutElement=this._popOutButtonViewModel.buildPopOut(),this._popOutElement.getRootElement&&(this._popOutElement=r(this._popOutElement.getRootElement())),this._viewModelInitialized=!0)},n.prototype._updateCollectionsListViewModel=function(n,t,i,r,u){typeof u=="boolean"&&(this._collectionsListDropdownViewModel.isMoveToMenu=u);this.entityNickName&&(this._collectionsListDropdownViewModel.entityNickName=this.entityNickName);this.entityOriginalName&&(this._collectionsListDropdownViewModel.entityOriginalName=this.entityOriginalName);this.entityDescription&&(this._collectionsListDropdownViewModel.entityDescription=this.entityDescription);this._collectionsListDropdownViewModel.setButtonElement(this._saveButton);this._collectionsListDropdownViewModel.popOutRoot=this._popOutElement;this._collectionsListDropdownViewModel.setDropdownData(n,this._entity,t,this._options.requestorId,this._options.requestorType,i,r,this.openItineraryTaskInfo)},n.prototype._logData=function(n){f.invokeHandler(u.instrumentationDataHandlerKey,n)},n.prototype._trySaveProcessCall=function(n,t,i,r,e){var o={requestorType:this._options.requestorType,requestorId:this._options.requestorId,type:l.collectionsTask,requestState:{action:t,data:n},requestorState:{location:location,instData:i,entryPoint:r}};e&&(o.useActiveTasks=!0);f.invokeHandler(u.taskProcessDataHandlerKey,o)},n.prototype._setPopoutFocus=function(n){Microsoft.Maps.setTimeout(function(){a._setFocusOnFirstMenuItem(n)},100)},n}(),fi=function(n){function t(t,i,r,u,f,e,o){var s=n.call(this,t,i,null,null,null,e)||this;return s._taskDisplayState=r,s._menuUrl=u,s.entitySource=f,s.isRecommendationEntity=!1,s.categoryId=o,s}return s(t,n),t.prototype.getDirectionTaskOptions=function(n,t){var i=this.getDescription()||this.getTitle(),r=this.entitySource==1;return k.getDirectionTaskOptions(i,n,t,this.getTitle(),this.id,null,r)},t.prototype.getTaskDisplayState=function(){return this._taskDisplayState},t.prototype.getMenuUrl=function(){return this._menuUrl},t.prototype.setSegmentTypes=function(n){this._segmentTypes=n},t.prototype.getSegmentTypes=function(){return this._segmentTypes},t.prototype.getPrimaryCategoryName=function(){return this._primaryCategoryName},t.prototype.setPrimaryCategoryName=function(n){this._primaryCategoryName=n},t}(nr),n;(function(n){n[n.Search=1]="Search";n[n.Directions=2]="Directions";n[n.Streetside=3]="Streetside";n[n.Zoom=5]="Zoom";n[n.Menu=6]="Menu";n[n.DirectionsTo=7]="DirectionsTo";n[n.DirectionsFrom=8]="DirectionsFrom";n[n.AddToRoute=9]="AddToRoute";n[n.OpenNewCard=11]="OpenNewCard";n[n.Nearby=12]="Nearby";n[n.Coordinates=13]="Coordinates";n[n.SaveWithTempCollection=14]="SaveWithTempCollection";n[n.MoveTo=15]="MoveTo";n[n.Measure=16]="Measure";n[n.editName=17]="editName";n[n.editDescription=18]="editDescription";n[n.deleteName=19]="deleteName";n[n.deleteDescription=20]="deleteDescription";n[n.editHomeWork=21]="editHomeWork";n[n.BirdseyeV2=22]="BirdseyeV2";n[n.hideHomeWork=23]="hideHomeWork";n[n.addToItinerary=24]="addToItinerary";n[n.moveToAnotherDay=25]="moveToAnotherDay";n[n.saveToRecent=26]="saveToRecent";n[n.Remove=27]="Remove";n[n.Edit=28]="Edit"})(n||(n={}));var vt=function(){function e(t,i,u,f){var e=this,o,s;this._events=[];this._map=t;this._reverseGeocoder=i;o={templateText:gu,staticResources:{clickHandler:function(n){return e.clickHandler(n)},boolToDisplay:function(n){return e.boolToDisplay(n)}}};this._controlTemplate=u(o);this._events.push(this._map.viewChanged.add(function(){return e.hide()}));this._events.push(this._map.mapTapped.add(function(){return e.hide()}));this._events.push(this._map.mapZoomStarted.add(function(){return e.hide()}));this._events.push(this._map.primitiveTapped.add(function(){return e.hide()}));this._streetsideBubbleInfo=null;this.signInStateHandler=new ai;this._buttonGroupViewModel=f;this._hideTransientLensClickHandler=function(n){return e._onClick(n)};r(window).add_event("click,touchend",this._hideTransientLensClickHandler);this._hideTransientLensKeyDownHandler=function(n){return e._onKeyDown(n)};r(window).add_event("keydown",this._hideTransientLensKeyDownHandler);this.actionList=[];this.actionList.push(n.DirectionsTo);this.actionList.push(n.DirectionsFrom);this.actionList.push(n.AddToRoute);this.actionList.push(n.Search);h.isInPrivateMode||this.actionList.push(n.saveToRecent);s=t.getContainer();s.instanceAsync("MostRecentlyUsedList",function(n){e._mostRecentlyUsedList=n});ci&&ci.isEnabled&&this.actionList.push(n.Streetside);a._isFeatureEnabled("birdseyeV2UI")&&!this._map.getMapOptions().disableBirdseye&&this._map.getMapTypes()[rt.birdseyeV2]&&this.actionList.push(n.BirdseyeV2);bt&&bt.isEnabled&&!h.isInPrivateMode&&this.actionList.push(n.SaveWithTempCollection);this.actionList.push(n.Remove);this.actionList.push(n.Zoom);bt&&bt.isEnabled&&this.actionList.push(n.Measure);si&&si.contextMenuNearbyCategories.length>0&&this.actionList.push(n.Nearby);this.actionList.push(n.Coordinates);this.invalidateLayer=new w;this.moveToNewCollection=new w;this._events.push(this._buttonGroupViewModel.hideParent.add(function(){return e.hide()}));this._events.push(this._buttonGroupViewModel.moveToNewCollection.add(function(){return e.moveToNewCollection.invoke()}));this._vectorImage=this._getVectorImage();this._ignoreHideEventOnce=!1;this._isDirectionsPopOutVisible=!1;this._isCollectionsPopOutVisible=!1;this._isTravelPopOutVisible=!1;this._isNearbyPopOutVisible=!1;this._populateNearbyCategories();this._adjustmentValueForTop=0;this._secondaryMenuOpen=!1}return e.prototype.selectorReady=function(){var n=this;return this._templateSelector?this._templateSelector.selectorReady():this._map.getTemplateSelector().then(function(t){return n._templateSelector=t,n._templateSelector.selectorReady()})},e.prototype.getPrimitive=function(){return this._primitive},e.prototype.getActionList=function(){var t=[];return this.actionList.forEach(function(i){t.push(n[i])}),t},e.prototype.getButtonGroupViewModel=function(){return this._buttonGroupViewModel},e.prototype.setOptions=function(n){this._options=n},e.prototype.processDirectionsData=function(n){var u,r,t,i;if(this._primitive){if(this._directionsProcessed=!0,this._directionsListCount=0,u=null,n.outData&&n.outData.length>0){for(r=0,t=0;t<n.outData.length;t++)i=n.outData[t].data,i&&!i.longDistanceIntent&&(i.routeTitle&&i.mode!==gt.transit&&(u||(u=n.outData[t].processorId),r++),i.activationState===1&&(this._activeDirectionTaskId=n.outData[t].processorId));r>0&&(this._directionsProcessData=n,this._directionsListCount=r,r===1&&(this._addToRouteDirectionTaskId=u))}this.updateTransientLens(n.inData)}},e.prototype.processTravelData=function(n){this._travelProcessed=!0;this._travelProcessData=n;this.updateTransientLens(n.inData)},e.prototype.updateTransientLens=function(i){var e=this,r,u,f;this._directionsProcessed&&(!b||!b.isEditable||this._travelProcessed)&&(this._directionsProcessed=!1,this._travelProcessed=!1,r=i.requestorState.location,this._populateActions(r),ci&&ci.isEnabled&&this._map.getContainer().instanceAsync("StreetsideMiniBootstrapper",function(n){n.isAvailable(r,function(n){return e._isStreetsideAvailable(n,r)})}),this._map.getMapType().id!==rt.birdseyeV2&&this.actionList&&this.actionList.indexOf(n.BirdseyeV2)>=0&&(u=void 0,f=this._map.getView(),f&&f.cameraLocation&&(u=r.clone(),u.altitude=f.cameraLocation.altitude),t.BirdseyeV2Manager.getIsBirdseyeV2Available(this._map.getConfig(),u||r,null,function(n){e._isBirdseyeV2Available(n)},this._map.getViewport())),this.showOverlay(),this._updateOverlayPosition(i.requestorState.args,i.requestorState.preventInvalidate),this._updateEntityData())},e.prototype.showOverlay=function(){var n={overlayTemplate:this._controlTemplate,overlayEvent:0};ti.hideOverlay(this._map,this._sourcePrimitive);ti.showOverlay(this._map,n,this._primitive)},e.prototype.processCollectionsData=function(n){var t=null,i=n&&n.inData&&n.inData.requestState&&n.inData.requestState,r=i&&i.action;this._primitive&&this._primitive.entity?(t=this._primitive.entity.getMyPlacesTaskOptions(n.inData.requestorState.location),t.state.data.id=this._primitive.entity.id):i.data&&(t=k.getMyPlacesTaskOptions(n.inData.requestState.data.title,n.inData.requestorState.location),t.state.action=n.inData.requestState.action,t.state.data.id=n.inData.requestState.collectionId);t&&(t.activateOptions={parentId:this._options.requestorId});this._buttonGroupViewModel.processCollectionsData(n,t)},e.prototype.show=function(n,t){n&&n.preventDefault&&n.preventDefault();this._ignoreHideEventOnce=!1;this._isDirectionsPopOutVisible=!1;this._isCollectionsPopOutVisible=!1;this._isTravelPopOutVisible=!1;this._isNearbyPopOutVisible=!1;this.populatePrimitive(n);this._update(n,t);this.initializeCollections();this._setFocusOnFirstElement();t||this.invalidateLayer.invoke()},e.prototype.hide=function(){if(this._ignoreHideEventOnce){this._ignoreHideEventOnce=!1;return}if(this._secondaryMenuOpen){this._secondaryMenuOpen=!1;return}this._primitive&&(window.clearTimeout(e._mouseoverDelayHandle),window.clearTimeout(e._copyToClipboardHandle),window.clearTimeout(e._focusDelayHandle),ti.hideOverlay(this._map,this._primitive),this._reset())},e.prototype.dispose=function(){this._primitive&&this.hide();for(var n=this._events.length-1;n>=0;n--)this._events[n].dispose();this._events=[];r(window).remove_event("click,touchend",this._hideTransientLensClickHandler);r(window).remove_event("keydown",this._hideTransientLensKeyDownHandler);this._categories=[];this._buttonGroupViewModel.dispose()},e.prototype.clickHandler=function(n){n&&n.stopPropagation()},e.prototype.boolToDisplay=function(n){return n?"":"none"},e.prototype.populatePrimitive=function(n){var s=this,e,u,r;this._primitive&&this._cleanup();var f=n.location,t=n.primitive,o="",i="";t&&t.geometryType===1&&(e=t.crs,u=t.geometry,f=new at(e.toLatitude(u.x,u.y),e.toLongitude(u.x,u.y)),o=ht.getDisplayName(t.entity),i=ht.getYpid(t.entity),!i&&n.primitive.entity.getBusinesslistingid?i=n.primitive.entity.getBusinesslistingid():!i&&t.entity.id&&(i=t.entity.id),this._sourcePrimitive=t);r=new nr(o,"",null);i&&(r.id=i);t&&t.entity&&(r.interests=t.entity.interests,r.stayDuration=t.entity.stayDuration);r.collisionBehavior=2;this._primitive=new hi(f,r,this._vectorImage);this._primitive.bucket=null;this.updateMapQuadrant(this._map,f,n);this._reverseGeocoder&&!h.disableReverseGeocode&&(this._reverseGeocodingRequestId=this._reverseGeocoder.reverseGeocodeWithNetworkId(f,function(n){return s._processGeocodeResponse(n)}))},e.prototype._cleanup=function(){this._primitive.entity.dispose()},e.prototype._update=function(n,t){this._primitive.mapTypeClass=e._getMapTypeClass(this._map,this._mapQuadrant);this._getDirectionsProcessData(n,t);b&&b.isEditable&&this._getTravelProcessData(n,t)},e.prototype._updateEntityData=function(){var n=r("#transientLens");this._buttonGroupViewModel.setEntityData(this._primitive.entity,this._options);this._buttonGroupViewModel.setAddToRouteMode(n.select(".directionsAddToRoute"),!0)},e.prototype._buildDirectionsAction=function(t,i,r,u){var h,c;if(this.actionList.indexOf(i)!==-1){var f=this._primitive.entity,e=f.entitySource,o={AN:n[i],CP:t,ID:f.id,EP:y.ContextMenu},s=e?e===1:!1;return s&&(o.AL=s),h=this._buildLogData(d.Clicked,o),c=this._buildActionEventHandlers(t,i,h,r,u),c}return null},e.prototype._buildTravelMoveToAction=function(t,i){if(this.actionList.indexOf(i)!==-1){var r=this._primitive.entity,u={AN:n[i],CP:t,ID:r.id,EP:y.ContextMenu},f=this._buildLogData(d.Clicked,u),e=p.L_OverlayEntity_MoveToDay;return this._buildActionEventHandlers(t,i,f,e,"addToItinerary moveTo")}return null},e.prototype._buildAddToItineraryAction=function(t,i,r){if(this.actionList.indexOf(i)!==-1){var u=this._primitive.entity,f={AN:n[i],CP:t,ID:u.id,EP:y.ContextMenu},e=this._buildLogData(d.Clicked,f),o=r.data.title,s=r.processorId,h=p.L_OverlayEntity_AddToItineraries.replace("{0}",o);return this._buildActionEventHandlers(t,i,e,h,"addToItinerary",s)}return null},e.prototype._buildSaveToRecentAction=function(t,i,r){var e,o,c,l;if(this.actionList.indexOf(i)!==-1){var a=this._primitive.entity,v={AN:n[i],CP:t,ID:a.id,EP:y.ContextMenu},s="",u="",f="",h=!1;return r.IsItinerary?(h=!0,r.IsOpenTask?(u=r.TaskTitle,s=r.TaskId):(e=r.Itinerary,u=e.getName(),f=e.collectionId)):(o=r.Collection,u=o.name,f=o.id),c=this._buildLogData(d.Clicked,v),l=this._buildActionEventHandlers(t,i,c,u,"saveToRecent",s,f,h),l}return null},e.prototype._buildLocalSearchAction=function(t){return lt.hideCoordinates?null:(this._primitive&&this._primitive.entity&&this._primitive.entity.isRecommendationEntity)?null:this._buildBasicActions(t,n.Search)},e.prototype.buildLocalDetailAction=function(){return null},e.prototype.buildNearbyAction=function(t){if(this.actionList.indexOf(n.Nearby)!==-1)return this._buildActionEventHandlers(t,n.Nearby,null)},e.prototype._isCardInFocus=function(){return!1},e.prototype.buildStreetsideAction=function(t){var i=this._buildBasicActions(t,n.Streetside);return i&&(this._streetsideBubbleInfo=null),i},e.prototype._buildBasicActions=function(t,i){if(this.actionList.indexOf(i)!==-1){var r=this._buildLogData(d.Clicked,{AN:n[i],CP:t,ID:this._primitive.entity.id,EP:y.ContextMenu});return this._buildActionEventHandlers(t,i,r)}return null},e.prototype.buildEditActions=function(){return null},e.prototype._buildZoomAction=function(t){return this._sourcePrimitive?null:this._buildBasicActions(t,n.Zoom)},e.prototype.buildCoordinatesAction=function(t){var r=this,u,f,e,i;return lt.hideCoordinates?null:this.actionList.indexOf(n.Coordinates)!==-1&&this._map.getMapType().id!==rt.birdseye?(u=t.latitude.toLocaleString(h.dynamicProperties.market,{minimumFractionDigits:6,maximumFractionDigits:6})+", "+t.longitude.toLocaleString(h.dynamicProperties.market,{minimumFractionDigits:6,maximumFractionDigits:6}),lt.enableCopyLinkInContextMenu?(f=u,e="secTextLink"):(f=p.L_OverlayEntity_Coordinates,e="secText"),i=this._primitive.entity.getGenericAction(f,"coordinates",function(n){r._isKeyHandler(n)&&n.preventDefault&&n.preventDefault()}),i.showSecText=!0,i.secText=lt.enableCopyLinkInContextMenu?p.L_OverlayEntity_Copy_Coordinates:u,i.secTextClass=e,i.secTextLinkHandler=lt.enableCopyLinkInContextMenu?function(n){return r._copyToClipboardClickEventBuilder(n,t,r._primitive.entity.id)}:null,i):null},e.prototype._buildMenuAction=function(){return null},e.prototype._processMouseOverEvent=function(t,i,r){var f=this,s,h,c,l,u,e,o;t.preventDefault&&t.preventDefault();t.stopPropagation&&t.stopPropagation();switch(r){case n.AddToRoute:this._directionsListCount>1&&!this._isDirectionsPopOutVisible&&(s=this._buildLogData(d.Focused,{AN:n[n.AddToRoute],CP:i,ID:this._primitive.entity.id,EP:y.ContextMenu}),h=this._primitive.entity.getDirectionTaskOptions(i,y.ContextMenu),this._directionsProcessData.inData.requestorState.instData=s,this._isDirectionsPopOutVisible=!0,this._isCollectionsPopOutVisible=!1,this._isTravelPopOutVisible=!1,this._isNearbyPopOutVisible=!1,this._secondaryMenuOpen=!0,this._buttonGroupViewModel.processDirectionsData(this._directionsProcessData,h));break;case n.moveToAnotherDay:this._isTravelPopOutVisible||(c=this._buildLogData(d.Focused,{AN:n[r],CP:i,ID:this._primitive.entity.id,EP:y.ContextMenu}),this._isDirectionsPopOutVisible=!1,this._isCollectionsPopOutVisible=!1,this._isTravelPopOutVisible=!0,this._isNearbyPopOutVisible=!1,this._secondaryMenuOpen=!0,this._processTravelEvent(t,i,c,r));break;case n.SaveWithTempCollection:this._isCollectionsPopOutVisible||(this._hidePopOut(t),this.signInStateHandler.getIsSignedIn()?(this._isDirectionsPopOutVisible=!1,this._isCollectionsPopOutVisible=!0,this._isTravelPopOutVisible=!1,this._isNearbyPopOutVisible=!1,this._secondaryMenuOpen=!0,u=this._buildLogData(d.Clicked,{AN:n[n.SaveWithTempCollection],CP:i,ID:this._primitive.entity.id,EP:y.ContextMenu}),this._processCollectionsEvent(t,i,u,!0)):b&&b.isEditable&&(this._isDirectionsPopOutVisible=!1,this._isCollectionsPopOutVisible=this._secondaryMenuOpen=this._travelProcessData.outData.length>0,this._isTravelPopOutVisible=!1,this._isNearbyPopOutVisible=!1,l=this._buildLogData(d.Clicked,{AN:n[n.SaveWithTempCollection],CP:i,ID:this._primitive.entity.id,EP:y.ContextMenu}),this._travelProcessData.inData.requestorState.instData=l,this._buttonGroupViewModel.processSaveWithTravelData(this._travelProcessData,t)));break;case n.MoveTo:this._isCollectionsPopOutVisible||(this._isDirectionsPopOutVisible=!1,this._isCollectionsPopOutVisible=!0,this._isTravelPopOutVisible=!1,this._isNearbyPopOutVisible=!1,this._secondaryMenuOpen=!0,u=this._buildLogData(d.Clicked,{AN:n[n.MoveTo],CP:i,ID:this._primitive.entity.id,EP:y.ContextMenu}),this._processCollectionsEvent(t,i,u,!0,!0));break;case n.Nearby:this._isNearbyPopOutVisible||(this._isDirectionsPopOutVisible=!1,this._isCollectionsPopOutVisible=!1,this._isTravelPopOutVisible=!1,this._isNearbyPopOutVisible=!0,this._secondaryMenuOpen=!0,e=this._primitive.mapTypeClass.indexOf("Dark")!==-1?!0:!1,o=this._primitive.entity.getTitle(),this._templateSelector?this._buttonGroupViewModel.nearbyButtonClicked(t,i,this._categories,this._templateSelector,e,o):this.selectorReady().then(function(){f._buttonGroupViewModel.nearbyButtonClicked(t,i,f._categories,f._templateSelector,e,o)}));break;default:this._hidePopOut(t)}},e.prototype._processMouseOutEvent=function(n){n&&n.preventDefault&&n.preventDefault();window.clearTimeout(e._mouseoverDelayHandle)},e.prototype._openCardButtonClicked=function(n){var e,s,o,v;n&&n.preventDefault();var i=this._sourcePrimitive&&this._sourcePrimitive.entity,h=ht.getYpid(i),c=ht.getTransitJson(i),a=u.taskDataHandlerKey,t,r;h?(t={id:h,taskTitle:ht.getDisplayName(i),entryPoint:y.ContextMenu},r=l.localDetailsTask):c?(e=JSON.parse(c),e.stops&&e.stops.length&&(s=this._primitive.getLocation(),t={id:e.stops[0].id,title:e.stops[0].name,location:s},r=l.transitStopTask)):ht.isTransitEntity(i)&&(s=this._primitive.getLocation(),o=parseInt(i.id),o=isNaN(o)?0:o,t={id:o,title:i.title,location:s},r=l.transitStopTask);t||(v=this._primitive.geometry.y+","+this._primitive.geometry.x,a=u.taskProcessDataHandlerKey,t={query:v,taskTitle:this._primitive.entity.getTitle(),entryPoint:y.ContextMenu},r=l.localSearchTask);this.hide();f.invokeHandler(a,{requestState:t,state:t,type:r})},e.prototype.updateMapQuadrant=function(n,t,i,r){var s=n.getViewport(),u=n.getViewportPadding(),h=s.pixelWidth-u.left-u.right,l=s.pixelHeight-u.top-u.bottom,o=this.getRightClickPoint(n,t,i),f,e;f=r?o.x-u.left+r>h:o.x-u.left>h/2;e=o.y-u.top<l/2;this._mapQuadrant=e&&f?c.TopRight:e&&!f?c.TopLeft:!e&&f?c.BottomRight:c.BottomLeft},e.prototype.getRightClickPoint=function(n,t){return n.getMode().tryLocationToPoint(t)},e.prototype._getVectorImage=function(){return{hitTest:1,hotspotX:0,hotspotY:0,records:[{centerX:0,centerY:0,radiusX:20,radiusY:20,style:{},vectorType:2}]}},e.prototype._buildLogData=function(n,t){return{logData:{feature:kt.ContextMenu,action:n,data:t}}},e.prototype.initializeCollections=function(){if(this.signInStateHandler.getIsSignedIn()){var n={action:v.GetAllCollectionNamesAndIds},t={requestorType:"TransientLens",type:l.collectionsTask,requestState:n};f.invokeHandler(u.taskProcessDataHandlerKey,t)}},e._getMapTypeClass=function(n,t){var i;switch(n.getMapType().id){case rt.road:i="Light";break;case rt.aerial:case rt.birdseye:i="Dark";break;default:i="Light"}return i+(" "+c[t])},e.prototype.buildOverlaySearchAction=function(n){var t=this,i=this._primitive.entity,u=this._sourcePrimitive&&this._sourcePrimitive.entity,r=function(i){t._isKeyHandler(i)&&(window.clearTimeout(e._mouseoverDelayHandle),t._openCardButtonClicked(i,n))};return u?i.getLocalListingAction(!1,r):i.getAddPushpinAction(!1,r)},e.prototype._updateOverlayPosition=function(n,t){var i=r("#transientLens");if(i.length!==0){var d=i.select(".transientLensActions"),s=i.select(".directionsPopOut"),f=i.select(".travelPopOut"),o=i.select(".collectionsPopOut"),h=i.select(".nearbyPopOut"),g=i.select("a.nearby").length>0,nt=Math.max(s.get_size().width,o.get_size().width,h.get_size().width),tt=this._overwriteMapQuadrantUsingMenuWidth(nt,n,t),p=e._defaultDirectionPopOutTop,u=i.get_size(),a=u.width,v=u.width,l=u.width,y=u.width;this._mapQuadrant===c.TopRight||this._mapQuadrant===c.BottomRight?(a=e._leftPaddingForActions-s.get_size().width-u.width,f.length&&(v=e._leftPaddingForActions-f.get_size().width-u.width),l=e._leftPaddingForActions-o.get_size().width-u.width,y=e._leftPaddingForActions-h.get_size().width-u.width):tt||(a=e._leftPaddingForActions-s.get_size().width,f.length&&(v=e._leftPaddingForActions-f.get_size().width),l=e._leftPaddingForActions-o.get_size().width,y=e._leftPaddingForActions-h.get_size().width);var it=b&&b.isEditable&&!this.signInStateHandler.getIsSignedIn(),w=i.select("a.nearby").get_relative_pos().y-20,k=i.select("a.savefavorite").get_relative_pos().y-20;(this._mapQuadrant===c.BottomLeft||this._mapQuadrant==c.BottomRight)&&(p-=u.height-e._bottomPaddingForActions,w-=u.height,k-=u.height);this._updateContextMenuPosition(i,d,t);s.set_style({top:p+this._adjustmentValueForTop+"px",left:a+"px"});f.length&&f.set_style({left:v+"px"});it?o.set_style({top:k+this._adjustmentValueForTop+"px",left:l+"px"}):o.set_style({left:l+"px"});g&&h.set_style({top:w+this._adjustmentValueForTop+"px",left:y+"px"})}},e.prototype._updateContextMenuPosition=function(n,t,i){var u=n.get_size(),r=e._topPaddingForBottomQuadrants,f;this._mapQuadrant===c.TopRight?f=-u.width:this._mapQuadrant===c.BottomLeft?r=-u.height+e._topPaddingForBottomQuadrants:this._mapQuadrant===c.BottomRight&&(r=-u.height+e._topPaddingForBottomQuadrants,f=-u.width);t.set_style({position:"relative",top:r+"px",left:f+"px"});this._adjustmentValueForTop=this._getAdjustmentForTop();this._adjustmentValueForTop!==0&&(r+=this._adjustmentValueForTop,t.set_style({position:"relative",top:r+"px",left:f+"px"}),this._updateBucketId(i));n.set_style({visibility:"visible"})},e.prototype._getAdjustmentForTop=function(){var s=r("#transientLens"),t=s.select(".transientLensActions");if(this._mapQuadrant===c.TopLeft||this._mapQuadrant===c.TopRight){var l=t.get_absolute_pos(),f=this._map.getViewportPadding(),e=this._map.getViewport().pixelHeight-(f.top+f.bottom),n=l.y+t.get_size().height;if(n>e)return e-n}else{var n=t.get_absolute_pos().y,i=r(".taskBar"),o=h.features.taskBar,u=i.get_absolute_pos().y+i.get_size().height;if(o&&o.showTaskBarL2Nav&&(u=i.get_absolute_pos().y),u>n)return u-n}return 0},e.prototype._overwriteMapQuadrantUsingMenuWidth=function(n,t,i){var o=this._primitive.getLocation(),s=r("#transientLens").get_size().width,u=this._mapQuadrant,h;this.updateMapQuadrant(this._map,o,t,s);h=r("."+c[u]);u!==this._mapQuadrant&&(h.swap_class(c[u],c[this._mapQuadrant]),this._primitive.mapTypeClass=e._getMapTypeClass(this._map,this._mapQuadrant),this._updateBucketId(i));var l=this._map.getViewport(),f=this._map.getViewportPadding(),a=l.pixelWidth-f.left-f.right,v=this.getRightClickPoint(this._map,o,t);return v.x-f.left+s+n<a?!0:!1},e.prototype._populateActions=function(t){var i,k,lt,e,o,r,s,d,g,h,c,l,a,at,v,nt,tt,y,u,f,it,rt,ut,ft,et,ot,st,w,ht,ct;if(this._primitive.entity&&t){if(i=[],this._mostRecentlyUsedList){if(this._mostRecentlyUsedList.getLength()>0)for(k=this._mostRecentlyUsedList.getList(),r=0;r<k.length;r++)lt=k[r],e=this._buildSaveToRecentAction(t,n.saveToRecent,lt),e&&(r===0&&(e.cssClass+="Icon"),r===k.length-1&&(e.showSeparator=!0),i.push(e))}else if(this._travelProcessData)for(o=this._travelProcessData.outData,this._buttonGroupViewModel.openItineraryTaskInfo=o,r=0;r<o.length;r++)s=this._buildAddToItineraryAction(t,n.addToItinerary,o[r]),r===o.length-1&&s&&(s.showSeparator=!0),s&&i.push(s);d=this._buildDirectionsAction(t,n.DirectionsTo,p.L_OverlayEntity_DirectionsTo,"directionsTo");d&&i.push(d);g=this._buildDirectionsAction(t,n.DirectionsFrom,p.L_OverlayEntity_DirectionsFrom,"directionsFrom");g&&i.push(g);this._directionsProcessData&&(h=this._buildDirectionsAction(t,n.AddToRoute,p.L_OverlayEntity_AddToRoute,"directionsAddToRoute"),h&&(this._directionsListCount>1&&(h.showArrow=!0),i.push(h)));(d||g||h)&&(i[i.length-1].showSeparator=!0);c=this.buildNearbyAction(t);c&&(c.showSeparator=!0,c.showArrow=!0,i.push(c));l=this._buildTravelMoveToAction(t,n.moveToAnotherDay);l&&(l.showArrow=!0,l.showSeparator=!0,i.push(l));this._primitive.entity.isRecommendationEntity||(a=this._buildBasicActions(t,n.SaveWithTempCollection),a&&(a.showSeparator=!0,at=this.signInStateHandler.getIsSignedIn(),a.showArrow=at||b&&b.isEditable?!0:!1,i.push(a)));v=this._buildBasicActions(t,n.MoveTo);v&&(v.showSeparator=!0,v.showArrow=!0,i.push(v));nt=this.buildEditActions(n.Edit);nt&&i.push(nt);tt=this.buildEditActions(n.editName);tt&&i.push(tt);y=this.buildEditActions(n.editDescription);y&&i.push(y);u=this.buildEditActions(n.deleteName);u&&i.push(u);f=this.buildEditActions(n.deleteDescription);f&&i.push(f);it=this.buildEditActions(n.hideHomeWork);it&&i.push(it);rt=this.buildEditActions(n.editHomeWork);rt&&i.push(rt);ut=this.buildEditActions(n.Remove);ut&&i.push(ut);u||f||!y?f?f.showSeparator=!0:u&&(u.showSeparator=!0):y.showSeparator=!0;ft=this._buildLocalSearchAction(t);ft&&i.push(ft);et=this.buildLocalDetailAction(t);et&&i.push(et);ot=this.buildStreetsideAction(t);ot&&i.push(ot);st=this._buildBasicActions(t,n.BirdseyeV2);st&&i.push(st);w=this._buildZoomAction(t);w&&i.push(w);ht=this._buildBasicActions(t,n.Measure);ht&&i.push(ht);ct=this.buildCoordinatesAction(t);ct&&(w&&(w.showSeparator=!0),i.push(ct));this._primitive.entity.setActions(i)}},e.prototype._populateNearbyCategories=function(){var t=this,n;si.contextMenuNearbyCategories.length>0&&(this._categories=[],si.contextMenuNearbyCategories.forEach(function(n){var i=n.split(":");i&&i.length===2&&t._categories.push({Name:i[0],Id:i[1]})}),n=h.features,n&&n.transit&&n.transit.isEnabled&&this._categories.push({Name:i.L_Nearby_Transit,Id:ar.nearbyTransitCategoryId}))},e.prototype._buildActionEventHandlers=function(t,i,r,u,f,o,s,h){var c=this,l,a=this._primitive.entity,v;switch(i){case n.Zoom:l=a.getZoomAction(!1,function(n){c._isKeyHandler(n)&&(window.clearTimeout(e._mouseoverDelayHandle),c._zoomButtonClicked(n,t,r))});v=this._map.getMercatorZoomLevel();v<e._streetZoomLevel?l.cssClass="zoomEnabled":v>=e._streetZoomLevel&&(l.cssClass="zoomout",l.text=p.L_OverlayEntity_ZoomOut);break;case n.Measure:l=a.getGenericAction(p.L_OverlayEntity_Measure,"measure",function(n){c._isKeyHandler(n)&&(window.clearTimeout(e._mouseoverDelayHandle),c._measureActionClicked(n,t,r))});break;case n.SaveWithTempCollection:l=a.getMyPlacesAction(!1,function(n){if(c._isKeyHandler(n)){window.clearTimeout(e._mouseoverDelayHandle);var i=c.signInStateHandler.getIsSignedIn();b&&b.isEditable&&!i?c._processSignedOutSaveWithTravelEvent(n,t):c._processCollectionsEvent(n,t,r,c.signInStateHandler.getIsSignedIn()?!0:!1)}},!0);break;case n.MoveTo:l=a.getMyPlacesAction(!1,function(n){c._isKeyHandler(n)&&(window.clearTimeout(e._mouseoverDelayHandle),c._processCollectionsEvent(n,t,r,!0,!0))},!0,!0);break;case n.addToItinerary:case n.moveToAnotherDay:l=a.getGenericAction(u,f,function(n){c._isKeyHandler(n)&&(window.clearTimeout(e._mouseoverDelayHandle),c._processTravelEvent(n,t,r,i,o))});break;case n.saveToRecent:l=a.getGenericAction(u,f,function(n){c._isKeyHandler(n)&&(window.clearTimeout(e._mouseoverDelayHandle),c._processSaveToRecentEvent(n,t,r,o,s,h))});break;case n.Directions:case n.DirectionsTo:case n.DirectionsFrom:case n.AddToRoute:l=a.getGenericAction(u,f,function(n){c._isKeyHandler(n)&&(window.clearTimeout(e._mouseoverDelayHandle),c._processDirectionsEvent(n,t,r,i))});break;case n.Search:l=this.buildOverlaySearchAction(r);break;case n.Streetside:l=a.getStreetsideAction(!0,function(n){c._isKeyHandler(n)&&(window.clearTimeout(e._mouseoverDelayHandle),c._streetsideButtonClicked(n,t,r))});break;case n.BirdseyeV2:l=a.getBirdseyeV2Action(!0,function(n){c._isKeyHandler(n)&&(window.clearTimeout(e._mouseoverDelayHandle),c._birdseyeV2ButtonClicked(n,t,r))});break;case n.Nearby:l=a.getNearbyAction(!1,function(n){c._isKeyHandler(n)&&(window.clearTimeout(e._mouseoverDelayHandle),c._processNearbyEvent(n,t))});break;case n.Menu:default:return null}return this.addMouseHoverHandlers(l,t,i)},e.prototype.addMouseHoverHandlers=function(n,t,i){var r=this;return n?(n.mouseoverHandler=function(n){window.clearTimeout(e._mouseoverDelayHandle);e._mouseoverDelayHandle=Microsoft.Maps.setTimeout(function(){r._processMouseOverEvent(n,t,i)},e._mouseoverTimeout)},n.mouseoutHandler=function(n){return r._processMouseOutEvent(n)},n):null},e.prototype._isKeyHandler=function(n){var t=n;return t&&t.type==="keydown"&&t.keyCode!==13?(this._onKeyDown(n),!1):!0},e.prototype._processDirectionsEvent=function(t,i,r,e){var o,s,h,c;t&&t.preventDefault&&t.preventDefault();c=this._primitive.entity.getTitle();switch(e){case n.DirectionsTo:o=2;s=this._activeDirectionTaskId;h=this._activeDirectionTaskId?"focus":"activate";break;case n.DirectionsFrom:o=1;s=this._activeDirectionTaskId;h=this._activeDirectionTaskId?"focus":"activate";break;case n.AddToRoute:if(this._directionsListCount===1)o=3,s=this._addToRouteDirectionTaskId,h="focus";else{if(this._isDirectionsPopOutVisible)return;this._processMouseOverEvent(t,i,e);return}break;default:throw new Error("Error action type");}var a=this._primitive.entity.entitySource,v=a?a===1:!1,l=k.getDirectionTaskOptions(c,i,y.ContextMenu,c,this._primitive.entity.id,o,v);l.id=s;l.action=h;this.hide();f.invokeHandler(u.taskDataHandlerKey,l)},e.prototype._processTravelEvent=function(t,i,o,s,h){var l,p,w;if(t&&t.preventDefault&&t.preventDefault(),s===n.addToItinerary&&(l=this._primitive.entity,l.getImageUrl()&&l.getImageUrl().length>0&&(p=l.getImageUrl()),w=k.getItineraryAddItemOptions(l.getTitle(),i,l.id,p,h,l.categoryId,l.interests,l.stayDuration),f.invokeHandler(u.taskProcessDataHandlerKey,w),this.hide()),s===n.moveToAnotherDay){var a=r("#transientLens"),b=a.select(".transientLensActions"),d=a.select(".travelPopOut"),v,g=a.select(".addToItinerary");v=g.get_relative_pos().y-20;this._buttonGroupViewModel.travelMoveToButtonClicked(t,i,o,y.ContextMenu);(this._mapQuadrant===c.BottomLeft||this._mapQuadrant===c.BottomRight)&&(v-=b.get_size().height+e._bottomPaddingForActions);d.set_style({top:v+this._adjustmentValueForTop+"px"})}},e.prototype._processSaveToRecentEvent=function(n,t,i,r,e,o){var s,h;n&&n.preventDefault&&n.preventDefault();s=this._primitive.entity;s.getImageUrl()&&s.getImageUrl().length>0&&(h=s.getImageUrl());var c=s,a=c.getDescription&&c.getDescription(),v=c.getAddress&&c.getAddress(),l;l=o?e&&!r?k.getItineraryAddItemFromSaveOptions(s.getTitle(),t,s.id,h,e,s.categoryId,s.interests,s.stayDuration):k.getItineraryAddItemOptions(s.getTitle(),t,s.id,h,r,s.categoryId,s.interests,s.stayDuration):k.getSaveToCollectionOptions(s.getTitle(),t,e,s.id,a,v,h,s.categoryId);f.invokeHandler(u.taskProcessDataHandlerKey,l);this.hide()},e.prototype._processSignedOutSaveWithTravelEvent=function(t,i){this._processMouseOverEvent(t,i,n.SaveWithTempCollection)},e.prototype._processNearbyEvent=function(t,i){this._processMouseOverEvent(t,i,n.Nearby)},e.prototype._processCollectionsEvent=function(n,t,i,u,f){var o=r("#transientLens"),a=o.select(".transientLensActions"),v=o.select(".collectionsPopOut"),s,h,l;u?(h=o.select(".saveas"),s=h.get_relative_pos().y-20,this._buttonGroupViewModel.collectionMenuButtonClicked(n,t,i,y.ContextMenu,f)):(l=o.select(".savefavorite"),s=l.get_relative_pos().y-20,this._buttonGroupViewModel.collectionButtonClicked(n,t,i,y.ContextMenu));(this._mapQuadrant===c.BottomLeft||this._mapQuadrant===c.BottomRight)&&(s-=a.get_size().height+e._bottomPaddingForActions);v.set_style({top:s+this._adjustmentValueForTop+"px"})},e.prototype._reset=function(){this._reverseGeocodingRequestId&&ft.abortRequest(this._reverseGeocodingRequestId);this._primitive&&(this._directionsProcessData=null,this._activeDirectionTaskId=null,this._travelProcessData=null,this._directionsProcessed=!1,this._travelProcessed=!1,this._addToRouteDirectionTaskId=null,this._adjustmentValueForTop=0,this._cleanup(),this._primitive=null,this._sourcePrimitive=null,this.invalidateLayer.invoke())},e.prototype._hidePopOut=function(n){(this._isDirectionsPopOutVisible||this._isCollectionsPopOutVisible||this._isTravelPopOutVisible||this._isNearbyPopOutVisible)&&(n&&n.preventDefault&&n.preventDefault(),this._ignoreHideEventOnce=!0,this._isDirectionsPopOutVisible=!1,this._isCollectionsPopOutVisible=!1,this._isTravelPopOutVisible=!1,this._isNearbyPopOutVisible=!1,this._buttonGroupViewModel.hidePopout(),this._ignoreHideEventOnce=!1)},e.prototype._streetsideButtonClicked=function(n,t){var i=this;n&&n.preventDefault();n&&n.stopPropagation();this._streetsideBubbleInfo&&(this.hide(),this._map.getContainer().instanceAsync("StreetsideMiniBootstrapper",function(n){n.show(i._streetsideBubbleInfo,{locationToLookAt:t,entryPoint:y.ContextMenu,perfClickToImmersionTimeSource:uu.ContextMenuClickToImmersionTime})}))},e.prototype._birdseyeV2ButtonClicked=function(n,t){var i=this;n&&n.preventDefault();n&&n.stopPropagation();ni.setMapCenter(this._map,t,null,null,new nu(this._map.getView(),new gr(ou.toLocation(t,this._map.getMercatorZoomLevel(),!0))),null,null,{top:0,right:0,bottom:0,left:0});this._map.getFrameManager().frameRendered.addOne(function(){i._map.setMapType(i._map.createMapType(rt.birdseyeV2));i._addContextPoiForBirdseyeV2(t)});this.hide()},e.prototype._addContextPoiForBirdseyeV2=function(n){var t=this;this._map.getBirdseyeV2Manager().then(function(i){var r,u;t._map.getMapType().id===rt.birdseyeV2&&(r=t._primitive&&t._primitive.entity&&t._primitive.entity.getTitle(),r?i&&i.addContextPoi(n,r,1):t._reverseGeocoder?t._reverseGeocoder.reverseGeocodeWithNetworkId(n,function(n){u(n)}):t._map.getContainer().instanceAsync("ReverseGeocoder",function(t){t.reverseGeocodeWithNetworkId(n,function(n){u(n)})}),u=function(r){if(t._map.getMapType().id===rt.birdseyeV2&&r&&r.success&&r.location&&r.addressList){var u=r.addressList[0].formattedAddress;i&&i.addContextPoi(n,u,1)}})})},e.prototype._measureActionClicked=function(n,t){n&&n.preventDefault();this.hide();var i={location:t},r={type:l.measureMap,state:i};f.invokeHandler(u.taskDataHandlerKey,r)},e.prototype._zoomButtonClicked=function(n,t){n&&n.preventDefault();var i=this._map.getMercatorZoomLevel();i<=e._cityZoomLevel-1?(this.hide(),ni.setMapCenter(this._map,t,e._cityZoomLevel)):i>=e._cityZoomLevel&&i<e._streetZoomLevel?(this.hide(),ni.setMapCenter(this._map,t,e._streetZoomLevel)):i>=e._streetZoomLevel&&(this.hide(),ni.setMapCenter(this._map,t,e._cityZoomLevel))},e.prototype._processGeocodeResponse=function(n){var t,i,u,r;(this._reverseGeocodingRequestId=null,t=this._primitive,t)&&(n&&n.success&&n.location&&n.addressList?i=n.addressList[0].formattedAddress:(u=t.geometry,i=a._formatLatLonString(u.y,u.x)),r=t.entity,r.getTitle()||r.setTitle(i),r.setAddress(i),this._updateBucketId())},e.prototype._updateBucketId=function(n){var t=this._primitive;t.bucket=this._adjustmentValueForTop!==0?this._mapQuadrant===c.TopLeft||this._mapQuadrant===c.BottomLeft?it.bucketIdForTransientLensLeft:it.bucketIdForTransientLensRight:this._mapQuadrant===c.TopLeft||this._mapQuadrant===c.TopRight?it.bucketIdForTransientLensTop:it.bucketIdForTransientLensBottom;t.revision=t.revision||1;n||this.invalidateLayer.invoke()},e.prototype._isStreetsideAvailable=function(n,t){var r=this,i;n&&this._primitive&&this._primitive.geometry.y===t.latitude&&this._primitive.geometry.x===t.longitude&&(this._streetsideBubbleInfo=n,i=this._primitive.entity.getActions(),i.forEach(function(n,t){if(n.getCssClass&&n.getCssClass()==="streetside"){r._primitive.entity.getActions()[t].setCssClass("streetsideEnabled");return}}))},e.prototype._isBirdseyeV2Available=function(n){var i=this,t;n&&this._primitive&&(t=this._primitive.entity.getActions(),t.some(function(n,t){var r=!1;return n.getCssClass&&n.getCssClass()==="birdseyeV2"&&(i._primitive.entity.getActions()[t].setCssClass("birdseyeV2Enabled"),r=!0),r}))},e.prototype._getDirectionsProcessData=function(n,t){this._directionsProcessed=!1;var i=this._primitive.getLocation(),r={requestorType:this._options.requestorType,requestorId:this._options.requestorId,type:l.directionsTask,requestState:{action:0},requestorState:{location:i,args:n,preventInvalidate:t},useActiveTasks:!0};f.invokeHandler(u.taskProcessDataHandlerKey,r)},e.prototype._getTravelProcessData=function(n,t){this._travelProcessed=!1;var i=this._primitive.getLocation(),r={requestorType:this._options.requestorType,requestorId:this._options.requestorId,type:l.itineraryDetailsTask,requestState:{action:0},requestorState:{location:i,args:n,preventInvalidate:t},useActiveTasks:!0};f.invokeHandler(u.taskProcessDataHandlerKey,r)},e.prototype._onClick=function(n){n.target&&r(n.target.parentElement).has_class("ms-composite")||this.hide()},e.prototype._onKeyDown=function(n){var u,e;if(n.type==="keydown"){if(u=[13,27,32,37,39,61,65,66,72,79,82,107,109,173,187,189],u.indexOf(n.keyCode)>=0){this.hide();return}var i=document.activeElement,f=this._primitive&&ti.getOverlay()&&ti.getOverlay().getOverlayElement(),t=i&&f&&f.has(i)&&i.tagName&&i.tagName.toLowerCase()==="a"&&i.parentElement;if(n.keyCode===38)if(t&&t.previousElementSibling)r("a",t.previousElementSibling)[0].focus();else{this.hide();return}if(n.keyCode===40)if(t&&t.nextElementSibling)r("a",t.nextElementSibling)[0].focus();else{this.hide();return}if(n.keyCode===9)if(e=n,e.shiftKey){if(t&&!t.previousElementSibling){this.hide();return}}else if(t&&!t.nextElementSibling){this.hide();return}}},e.prototype._copyToClipboardClickEventBuilder=function(){var i=document.querySelector("#transientLens .coordinates .actionText"),u,n,t;if(window.getSelection&&document.createRange&&lt.enableAutoCopyToClipboard){n=document.createRange();n.selectNodeContents(i);window.getSelection().removeAllRanges();window.getSelection().addRange(n);try{u=document.execCommand("copy")}catch(f){}window.getSelection().removeAllRanges()}t=r("#transientLens .coordinates .secTextLink");t.swap_class("secTextLink","secText");u?(t.set_text(p.L_OverlayEntity_Copy_Succeeded),window.clearTimeout(e._copyToClipboardHandle),e._copyToClipboardHandle=Microsoft.Maps.setTimeout(function(){var n=r("#transientLens .coordinates .secText");n.swap_class("secText","secTextLink");n.set_text(p.L_OverlayEntity_Copy_Coordinates)},e._copyToClipboardTimeout)):(n=document.createRange(),n.selectNodeContents(i),window.getSelection().removeAllRanges(),window.getSelection().addRange(n),t.set_text("Ctrl + C"))},e._convertToRGBA=function(n,t){var i=n.replace("#",""),r=parseInt(i.substring(0,2),16),u=parseInt(i.substring(2,4),16),f=parseInt(i.substring(4,6),16);return"rgba("+r+","+u+","+f+","+t+")"},e.prototype._setFocusOnFirstElement=function(){window.clearTimeout(e._focusDelayHandle);e._focusDelayHandle=Microsoft.Maps.setTimeout(function(){var n=r(".transientLensActions li");n.length&&r("a",n[0])[0].focus()},e._focusTimeout)},e._copyToClipboardTimeout=1e3,e._cityZoomLevel=11,e._streetZoomLevel=16,e._topPaddingForBottomQuadrants=-8,e._bottomPaddingForActions=-6,e._mouseoverTimeout=350,e._leftPaddingForActions=15,e._defaultDirectionPopOutTop=50,e._focusTimeout=100,e}(),vi=function(t){function i(n,i,r){var u=t.call(this,n,null,i,r)||this;return u.updateActionList(),u.poiSelected=new w,u._buildMode=!1,u}return s(i,t),i.prototype.buildMenu=function(n,t,i){this._buildMode=!0;this._buildCallback=i;this.show({primitive:n,item:t},!0)},i.prototype.showOverlay=function(){if(this._buildMode&&this._buildCallback){var n=this._controlTemplate.applyDataTemplate({primitive:this._primitive});this._buildCallback(n)}else t.prototype.showOverlay.call(this);this._buildMode=!1;this._buildCallback=null},i.prototype.populatePrimitive=function(n){var i;if(this._primitive&&this._cleanup(),n.primitive&&n.primitive.geometryType&&n.primitive.geometryType!==1){t.prototype.populatePrimitive.call(this,n);return}var f=n.primitive.geometry,e=new at(f.y,f.x),u=n.primitive.entity,r=null;u instanceof pi?(i=u,r=new fi(i.getTitle(),i.getDescription(),n.primitive.taskDisplayState,i.getMenuUrl(),i.entitySource,i.getAddress(),i.getSelectedCategoryForIcon&&i.getSelectedCategoryForIcon()),r.collisionBehavior=2,r.setImageUrl(i.getImageUrl()),r.addressFields=i.addressFields,r.setSegmentTypes(i.getSegmentTypes()),r.setPrimaryCategoryName(i.getPrimaryCategoryName()),r.searchEntity=u):r=new fi(u.title,u.subtitle,n.primitive.taskDisplayState);r.id=u.id;r.isRecommendationEntity=u instanceof ru;this._primitive=new hi(e,r,this._getVectorImage());this.updateMapQuadrant(this._map,e,n);this._primitive.bucket=this._mapQuadrant===c.TopLeft||this._mapQuadrant===c.TopRight?it.bucketIdForTransientLensTop:it.bucketIdForTransientLensBottom;this._primitive.taskDisplayState=n.primitive.taskDisplayState},i.prototype.getRightClickPoint=function(n,i,r){if(r&&r.item){var u=r.item.get_absolute_pos();return new iu(u.x,u.y)}return t.prototype.getRightClickPoint.call(this,n,i,r)},i.prototype.updateActionList=function(){this.actionList.push(n.OpenNewCard)},i.prototype._openCardButtonClicked=function(n){n&&n.preventDefault();var t={entryPoint:y.ContextMenu,id:this._primitive.entity.id,flippingCard:!0,taskTitle:this._primitive.entity.getTitle(),selectedCategoryId:this._primitive.entity.categoryId};a._updateSearchTaskStateWithAdsData(t,this._primitive.entity.searchEntity);this.poiSelected.invoke(this._primitive);this.hide();f.invokeHandler(u.taskDataHandlerKey,{type:l.localDetailsTask,state:t,activateOptions:{parentId:this._options.requestorId}})},i.prototype._buildLocalSearchAction=function(n){var i=t.prototype._buildLocalSearchAction.call(this,n);return i&&(i.cssClass=this._isCardInFocus()?"flipcard":"flipcardEnabled"),i},i.prototype.buildLocalDetailAction=function(t){var u=this,i,r;return this.actionList.indexOf(n.OpenNewCard)!==-1||this._primitive&&this._primitive.entity&&this._primitive.entity.isRecommendationEntity?(i=this._buildLogData(d.Clicked,{AN:n[n.OpenNewCard],CP:t,ID:this._primitive.entity.id,EP:y.ContextMenu}),r=this._primitive.entity.getLocalDetailsAction(!1,function(n){window.clearTimeout(vt._mouseoverDelayHandle);u.openNewCardButtonClicked(n,i)}),this.addMouseHoverHandlers(r,t,n.OpenNewCard)):null},i.prototype.buildStreetsideAction=function(n){return this._buildMode?null:t.prototype.buildStreetsideAction.call(this,n)},i.prototype._buildZoomAction=function(n){return this._buildMode?null:t.prototype._buildZoomAction.call(this,n)},i.prototype.buildOverlaySearchAction=function(n){var i=this,t=this._primitive.entity;return t.id&&t.id.length>0?t.getLocalListingAction(!1,function(t){window.clearTimeout(vt._mouseoverDelayHandle);i._openCardButtonClicked(t,n)}):null},i.prototype.openNewCardButtonClicked=function(n){var t,i;n&&n.preventDefault();t={entryPoint:y.ContextMenu,listingTaskId:this._options.requestorId,id:this._primitive.entity.id,openingNewCard:!0,taskTitle:this._primitive.entity.getTitle(),selectedCategoryId:this._primitive.entity.categoryId};a._updateSearchTaskStateWithAdsData(t,this._primitive.entity.searchEntity);i=this._primitive.taskDisplayState&&this._primitive.taskDisplayState.colorIndex;this.hide();f.invokeHandler(u.taskDataHandlerKey,{type:l.localDetailsTask,state:t,activateOptions:{taskColorIndex:i,groupName:this._options.requestorId}})},i}(vt),we=function(t){function i(n,i,r){var u=t.call(this,n,i,r)||this;return u.editEvent=new w,u}return s(i,t),i.prototype.updateActionListWithMoveTo=function(){var i,t;if(this.signInStateHandler.getIsSignedIn()&&this.actionList){for(i=!1,t=0;t<this.actionList.length;t++)this.actionList[t]===n.MoveTo&&(i=!0);i||this.actionList.push(n.MoveTo)}},i.prototype.updateActionListWithEdits=function(){this.updateActionList();this.actionList.push(n.Edit)},i.prototype.updateActionListWithHomeWorkEdit=function(){this.actionList=[];this.actionList.push(n.DirectionsTo);this.actionList.push(n.DirectionsFrom);this.actionList.push(n.AddToRoute);this.actionList.push(n.OpenNewCard);this.actionList.push(n.editHomeWork);this.actionList.push(n.hideHomeWork);this.actionList.push(n.Remove)},i.prototype.updateActionListForEvent=function(){this.actionList=[];this.actionList.push(n.DirectionsTo);this.actionList.push(n.DirectionsFrom);this.actionList.push(n.AddToRoute);this.actionList.push(n.OpenNewCard)},i.prototype.updateActionList=function(){this.actionList=[];b&&b.isEditable&&this.actionList.push(n.addToItinerary);this.actionList.push(n.DirectionsTo);this.actionList.push(n.DirectionsFrom);this.actionList.push(n.AddToRoute);this.actionList.push(n.OpenNewCard);this.signInStateHandler.getIsSignedIn()&&this.actionList.push(n.MoveTo);this.actionList.push(n.Remove)},i.prototype.openNewCardButtonClicked=function(n){var i;n&&n.preventDefault();var t=this._primitive.entity,r=t.getTitle(),e="";t.getNickname()&&(e=r,r=t.getNickname());i={entryPoint:y.ContextMenu,listingTaskId:this._options.requestorId,id:t.id,openingNewCard:!0,taskTitle:r,originalName:e,selectedCategoryId:t.categoryId};i.hideBackButton=!0;!i.id&&this._primitive.geometry&&(i.query=this._primitive.geometry.y.toFixed(6)+", "+this._primitive.geometry.x.toFixed(6));this.hide();f.invokeHandler(u.taskDataHandlerKey,{type:l.localDetailsTask,state:i,activateOptions:{groupName:this._options.requestorId}})},i.prototype.populatePrimitive=function(n){var l,a,r,e,u;this._primitive&&this._cleanup();this.collectionPrimitive=n.primitive;var o=n.primitive.geometry,s=new at(o.y,o.x),t=n.primitive.entity,i=n.primitive.entity,h=t.getTitle(),f="";t.originalName?f=t.originalName:i.getOriginalName&&(f=i.getOriginalName());l=t.getDescription();a=t.getAddress();t.businesslistingid?r=t.businesslistingid:i.getBusinesslistingid&&(r=i.getBusinesslistingid(),r.indexOf("ypid:")===-1&&r.indexOf("sid:")===-1&&(r=""));t.photoUrl?e=t.photoUrl:i.getPhotoUrl&&(e=i.getPhotoUrl());u=new fi(f||h,l,n.primitive.taskDisplayState,null,null,a,n.primitive.entity.getSelectedCategoryForIcon&&n.primitive.entity.getSelectedCategoryForIcon());f&&u.setNickname(h);e&&u.setImageUrl(e);u.collisionBehavior=2;u.id=r;this._primitive=new hi(s,u,this._getVectorImage());this.updateMapQuadrant(this._map,s,n);this._primitive.bucket=this._mapQuadrant===c.TopLeft||this._mapQuadrant===c.TopRight?it.bucketIdForTransientLensTop:it.bucketIdForTransientLensBottom;this._buildMode&&(this._primitive.taskDisplayState=n.primitive.taskDisplayState)},i.prototype.buildEditActions=function(t){var u=this,i,r,f,e,o;if(this.actionList.indexOf(t)===-1)return null;i="";r=!1;switch(t){case n.Edit:i=p.L_EditEntityOption;r=!0;break;case n.editName:i=this.actionList.indexOf(n.deleteName)===-1?p.L_AddNickNameOption:p.L_EditNickNameOption;break;case n.editDescription:i=this.actionList.indexOf(n.deleteDescription)===-1?p.L_AddNoteOption:p.L_EditNoteOption;break;case n.Remove:i=p.L_DeleteEntityOption;r=!0;break;case n.deleteName:i=p.L_DeleteNickNameOption;break;case n.deleteDescription:i=p.L_DeleteNoteOption;break;case n.editHomeWork:i=p.L_EditHomeWorkOption;r=!0;break;case n.hideHomeWork:this.collectionPrimitive&&this.collectionPrimitive.entity.getIsHomeOrWork&&(f=this.collectionPrimitive,i=f.entity.getShowOnMap()?p.L_HideHomeWorkOption:p.L_DisplayHomeWorkOption)}return e=function(n){window.clearTimeout(vt._mouseoverDelayHandle);u.editEvent.invoke(t);n.stopPropagation();n.preventDefault();u.hide()},o={text:i,cssClass:i==="Remove"?"remove":"edit",handler:e,mouseoverHandler:null,showSeparator:r,showSecText:!1,secText:null},o},i}(vi),be=function(n){function t(t,i,r){return n.call(this,t,i,r)||this}return s(t,n),t.prototype.updateActionList=function(){},t.prototype._isCardInFocus=function(){var n=this._primitive.entity.getTaskDisplayState();return n&&n.activationState&&n.activationState===1?!0:!1},t.prototype._openCardButtonClicked=function(n){(n&&n.preventDefault(),this._isCardInFocus())||(this.hide(),f.invokeHandler(u.taskDataHandlerKey,{action:"focus",id:this._options.requestorId}))},t}(vi),ke=function(t){function i(n,i,r){var u=t.call(this,n,i,r)||this;return u.editable=b&&b.isEditable,u.editable&&(u._buttonGroupViewModel.isItineraryContextMenu=!0),u.editEvent=new w,u}return s(i,t),i.prototype.updateActionList=function(){b&&b.isEditable?this.actionList=[n.DirectionsTo,n.DirectionsFrom,n.AddToRoute,n.moveToAnotherDay,n.OpenNewCard]:t.prototype.updateActionList.call(this)},i.prototype.updateActionListWithEdits=function(t,i){this.updateActionList();b&&b.isEditable&&(this.actionList.push(n.editName),this.actionList.push(n.editDescription),t&&this.actionList.push(n.deleteName),i&&this.actionList.push(n.deleteDescription))},i.prototype.populatePrimitive=function(n){var o,s,r,t;this._primitive&&this._cleanup();this.travelEntity=n.primitive.entity;var u=n.primitive.geometry,f=new at(u.y,u.x),e=this.travelEntity.getTitle(),i="";this.travelEntity.originalName&&(i=this.travelEntity.originalName);o=this.travelEntity.getDescription();s=this.travelEntity.getAddress();this.travelEntity.imageUrl&&(r=this.travelEntity.imageUrl);t=new fi(i||e,o,n.primitive.taskDisplayState,null,null,s,n.primitive.entity.getSelectedCategoryForIcon&&n.primitive.entity.getSelectedCategoryForIcon());i&&t.setNickname(e);r&&t.setImageUrl(r);t.collisionBehavior=2;t.id=this.travelEntity.id;this._primitive=new hi(f,t,this._getVectorImage());this.updateMapQuadrant(this._map,f,n);this._primitive.bucket=this._mapQuadrant===c.TopLeft||this._mapQuadrant===c.TopRight?it.bucketIdForTransientLensTop:it.bucketIdForTransientLensBottom;this._buildMode&&(this._primitive.taskDisplayState=n.primitive.taskDisplayState)},i.prototype._updateEntityData=function(){if(this.editable){var n=r("#transientLens");this._buttonGroupViewModel.setEntityData(this.travelEntity,this._options);this._buttonGroupViewModel.setAddToRouteMode(n.select(".directionsAddToRoute"),!0)}else t.prototype._updateEntityData.call(this)},i.prototype.processTravelData=function(n){var i;if(this.editable){this._travelProcessed=!0;var r=n.inData.requestState&&n.inData.requestState.action,u=n.inData.requestorId,f=n.outData.length&&n.outData[0].days;r===2?(i=k.getItineraryDayOptions(this.travelEntity,u,f),this._buttonGroupViewModel.processTravelMoveToData(n,i)):this.updateTransientLens(n.inData)}else t.prototype.processTravelData.call(this,n)},i.prototype.buildEditActions=function(t){var r=this,i,u,f,e;if(this.actionList.indexOf(t)===-1)return null;i="";u=!1;switch(t){case n.editName:i=this.actionList.indexOf(n.deleteName)===-1?p.L_AddNickNameOption:p.L_EditNickNameOption;break;case n.editDescription:i=this.actionList.indexOf(n.deleteDescription)===-1?p.L_AddNoteOption:p.L_EditNoteOption;break;case n.deleteName:i=p.L_DeleteNickNameOption;break;case n.deleteDescription:i=p.L_DeleteNoteOption}return f=function(n){window.clearTimeout(vt._mouseoverDelayHandle);r.editEvent.invoke(t);n.stopPropagation();n.preventDefault();r.hide()},e={text:i,cssClass:"edit",handler:f,mouseoverHandler:null,showSeparator:u,showSecText:!1,secText:null},e},i.prototype.openNewCardButtonClicked=function(n){var t,i,r;n&&n.preventDefault();t=this._primitive.entity;i={entryPoint:y.ContextMenu,listingTaskId:this._options.requestorId,id:t.id,openingNewCard:!0,taskTitle:t.getNickname()||t.getTitle(),selectedCategoryId:this._primitive.entity.categoryId};t.getNickname()&&(i.originalName=t.getTitle());!i.id&&this._primitive.geometry&&(i.query=this._primitive.geometry.y.toFixed(6)+", "+this._primitive.geometry.x.toFixed(6));r=this._primitive.taskDisplayState&&this._primitive.taskDisplayState.colorIndex;this.hide();f.invokeHandler(u.taskDataHandlerKey,{type:l.localDetailsTask,state:i,activateOptions:{taskColorIndex:r,groupName:this._options.requestorId}})},i}(vi),de=function(){function n(n,t,i){var r=this;this._events=[];this._map=n;this._templateSelector=t;this.invalidated=new w;this._events.push(this._map.contextMenuInvoked.add(function(n){return r._onContextMenuInvoked(n)}));this._transientLensViewModel=i;this._transientLensViewModel.setOptions({requestorType:"TransientLens"});this._events.push(this._transientLensViewModel.invalidateLayer.add(function(){r._layer&&r._layer.setVisible(!!r._transientLensViewModel.getPrimitive());r.invalidated.invoke()}))}return n.prototype.getPrimitives=function(n,t){var i=this._transientLensViewModel.getPrimitive();i?(i.layer=this._layer,t&&t({primitives:[i]})):t&&t({primitives:[]})},n.prototype.getViewModel=function(){return this._transientLensViewModel},n.prototype.dispose=function(){this._layer&&(this._map.getLayers().remove(this._layer),this._layer.dispose(),this._layer=null);this._map=null;this._templateSelector=null;for(var n=this._events.length-1;n>=0;n--)this._events[n].dispose();this._events=[];this._transientLensViewModel.dispose()},n.prototype.processCallback=function(n){n&&n.inData&&n.processorType&&n.outData&&(n.processorType===l.directionsTask&&n.inData.requestorState?this._transientLensViewModel.processDirectionsData(n):n.processorType===l.collectionsTask&&n.inData.requestorState?this._transientLensViewModel.processCollectionsData(n):n.processorType===l.itineraryDetailsTask&&n.inData.requestorState&&this._transientLensViewModel.processTravelData(n))},n.prototype.hide=function(){this._transientLensViewModel.hide()},n.prototype._onContextMenuInvoked=function(n){this._map.getMode().mapModeType===0&&(a._isSmallMapShownOnSerp()||(this._layer||(this._layer=new eu("TransientLens",this,this._templateSelector,1e4),this._layer.setRenderTarget(1),this._map.getLayers().insert(this._layer)),this._transientLensViewModel.hide(),n.primitive&&n.exclusiveHitTest)||(!n.location||n.primitive&&(n.layer||n.layer.hasCustomContextMenu)?n.layer.getId&&n.layer.getId()==="TransientLens"&&this._transientLensViewModel.show(n):this._transientLensViewModel.show(n)))},n}();o.AdsScenario=ii;t.CategoriesBar=wf;t.CategoriesBarItemData=bf;t.CalendarSyncTemplate=tr;t.CalendarSync=wr;t.CalendarSyncViewModel=bi;t.FiltersBarModuleViewModel=ue;t.FiltersBarViewModel=er;t.FiltersStatusBarViewModel=or;t.FiltersBar=re;t.FiltersBarItem=ie;t.FiltersBarItemData=te;t.SignInState=ai;t.CollectionsTaskResponseProcessor=vr;t.ButtonGroupViewModel=pe;t.TabControlRequester=gf;t.TransientLensViewModel=vt;t.PoiTransientLensViewModel=vi;t.DetailsPoiTransientLensViewModel=be;t.CollectionsPoiTransientLensViewModel=we;t.ItineraryPoiTransientLensViewModel=ke;t.TransientLens=de;t.MapsInfobox=ee;t.PoiOverlayEntity=fi;o.TransientLensActions=n;t.CommonControls=t.CommonControls||{};t.CommonControls.SyndicatedAds=rf;t.CommonControls.ServerSideAds=rr;t.CommonControls.TnAAds=uf;t.CommonControls.AutosuggestViewModel=ef;t.CommonControls.AutosuggestV2=ur;t.CommonControls.MobileAutosuggestV2=sf;t.CommonControls.ListDropdownViewModel=st;t.CommonControls.SuggestionViewModelV2=li;t.CommonControls.CollectionsListDropdownViewModel=di;t.CommonControls.DirectionsAutosuggestDataModel=ui;t.CommonControls.DirectionsListDropdownViewModel=hr;t.CommonControls.SelectionListDropdownViewModel=cr;t.CommonControls.ItineraryDaysDropdownViewModel=lr;t.CommonControls.ModalDialogViewModel=ne;t.CommonControls.PopOutButtonViewModel=gi;t.CommonControls.PopOutMessageViewModel=sr;t.CommonControls.AutosuggestDataModel=ri;t.CommonControls.SearchBoxAutosuggestDataModel=hf;t.CommonControls.CollectionsAutosuggestDataModel=of;t.CommonControls.CollectionPopOutMessageViewModel=ki;t.CommonControls.SearchHistoryLocalStorageHelper=fr;t.CommonControls.TaskBarDropdownViewModel=ve;t.CommonControls.DropdownItem=oe}catch(yr){if(t.logger)t.logger.logCriticalError(yr);else throw yr;}}).call(window)